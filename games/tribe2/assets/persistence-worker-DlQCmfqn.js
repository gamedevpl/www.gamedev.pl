(function(){"use strict";var t=(s=>(s.SAVE_REQUEST="SAVE_REQUEST",s.SAVE_RESPONSE="SAVE_RESPONSE",s.LOAD_REQUEST="LOAD_REQUEST",s.LOAD_RESPONSE="LOAD_RESPONSE",s.CLEAR_REQUEST="CLEAR_REQUEST",s.CLEAR_RESPONSE="CLEAR_RESPONSE",s))(t||{});const m="tribe-game-db",c="save-files",E="tribe-game-save",S=1;function d(){return new Promise((s,e)=>{const o=indexedDB.open(m,1);o.onupgradeneeded=r=>{const n=r.target.result;n.objectStoreNames.contains(c)||n.createObjectStore(c)},o.onsuccess=()=>s(o.result),o.onerror=()=>e(o.error)})}async function p(s,e){const o=await d();return new Promise((r,n)=>{const u=o.transaction(c,"readwrite").objectStore(c).put(e,s);u.onsuccess=()=>r(),u.onerror=()=>n(u.error)})}async function g(s){const e=await d();return new Promise((o,r)=>{const a=e.transaction(c,"readonly").objectStore(c).get(s);a.onsuccess=()=>o(a.result),a.onerror=()=>r(a.error)})}async function l(s){const e=await d();return new Promise((o,r)=>{const a=e.transaction(c,"readwrite").objectStore(c).delete(s);a.onsuccess=()=>o(),a.onerror=()=>r(a.error)})}async function R(s){const o=new Blob([s]).stream().pipeThrough(new CompressionStream("gzip"));return await new Response(o).blob()}async function f(s){const e=s.stream().pipeThrough(new DecompressionStream("gzip"));return await new Response(e).text()}async function w(s){try{const e={version:S,savedAt:Date.now(),gameState:s.gameState},o=JSON.stringify(e),r=await R(o);await p(E,r);const n=(r.size/1024).toFixed(2);console.log(`[Worker] Game saved successfully. Size: ${n} KB`);const i={type:t.SAVE_RESPONSE,id:s.id,success:!0,size:r.size};self.postMessage(i)}catch(e){console.error("[Worker] Failed to save game:",e);const o={type:t.SAVE_RESPONSE,id:s.id,success:!1,error:e instanceof Error?e.message:"Unknown error"};self.postMessage(o)}}async function A(s){try{const e=await g(E);if(!e){console.log("[Worker] No saved game found.");const i={type:t.LOAD_RESPONSE,id:s.id,success:!0,gameState:void 0};self.postMessage(i);return}const o=await f(e),r=JSON.parse(o);if(r.version!==S){console.warn(`[Worker] Save game version mismatch. Expected ${S}, found ${r.version}. Discarding save.`),await l(E);const i={type:t.LOAD_RESPONSE,id:s.id,success:!0,gameState:void 0};self.postMessage(i);return}console.log("[Worker] Game loaded successfully.");const n={type:t.LOAD_RESPONSE,id:s.id,success:!0,gameState:r.gameState};self.postMessage(n)}catch(e){console.error("[Worker] Failed to load game:",e);try{await l(E)}catch(r){console.error("[Worker] Failed to clear corrupted save:",r)}const o={type:t.LOAD_RESPONSE,id:s.id,success:!1,error:e instanceof Error?e.message:"Unknown error"};self.postMessage(o)}}async function _(s){try{await l(E),console.log("[Worker] Saved game cleared.");const e={type:t.CLEAR_RESPONSE,id:s.id,success:!0};self.postMessage(e)}catch(e){console.error("[Worker] Failed to clear saved game:",e);const o={type:t.CLEAR_RESPONSE,id:s.id,success:!1,error:e instanceof Error?e.message:"Unknown error"};self.postMessage(o)}}self.addEventListener("message",s=>{const e=s.data;try{switch(e.type){case t.SAVE_REQUEST:w(e);break;case t.LOAD_REQUEST:A(e);break;case t.CLEAR_REQUEST:_(e);break;default:console.error("[Worker] Unknown message type:",e);break}}catch(o){console.error("[Worker] Error handling message:",o)}}),console.log("[Worker] Persistence worker initialized.")})();
