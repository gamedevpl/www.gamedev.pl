var He=Object.defineProperty;var Ye=(e,t,s)=>t in e?He(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var m=(e,t,s)=>Ye(e,typeof t!="symbol"?t+"":t,s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function s(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(n){if(n.ep)return;n.ep=!0;const i=s(n);fetch(n.href,i)}})();function P(e){return document.createElement(e)}function Se(e,t,s){e.addEventListener(t,s)}function ye(e,t){window.addEventListener(e,t)}function Ie(e,t){window.removeEventListener(e,t)}function ie(e,t){e.textContent=t}function Y(e,t){const s=P("button");return ie(s,e),Se(s,"click",t),s}function Xe(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function Q(e,t){t.forEach(s=>e.appendChild(s))}function A(e){const t=P("div");return e&&(t.className=e),t}var c=(e=>(e[e.CapOfInvisibility=0]="CapOfInvisibility",e[e.ConfusedMonsters=1]="ConfusedMonsters",e[e.LandMine=2]="LandMine",e[e.TimeBomb=3]="TimeBomb",e[e.Crusher=4]="Crusher",e[e.Builder=5]="Builder",e[e.Climber=6]="Climber",e[e.Teleport=7]="Teleport",e[e.Tsunami=8]="Tsunami",e[e.Monster=9]="Monster",e[e.Slide=10]="Slide",e[e.Sokoban=11]="Sokoban",e[e.Blaster=12]="Blaster",e))(c||{}),f=(e=>(e[e.Up=0]="Up",e[e.Down=1]="Down",e[e.Left=2]="Left",e[e.Right=3]="Right",e))(f||{});function Ce(e){switch(e){case 0:return"Now you see me, now you don't!";case 1:return"Monsters are dizzy!";case 2:return"Boom goes the floor!";case 3:return"Tick tock, boom o'clock!";case 4:return"Hulk smash!";case 5:return"Bob the Builder mode: ON";case 6:return"Walk on walls like a pro!";case 7:return"Beam me up, Scotty!";case 8:return"Water, water everywhere!";case 9:return"Tables have turned!";case 10:return"Slip and slide!";case 11:return"Push it real good!";case 12:return"Pew pew pew!";default:return"Mystery power activated!"}}function E(e,t){return e.activeBonuses.some(s=>s.type===t)}const g=60,b=30;function C(e,t){return{x:(e-t)*g/2,y:(e+t)*b/2}}function Te(e){switch(e){case"wave":case"obstacle":return 3;case"bonus":case"landMine":case"timeBomb":return 2;case"goal":return 2;case"monster":return 4;case"player":return 5;case"explosion":return 6;default:return 0}}function Ke(e){return e.sort((t,s)=>{const o=t.position.x+t.position.y,n=s.position.x+s.position.y;if(o!==n)return o-n;const i=Te(t.type),a=Te(s.type);return i!==a?i-a:0})}const ke=250,J=500,je=50,Qe=()=>Math.cos(Date.now()/1e3*Math.PI),Ze=e=>.5+(e/2+1)/2,ce=(e,t,s,o=ke)=>{const n=Math.min(Date.now()-s,o)/o;return{x:t.x+(e.x-t.x)*n,y:t.y+(e.y-t.y)*n}},Je=(e,t,s)=>Date.now()-s<J/2?t:e,xe=e=>{const t=Date.now()/1e3;return Math.sin(t*2+e)*3},Le=e=>{const t=Date.now()/50;return{x:Math.sin(t)*e,y:Math.cos(t*1.5)*e}},De=500,ze=(e,t,s)=>{const o=Math.min((Date.now()-e)/De,1);return s?1-o:t?o:1},et=()=>Le(2),tt=e=>{const s=e%1e3/1e3;return Math.sin(s*Math.PI)*20},st=e=>Math.max(0,1-e/2e3),ot=e=>e<J/2?Math.max(0,1-e/2/(J/2)*2):Math.min(1,(e/2/(J/2)-.5)*2),nt=(e,t,s)=>{const{x:o,y:n}=C(t.x,t.y);e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.ellipse(o,n+b/2,g/2,b/4,0,0,Math.PI*2),e.fill(),e.fillStyle="#FFD700",e.beginPath(),e.moveTo(o,n),e.lineTo(o+g/2,n+b/2),e.lineTo(o,n+b),e.lineTo(o-g/2,n+b/2),e.closePath(),e.fill(),e.fillStyle="#000000",e.font=`${s/2}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText("★",o,n+b/2)},it=(e,t,s)=>{t.forEach(o=>{const{position:n,creationTime:i,isRaising:a,isDestroying:l}=o,{x:r,y:p}=C(n.x,n.y),h=ze(i,a,l)*s*.8;if(h===0)return;const u=h/s*.2,{x:y,y:v}=C(n.x,n.y+1),{x:w,y:T}=C(n.x+1,n.y+1),{x:S,y:L}=C(n.x+1,n.y+1+u),{x:G,y:_}=C(n.x,n.y+1+u);e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.moveTo(y,v),e.lineTo(w,T),e.lineTo(S,L),e.lineTo(G,_),e.closePath(),e.fill();const $=l?h/(s*.8):1;e.fillStyle=`rgba(142, 36, 170, ${$})`,e.beginPath(),e.moveTo(r,p-h),e.lineTo(r+g/2,p+b/2-h),e.lineTo(r,p+b-h),e.lineTo(r-g/2,p+b/2-h),e.closePath(),e.fill(),e.fillStyle=`rgba(106, 27, 154, ${$})`,e.beginPath(),e.moveTo(r+g/2,p+b/2-h),e.lineTo(r+g/2,p+b/2),e.lineTo(r,p+b),e.lineTo(r,p+b-h),e.closePath(),e.fill(),e.fillStyle=`rgba(74, 20, 140, ${$})`,e.beginPath(),e.moveTo(r-g/2,p+b/2-h),e.lineTo(r-g/2,p+b/2),e.lineTo(r,p+b),e.lineTo(r,p+b-h),e.closePath(),e.fill()})},at=(e,t)=>{const s=C(0,0),o=C(t,0),n=C(0,t),i=C(t,t);e.fillStyle="#c2b280",e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(o.x,o.y),e.lineTo(i.x,i.y),e.lineTo(n.x,n.y),e.closePath(),e.fill(),e.fillStyle="#5d4037",e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(i.x,i.y+ne),e.lineTo(n.x,n.y+ne),e.lineTo(n.x,n.y),e.closePath(),e.fill(),e.fillStyle="#8d6e63",e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(i.x,i.y+ne),e.lineTo(o.x,o.y+ne),e.lineTo(o.x,o.y),e.closePath(),e.fill()},Ee=(e,t,s)=>{e.strokeStyle="#4a4a4a",e.lineWidth=1;for(let o=0;o<=t;o++)for(let n=0;n<=t;n++){const{x:i,y:a}=C(n,o);n<t&&(e.beginPath(),e.moveTo(i,a),e.lineTo(i+g/2,a+b/2),e.stroke()),o<t&&(e.beginPath(),e.moveTo(i,a),e.lineTo(i-g/2,a+b/2),e.stroke()),E(s,c.Slide)&&rt(e,n,o)}},rt=(e,t,s)=>{const{x:o,y:n}=C(t,s),i=e.createLinearGradient(o-g/2,n,o+g/2,n+b);i.addColorStop(0,"rgba(200, 200, 255, 0.2)"),i.addColorStop(.5,"rgba(220, 220, 255, 0.3)"),i.addColorStop(1,"rgba(200, 200, 255, 0.2)"),e.fillStyle=i,e.beginPath(),e.moveTo(o,n),e.lineTo(o+g/2,n+b/2),e.lineTo(o,n+b),e.lineTo(o-g/2,n+b/2),e.closePath(),e.fill();for(let a=0;a<3;a++){const l=o+(Math.random()-.5)*g,r=n+(Math.random()-.5)*b,p=Math.random()*2+1;e.fillStyle="rgba(255, 255, 255, 0.7)",e.beginPath(),e.arc(l,r,p,0,Math.PI*2),e.fill()}},fe=(e,t,s,o,n)=>{e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.ellipse(t+o/2,s+n/2+5,o/2,n/4,0,0,Math.PI*2),e.fill()},lt=e=>{const{isoX:t,isoY:s,cellSize:o,baseHeight:n,widthFactor:i,heightAnimationFactor:a}=e,l=Qe(),r=n*o+o*a*l,p=g*i,h=Ze(l),u=g*i*h,y=b*.4*h;return{entityHeight:r,entityWidth:p,shadowWidth:u,shadowHeight:y,animFactor:l,shadowX:t-u/2,shadowY:s+b/2}},ht=(e,t,s,o,n,i,a)=>{e.fillStyle=i,e.beginPath(),e.moveTo(t,s-o-a),e.lineTo(t+n/2,s-o+b/4-a),e.lineTo(t,s+b/2-a),e.lineTo(t-n/2,s-o+b/4-a),e.closePath(),e.fill()},ct=(e,t,s,o,n,i,a)=>{e.fillStyle=i,e.beginPath(),e.arc(t,s-o-n/2-a,n,0,Math.PI*2),e.fill()},ut=(e,t,s,o,n,i,a,l)=>{const r=n*.3;e.fillStyle=i,e.beginPath(),e.arc(t-n/3,s-o-n/2-l,r,0,Math.PI*2),e.arc(t+n/3,s-o-n/2-l,r,0,Math.PI*2),e.fill(),e.fillStyle=a,e.beginPath(),e.arc(t-n/3,s-o-n/2-l,r/2,0,Math.PI*2),e.arc(t+n/3,s-o-n/2-l,r/2,0,Math.PI*2),e.fill()},pt=(e,t,s,o,n,i)=>{e.strokeStyle="black",e.lineWidth=2,e.beginPath(),e.arc(t,s-o+n/4-i,n/2,.1*Math.PI,.9*Math.PI),e.stroke()},dt=(e,t,s,o,n,i,a,l,r,p,h,u,y,v)=>{e.strokeStyle=p,e.lineWidth=r;const w=Math.sin(u*1e3)*Math.PI;for(let T=0;T<a;T++){const S=T/a*Math.PI*2,L=t+Math.cos(S)*(n/3),G=s-o/2+Math.sin(S)*(o/4)-v,_=2+Math.sin(u*100+T)*2,$=.1+Math.cos(u*200+T)*.05,q=L+Math.cos(S)*(l/2),H=G+Math.sin(S)*(l/2)+Math.sin(h*_+w+T)*i*$,x=L+Math.cos(S)*l,z=G+Math.sin(S)*l+Math.sin(h*_+Math.PI+w+T)*i*($*1.5),se=L+Math.cos(S)*l,oe=G+Math.sin(S)*l+Math.sin(h*_+w+T)*i*($*2);y&&(e.save(),e.strokeStyle="rgba(0, 0, 0, 0.3)",e.lineWidth=r*1.5,e.beginPath(),e.moveTo(L,G+b/2),e.bezierCurveTo(q,H+b/2,x,z+b/2,se,oe+b/2),e.stroke(),e.restore()),e.beginPath(),e.moveTo(L,G),e.bezierCurveTo(q,H,x,z,se,oe),e.stroke()}},Ae=e=>{const{ctx:t,isoX:s,isoY:o,cellSize:n,baseHeight:i,widthFactor:a,heightAnimationFactor:l,bodyColor:r,headColor:p,eyeColor:h,pupilColor:u,hasTentacles:y=!1,tentacleColor:v="",tentacleCount:w=0,tentacleLength:T=0,tentacleWidth:S=0,isInvisible:L=!1,seed:G=0,castShadow:_=!0,isConfused:$=!1}=e,q=lt({isoX:s,isoY:o,cellSize:n,baseHeight:i,widthFactor:a,heightAnimationFactor:l}),{entityHeight:H,entityWidth:x,shadowWidth:z,shadowHeight:se,animFactor:oe,shadowX:_e,shadowY:qe}=q,X=xe(G),we=$?et():{x:0,y:0};let K=s,j=o;K+=we.x,j+=we.y,_&&(t.fillStyle="rgba(0, 0, 0, 0.3)",t.beginPath(),t.ellipse(_e+z/2,qe,z/2,se/2,0,0,Math.PI*2),t.fill()),t.save(),L&&(t.globalAlpha=.5),y&&v&&w>0&&dt(t,K,j,H,x,n,w,T,S,v,oe,G,_,X),ht(t,K,j,H,x,r,X);const ue=n*.25;return ct(t,K,j,H,ue,p,X),ut(t,K,j,H,ue,h,u,X),pt(t,K,j,H,ue,X),t.restore(),{bounceOffset:X}},mt=(e,t,s,o=!1,n=[],i=!1,a=!1,l=!1)=>{const{position:r,previousPosition:p,moveTimestamp:h,teleportTimestamp:u,isVanishing:y,isVictorious:v}=t,w=u&&Date.now()-u<J,T=w?Je(r,p,u):ce(r,p,h);let{x:S,y:L}=C(T.x,T.y);if(v){const q=tt(Date.now()-h);L-=q}const G=n.some(q=>q.position.x===Math.round(T.x)&&q.position.y===Math.round(T.y));(l||G)&&G&&(L-=s*.5);const _={ctx:e,isoX:S,isoY:L,cellSize:s,baseHeight:.8,widthFactor:.6,heightAnimationFactor:.2,bodyColor:yt(l,i),headColor:ft(l,i),eyeColor:i?"red":"white",pupilColor:"black",isInvisible:o};y?e.globalAlpha=st(Date.now()-h):w&&(e.globalAlpha=ot(Date.now()-u));const{bounceOffset:$}=Ae(_);e.globalAlpha=1,v&&bt(e,S,L,s),l&&gt(e,S,L,s),i&&vt(e,S,L,s),a&&wt(e,S,L,s,$),w&&Ct(e,S,L,s,Date.now()-u)},yt=(e,t)=>t?"#800080":e?"#FFA500":"#00FF00",ft=(e,t)=>t?"#9932CC":e?"#FFD700":"#32CD32",bt=(e,t,s,o)=>{e.save(),e.translate(t,s);for(let n=0;n<10;n++){const i=Math.PI*2*n/10,a=o*(.5+Math.sin(Date.now()/200+n)*.2),l=Math.cos(i)*a,r=Math.sin(i)*a;e.beginPath(),e.arc(l,r,o*.1,0,Math.PI*2),e.fillStyle=`hsl(${(Date.now()/20+n*36)%360}, 100%, 50%)`,e.fill()}e.restore()},gt=(e,t,s,o)=>{e.save(),e.translate(t,s-o*.6);const n=o*.3;e.strokeStyle="#FFD700",e.lineWidth=2,e.beginPath(),e.moveTo(-n/2,-n/2),e.lineTo(-n/2,n/2),e.moveTo(n/2,-n/2),e.lineTo(n/2,n/2);for(let a=0;a<3;a++){const l=-n/2+(a+1)*(n/3);e.moveTo(-n/2,l),e.lineTo(n/2,l)}e.stroke(),e.shadowColor="#FFD700",e.shadowBlur=5,e.stroke();const i=Math.sin(Date.now()/200)*o*.05;e.translate(0,i),e.stroke(),e.restore()},vt=(e,t,s,o)=>{e.save(),e.translate(t,s);const n=20,i=o*.8;for(let r=0;r<n;r++){const p=Math.PI*2*r/n+Date.now()/1e3,h=i*(.5+Math.sin(Date.now()/500+r)*.2),u=Math.cos(p)*h,y=Math.sin(p)*h;e.beginPath(),e.arc(u,y,o*.05,0,Math.PI*2),e.fillStyle=`rgba(128, 0, 128, ${.5+Math.sin(Date.now()/200+r)*.3})`,e.fill()}const a=o*.1,l=o*.15;e.beginPath(),e.arc(-l,-l,a,0,Math.PI*2),e.arc(l,-l,a,0,Math.PI*2),e.fillStyle="rgba(255, 0, 0, 0.8)",e.fill(),e.shadowColor="red",e.shadowBlur=10+Math.sin(Date.now()/200)*5,e.fill(),e.restore()},wt=(e,t,s,o,n)=>{e.save(),e.translate(t-o/10,s-n);const i=o*.4,a=o*.1;e.fillStyle="#808080",e.beginPath(),e.rect(-a/2,-i,a,i),e.fill(),e.fillStyle="#FFD700",e.beginPath(),e.arc(0,-i,a/2,0,Math.PI*2),e.fill(),e.shadowColor="#FFD700",e.shadowBlur=5,e.fill();const l=(Math.sin(Date.now()/200)+1)*a/4;e.beginPath(),e.arc(0,-i,l,0,Math.PI*2),e.fillStyle="rgba(255, 255, 0, 0.8)",e.fill(),e.restore()},Ct=(e,t,s,o,n)=>{e.save(),e.translate(t,s);const i=o*1.5,a=n/J;if(a<.5){const l=a*2,r=i*l;e.beginPath(),e.arc(0,0,r,0,Math.PI*2);const p=e.createRadialGradient(0,0,0,0,0,r);p.addColorStop(0,"rgba(0, 255, 255, 0)"),p.addColorStop(.7,"rgba(0, 255, 255, 0.7)"),p.addColorStop(1,"rgba(0, 255, 255, 0)"),e.fillStyle=p,e.fill();for(let h=0;h<20;h++){const u=Math.random()*Math.PI*2,y=Math.random()*r,v=Math.cos(u)*y,w=Math.sin(u)*y,T=o*.05*(1-l);e.beginPath(),e.arc(v,w,T,0,Math.PI*2),e.fillStyle="rgba(0, 255, 255, "+(1-l)+")",e.fill()}}else{const l=(a-.5)*2,r=i*(1-l);e.beginPath(),e.arc(0,0,r,0,Math.PI*2);const p=e.createRadialGradient(0,0,0,0,0,r);p.addColorStop(0,"rgba(0, 255, 255, 0.7)"),p.addColorStop(.7,"rgba(0, 255, 255, 0.3)"),p.addColorStop(1,"rgba(0, 255, 255, 0)"),e.fillStyle=p,e.fill();for(let h=0;h<20;h++){const u=Math.random()*Math.PI*2,y=Math.random()*i,v=Math.cos(u)*y,w=Math.sin(u)*y,T=o*.05*l;e.beginPath(),e.arc(v,w,T,0,Math.PI*2),e.fillStyle="rgba(0, 255, 255, "+l+")",e.fill()}}e.restore()},Tt=(e,t,s,o)=>{t.forEach(n=>{const i=ce(n.position,n.previousPosition,n.moveTimestamp),{x:a,y:l}=C(i.x,i.y),r={ctx:e,isoX:a,isoY:l,cellSize:s,baseHeight:.4,widthFactor:.6,heightAnimationFactor:.1,bodyColor:o?"#00FF00":"#800080",headColor:o?"#32CD32":"#9932CC",eyeColor:"white",pupilColor:o?"black":"red",hasTentacles:!o,tentacleColor:"#600060",tentacleCount:6,tentacleLength:s*.5,tentacleWidth:4,seed:n.seed,castShadow:!0};Ae(r),o&&Mt(e,a,l,s)})},Mt=(e,t,s,o)=>{e.save(),e.translate(t,s);const n=o*.2;e.fillStyle="#FFD700",e.beginPath(),e.moveTo(-n/2,-o*.3),e.lineTo(0,-o*.5),e.lineTo(n/2,-o*.3),e.closePath(),e.fill();for(let i=0;i<5;i++){const a=Math.random()*Math.PI*2,l=Math.random()*o*.4+o*.2,r=Math.cos(a)*l,p=Math.sin(a)*l;e.fillStyle=`rgba(255, 255, 0, ${.5+Math.random()*.5})`,e.beginPath(),e.arc(r,p,o*.05,0,Math.PI*2),e.fill()}e.restore()},O=b,Pt=(e,t,s)=>{t.forEach(o=>{const{x:n,y:i}=C(o.position.x,o.position.y);fe(e,n-g/4,i-b/4,g/2,b),e.fillStyle=kt(o.type),e.beginPath(),e.moveTo(n,i+O/2),e.lineTo(n+g/4,i),e.lineTo(n,i-O/2),e.lineTo(n-g/4,i),e.closePath(),e.fill(),e.beginPath(),e.arc(n,i-O/2,g/6,0,Math.PI*2),e.fill(),e.fillStyle="white",e.font=`bold ${s/3}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText(Lt(o.type),n,i-O/2)})},St=(e,t,s)=>{t.forEach(o=>{const{x:n,y:i}=C(o.x,o.y);fe(e,n-g/2,i,g,b),e.fillStyle="brown",e.beginPath(),e.moveTo(n,i+O/2),e.lineTo(n+g/4,i),e.lineTo(n,i-O/2),e.lineTo(n-g/4,i),e.closePath(),e.fill(),e.beginPath(),e.arc(n,i-O/2,g/5,0,Math.PI*2),e.fill(),e.fillStyle="white",e.font=`bold ${s/3}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText("M",n,i-O/2)})},It=(e,t,s)=>{t.forEach(o=>{const{x:n,y:i}=C(o.position.x,o.position.y);fe(e,n-g/2,i,g,b),e.fillStyle="black",e.beginPath(),e.moveTo(n,i-O),e.lineTo(n+g/4,i-O/2),e.lineTo(n,i+O/2),e.lineTo(n-g/4,i-O/2),e.closePath(),e.fill(),e.strokeStyle="orange",e.lineWidth=2,e.beginPath(),e.moveTo(n,i-O),e.quadraticCurveTo(n+g/8,i-O*1.5,n+g/4,i-O*1.25),e.stroke(),e.fillStyle="white",e.font=`bold ${s/3}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText(o.timer.toString(),n,i-O/2)})},kt=e=>{switch(e){case c.CapOfInvisibility:return"#8A2BE2";case c.ConfusedMonsters:return"#FFA500";case c.LandMine:return"#8B4513";case c.TimeBomb:return"#000000";case c.Crusher:return"#FF69B4";case c.Builder:return"#00FFFF";case c.Climber:return"#32CD32";case c.Teleport:return"#9400D3";case c.Tsunami:return"#1E90FF";case c.Monster:return"#FF4500";case c.Slide:return"#00CED1";case c.Sokoban:return"#DAA520";case c.Blaster:return"#FF1493";default:return"#FFFF00"}},Lt=e=>{switch(e){case c.CapOfInvisibility:return"I";case c.ConfusedMonsters:return"C";case c.LandMine:return"L";case c.TimeBomb:return"T";case c.Crusher:return"X";case c.Builder:return"B";case c.Climber:return"↑";case c.Teleport:return"⊷";case c.Tsunami:return"≋";case c.Monster:return"M";case c.Slide:return"⇉";case c.Sokoban:return"◊";case c.Blaster:return"⚡";default:return"?"}},Dt=(e,t)=>{e.save(),e.globalAlpha=.7;for(const{position:s,startTime:o,duration:n}of t){if(Date.now()-o>n)continue;const i=C(s.x+.5,s.y+.5),a=C(s.x-1,s.y-1),l=C(s.x+1*2,s.y-1),r=C(s.x+1*2,s.y+1*2),p=C(s.x-1,s.y+1*2);e.fillStyle="#FF6600",e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(l.x,l.y),e.lineTo(r.x,r.y),e.lineTo(p.x,p.y),e.closePath(),e.fill();const h=32,u=g;for(let v=0;v<h;v++){const w=Math.PI*2/h*v,T=u*Math.random(),S=i.x+Math.cos(w)*T,L=i.y+Math.sin(w)*T/2;e.fillStyle=v%2===0?"#FF9933":"#FF3300",e.beginPath(),e.arc(S,L-Math.random()*b*Math.pow(v/h,.5),g/16,0,Math.PI*2),e.fill()}const y=e.createRadialGradient(i.x,i.y,0,i.x,i.y,g*2);y.addColorStop(0,"rgba(255, 255, 0, 0.8)"),y.addColorStop(1,"rgba(255, 165, 0, 0)"),e.fillStyle=y,e.beginPath(),e.ellipse(i.x,i.y,g,b,0,0,Math.PI*2),e.fill()}e.restore()},Et=(e,t,s,o)=>{e.save(),e.globalAlpha=s.duration===12?1:.5,e.font="bold 16px Arial";const{x:n,y:i}=C(t.x,t.y),a=e.measureText(Ce(s.type)).width+20,l=90,r=15,p=10,h=n-a/2,u=i-o-l-r;e.fillStyle="rgba(0, 0, 0, 0.9)",e.beginPath(),e.moveTo(h+p,u),e.lineTo(h+a-p,u),e.quadraticCurveTo(h+a,u,h+a,u+p),e.lineTo(h+a,u+l-p),e.quadraticCurveTo(h+a,u+l,h+a-p,u+l),e.lineTo(h+a/2+r,u+l),e.lineTo(h+a/2,u+l+r),e.lineTo(h+a/2-r,u+l),e.lineTo(h+p,u+l),e.quadraticCurveTo(h,u+l,h,u+l-p),e.lineTo(h,u+p),e.quadraticCurveTo(h,u,h+p,u),e.closePath(),e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=2,e.stroke(),e.fillStyle="white",e.textAlign="center",e.fillText(Ce(s.type),h+a/2,u+30),e.font="14px Arial",e.fillText(`${s.duration} steps left`,h+a/2,u+55),e.restore()},Be=1e3,At=(e,t,s)=>{let{tsunamiLevel:o}=e;e.tsunamiTeardownTimestamp&&(o=e.player.isVanishing?13:(1-(Date.now()-e.tsunamiTeardownTimestamp)/Be)*13);const n=s*.8,i=[];for(let a=0;a<t;a++)for(let l=0;l<t;l++){const r=C(l,a),p=C(l+1,a),h=C(l,a+1),u=C(l+1,a+1),y=Math.min(Math.max(o/13,0),1)*n,v=y+Math.sin(Date.now()/200+l*.5)*5,w=y+Math.sin(Date.now()/200+(l+1)*.5)*5;i.push({tsunamiLevel:o,grid:{x:l,y:a},isoTop:[{x:r.x,y:r.y-v},{x:h.x,y:h.y-w},{x:u.x,y:u.y-w},{x:p.x,y:p.y-v}],isoFront:a===t-1?[{x:h.x,y:h.y-w},{x:h.x,y:h.y},{x:u.x,y:u.y},{x:u.x,y:u.y-w}]:void 0,isoSide:l===t-1?[{x:u.x,y:u.y-w},{x:u.x,y:u.y},{x:p.x,y:p.y},{x:p.x,y:p.y-v}]:void 0})}return i},Bt=(e,t)=>{e.save(),e.globalAlpha=.6,pe(e,t.isoTop,`rgba(0, 100, 255, ${t.tsunamiLevel/13})`),t.isoFront&&pe(e,t.isoFront,`rgba(0, 39, 98, ${t.tsunamiLevel/13})`),t.isoSide&&pe(e,t.isoSide,`rgba(0, 63, 157, ${t.tsunamiLevel/13})`),e.restore()};function pe(e,t,s){e.fillStyle=s,e.beginPath(),e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.closePath(),e.fill()}const Ot=(e,t,s)=>{const{x:o,y:n}=C(t.x,t.y),{x:i,y:a}=C(s.x,s.y);e.save(),e.strokeStyle="rgba(0, 255, 255, 0.5)",e.lineWidth=3,e.setLineDash([5,5]),e.beginPath(),e.moveTo(o,n),e.lineTo(i,a),e.stroke(),e.restore()},Ft=(e,t,s)=>{if(Date.now()-t.shotTimestamp>t.duration)return;const o=ce(t.endPosition,t.startPosition,t.shotTimestamp,t.duration),{x:n,y:i}=C(o.x,o.y);e.save(),e.shadowColor="rgba(255, 0, 0, 0.8)",e.shadowBlur=s*.2,e.fillStyle="red",e.strokeStyle="rgba(255, 100, 100, 0.8)",e.lineWidth=2;const a=s*.6,l=s*.1;switch(e.translate(n,i),t.direction){case f.Up:e.rotate(-Math.PI/4);break;case f.Down:e.rotate(3*Math.PI/4);break;case f.Left:e.rotate(-3*Math.PI/4);break;case f.Right:e.rotate(Math.PI/4);break}e.beginPath(),e.ellipse(0,0,a/2,l/2,0,0,2*Math.PI),e.fill(),e.stroke(),e.globalAlpha=.5;for(let r=1;r<=3;r++)e.globalAlpha*=.5,e.beginPath(),e.ellipse(-r*a*.2,0,a/(2+r),l/(2+r),0,0,2*Math.PI),e.fill();e.restore()},Me=1e3,Gt=13,Rt=3;function Nt(e,t,{gridSize:s}){const{player:o,obstacles:n}=t,a=Date.now()-o.moveTimestamp;if(a>Me)return;const l=Vt(o.position,n,Gt);e.save(),e.strokeStyle="purple",e.lineWidth=2,l.forEach(r=>{const p=Math.min(a/Me,1),h=r.path.length,u=Math.floor(h*p);e.beginPath();for(let y=Math.max(u-Rt,0);y<u;y++){const v=r.path[y];if(v.x<0||v.y<0||v.x>=s||v.y>=s)continue;const{x:w,y:T}=C(v.x+.5,v.y+.5);y===0?e.moveTo(w,T):e.lineTo(w,T);const S=1-y/u;e.globalAlpha=S}e.stroke()}),e.restore()}function Vt(e,t,s){const o=[],n=new Set,i=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],a=[{position:e,path:[e]}];for(n.add(`${e.x},${e.y}`);a.length>0;){const{position:l,path:r}=a.shift();if(r.length>s||$t(l,t))o.push({path:r,startTime:Date.now()});else for(const p of i){const h={x:l.x+p.x,y:l.y+p.y},u=`${h.x},${h.y}`;if(!n.has(u)){n.add(u);const y=[...r,h];a.push({position:h,path:y}),y.length===s&&o.push({path:y,startTime:Date.now()})}}}return o}function $t(e,t){return t.some(s=>s.position.x===e.x&&s.position.y===e.y)}const ne=20,Oe=(e,t,{gridSize:s,cellSize:o})=>{if(e.save(),t.explosions.length>0){const r=Math.min(t.explosions.filter(h=>Date.now()-h.startTime<h.duration).length*2,10),p=Le(r);e.translate(p.x,p.y)}e.translate(e.canvas.width/2,100),e.clearRect(-e.canvas.width/2,-100,e.canvas.width,e.canvas.height),at(e,s),Ee(e,s,t);const n=t.tsunamiLevel>0||t.tsunamiTeardownTimestamp?At(t,s,o):[];Date.now()-t.tsunamiTeardownTimestamp>Be&&!t.player.isVanishing&&(t.tsunamiTeardownTimestamp=void 0),E(t,c.Slide)&&Ot(e,t.player.previousPosition,t.player.position),Nt(e,t,{gridSize:s});const i=[...n.map(r=>({position:r.grid,type:"wave",obj:r})),...t.obstacles.map(r=>({position:r.position,type:"obstacle",obj:r})),...t.bonuses.map(r=>({position:r.position,type:"bonus",obj:r})),...t.landMines.map(r=>({position:r,type:"landMine"})),...t.timeBombs.map(r=>({position:r.position,type:"timeBomb",obj:r})),...t.monsters.map(r=>({position:r.position,type:"monster",obj:r})),{position:t.player.position,type:"player",obj:t.player},{position:t.goal,type:"goal"},...t.explosions.map(r=>({position:r.position,type:"explosion",obj:r})),...t.blasterShots.map(r=>({position:ce(r.endPosition,r.startPosition,r.shotTimestamp,r.duration),type:"blasterShot",obj:r}))],a=Ke(i);for(const r of a){const{type:p,position:h}=r;switch(p){case"wave":Bt(e,r.obj);break;case"obstacle":it(e,[r.obj],o);break;case"bonus":Pt(e,[r.obj],o);break;case"landMine":St(e,[h],o);break;case"timeBomb":It(e,[r.obj],o);break;case"monster":Tt(e,[r.obj],o,E(t,c.Monster));break;case"player":mt(e,r.obj,o,t.activeBonuses.some(u=>u.type===c.CapOfInvisibility),t.obstacles,E(t,c.Monster),E(t,c.Blaster),E(t,c.Climber));break;case"goal":nt(e,h,o);break;case"explosion":Dt(e,[r.obj]);break;case"blasterShot":Ft(e,r.obj,o);break}}const l=t.activeBonuses.sort((r,p)=>p.duration-r.duration)[0];l&&Et(e,t.player.position,l,o),e.restore()},ae=300,re=200,Z=5,Wt=Math.min(ae/Z,re/Z)/2;class Ut{constructor(){m(this,"canvas");m(this,"ctx");m(this,"gameState");m(this,"animationFrameId",null);this.canvas=P("canvas"),this.canvas.width=ae,this.canvas.height=re,this.ctx=this.canvas.getContext("2d"),this.gameState=this.createPreviewGameState()}render(){return this.startAnimation(),this.canvas}startAnimation(){const t=()=>{this.ctx.clearRect(0,0,ae,re),this.ctx.save(),this.ctx.scale(.8,.8),this.ctx.translate(ae*.1,re*.1),Ee(this.ctx,Z,this.gameState),Oe(this.ctx,this.gameState,{gridSize:Z,cellSize:Wt,initialMonsterCount:0,monsterSpawnSectors:[],obstacleCount:0,initialBonusCount:0,levelName:"Preview",levelStory:"Preview",levelUpdater:()=>{}}),this.ctx.restore(),this.gameState.monsters.forEach(s=>{const o=s.position.x+(Math.random()-.5)*.1,n=s.position.y+(Math.random()-.5)*.1;s.previousPosition={...s.position},s.position={x:Math.max(0,Math.min(Z-1,o)),y:Math.max(0,Math.min(Z-1,n))},s.moveTimestamp=Date.now()}),this.animationFrameId=requestAnimationFrame(t)};t()}createPreviewGameState(){return{player:{position:{x:2,y:2},previousPosition:{x:2,y:2},moveTimestamp:Date.now(),isVictorious:!1,isVanishing:!1},goal:{x:4,y:4},obstacles:[{position:{x:1,y:1},creationTime:Date.now(),isRaising:!1,isDestroying:!1},{position:{x:3,y:3},creationTime:Date.now(),isRaising:!1,isDestroying:!1}],monsters:[{position:{x:0,y:4},previousPosition:{x:0,y:4},moveTimestamp:Date.now(),path:[],seed:Math.random(),isConfused:!1,spawnPoint:{x:0,y:4}},{position:{x:4,y:0},previousPosition:{x:4,y:0},moveTimestamp:Date.now(),path:[],seed:Math.random(),isConfused:!1,spawnPoint:{x:4,y:0}}],steps:0,monsterSpawnSteps:0,bonuses:[{type:c.CapOfInvisibility,position:{x:1,y:3}},{type:c.ConfusedMonsters,position:{x:3,y:1}}],activeBonuses:[],explosions:[],timeBombs:[],landMines:[],score:0,gameEndingState:"none",tsunamiLevel:0,blasterShots:[]}}destroy(){this.animationFrameId!==null&&cancelAnimationFrame(this.animationFrameId)}}class _t{constructor(t,s){m(this,"onStart");m(this,"onInstructions");this.onStart=t,this.onInstructions=s}render(){const t=A("intro"),s=P("h1");s.className="game-title",s.textContent="Monster Steps";const o=A("game-intro-responsive"),n=A("game-preview-container"),i=new Ut;n.appendChild(i.render());const a=A("game-intro-column"),l=A("intro-buttons"),r=Y("Start Game",this.onStart),p=Y("Instructions",this.onInstructions);Q(l,[r,p]);const h=P("p");h.className="intro-tip",h.textContent="Press right arrow to start",Q(a,[l,h]),Q(o,[n,a]);const u=P("p");return u.className="author-name",u.innerHTML='Created by <a href="https://x.com/gtanczyk">Grzegorz Tańczyk</a> | <a href="https://github.com/gamedevpl/www.gamedev.pl/tree/master/js13k2024">Source code (GitHub)</a>',Q(t,[s,o,u]),t}}class qt{constructor(t){m(this,"onBack");this.onBack=t}render(){const t=A("instructions"),s=P("h1");s.textContent="How to Play Monster Steps";const o=this.createInstructionsList(),n=this.createBonusDetails(),i=this.createTips(),a=Y("Back to Menu",this.onBack),l=P("p");return l.className="instructions-tip",l.textContent="Press Escape to return to the main menu",t.appendChild(s),t.appendChild(o),t.appendChild(n),t.appendChild(i),t.appendChild(a),t.appendChild(l),this.addKeyboardListener(),t}createInstructionsList(){const t=P("ul");return["Use arrow keys, touch controls, or mouse clicks to move your character","Avoid obstacles and monsters","Reach the goal (green square) to complete the level","New monsters appear every 13 steps","Collect bonuses for special abilities","Complete all 13 levels to win"].forEach(o=>{const n=P("li");n.textContent=o,t.appendChild(n)}),t}createBonusDetails(){const t=A(),s=P("h2");s.textContent="New Bonus Details";const o=P("ul");return[{name:"Tsunami",details:["Water gradually floods the grid over 13 steps","Movement becomes slower for both you and monsters","At the 13th step, everything not on an obstacle is eliminated","Use the Climber bonus to survive on obstacles"]},{name:"Monster",details:["You become a monster for 13 steps",'Monsters become vulnerable "players" during this time',"Eliminate all monster-players to win, but be careful not to let them reach the goal!"]},{name:"Slide",details:["Your movement becomes a slide in the chosen direction","You'll keep moving until you hit an obstacle or the edge of the grid","Use this to quickly traverse the grid, but plan your moves carefully!"]},{name:"Sokoban",details:["Gain the ability to push obstacles","Use this to create new paths or crush monsters","Strategic obstacle placement can help block monster paths"]},{name:"Blaster",details:["Equip a blaster that shoots in the direction you're moving","Eliminate monsters in your path","Use carefully to clear your way to the goal"]}].forEach(i=>{const a=P("li"),l=P("strong");l.textContent=i.name+": ",a.appendChild(l);const r=P("ul");i.details.forEach(p=>{const h=P("li");h.textContent=p,r.appendChild(h)}),a.appendChild(r),o.appendChild(a)}),t.appendChild(s),t.appendChild(o),t}createTips(){const t=A(),s=P("h2");s.textContent="Tips";const o=P("ul");return["Plan your route to avoid getting trapped","Use obstacles and new bonuses strategically to outmaneuver monsters","Combine bonuses for powerful effects (e.g., Climber during Tsunami)","Think ahead when using Slide or Sokoban to avoid putting yourself in danger","Keep track of your steps to anticipate new monster spawns"].forEach(i=>{const a=P("li");a.textContent=i,o.appendChild(a)}),t.appendChild(s),t.appendChild(o),t}addKeyboardListener(){ye("keydown",s=>{s.key==="Escape"&&this.onBack()})}}const D=(e,t)=>e.x===t.x&&e.y===t.y,B=(e,t)=>t.some(s=>D(s,e)),te=(e,t)=>Math.abs(e.x-t.x)+Math.abs(e.y-t.y),Ht=e=>{switch(e){case"ArrowUp":case"w":return f.Up;case"ArrowDown":case"s":return f.Down;case"ArrowLeft":case"a":return f.Left;case"ArrowRight":case"d":return f.Right;default:return null}},V=(e,t,s=1)=>{switch(t){case f.Up:return{...e,y:e.y-s};case f.Down:return{...e,y:e.y+s};case f.Left:return{...e,x:e.x-s};case f.Right:return{...e,x:e.x+s}}};function Pe(e,t){switch(e){case f.Up:return t===-1?f.Left:f.Right;case f.Down:return t===-1?f.Left:f.Right;case f.Left:return t===-1?f.Down:f.Up;case f.Right:return t===-1?f.Up:f.Down}}const Yt=(e,t,{gridSize:s})=>!(!(e.x>=0&&e.x<s&&e.y>=0&&e.y<s)||B(e,t.obstacles.filter(i=>!i.isDestroying).map(({position:i})=>i))),le=(e,t,{gridSize:s})=>{if(!(e.x>=0&&e.x<s&&e.y>=0&&e.y<s))return!1;const n=B(t.player.position,t.obstacles.filter(a=>!a.isDestroying).map(({position:a})=>a));if(B(e,t.obstacles.filter(a=>!a.isDestroying).map(({position:a})=>a))&&!E(t,c.Climber)&&!n&&!E(t,c.Crusher)){if(t.activeBonuses.some(a=>a.type===c.Sokoban)){const a=Ge(t.player.position,e),l=V(e,a);if(l.x>=0&&l.x<s&&l.y>=0&&l.y<s&&!B(l,t.obstacles.map(p=>p.position)))return!0}return!1}return!0},Fe=(e,t)=>{const{player:s}=e,o=[f.Up,f.Down,f.Left,f.Right];return E(e,c.Slide)?o.map(n=>{let i=s.position;for(;le(V(i,n),e,t);)i=V(i,n);return{position:i,direction:n}}).filter(n=>!D(n.position,s.position)):o.map(n=>({position:V(s.position,n),direction:n})).filter(({position:n})=>le(n,e,t))};function Xt(e,t,s,o){return Fe(s,o).find(n=>Kt(e,t,Re(o.gridSize,o.cellSize,n.direction)))}function Kt(e,t,s){let o=!1;for(let n=0,i=s.length-1;n<s.length;i=n++){const a=s[n].x,l=s[n].y,r=s[i].x,p=s[i].y;l>t!=p>t&&e<(r-a)*(t-l)/(p-l)+a&&(o=!o)}return o}function Ge(e,t){return t.x>e.x?f.Right:t.x<e.x?f.Left:t.y>e.y?f.Down:f.Up}const jt=(e,t,s,o)=>{e.save(),e.translate(e.canvas.width/2,100),t.forEach(({direction:n})=>{const i=Re(s,o,n);e.beginPath(),e.moveTo(i[0].x,i[0].y),e.lineTo(i[1].x,i[1].y),e.lineTo(i[2].x,i[2].y),e.fillStyle="rgba(255, 255, 0, 0.5)",e.fill()}),e.restore()};function Re(e,t,s){const o=e/3,n=V({x:e/2,y:e/2},s,e/1.5),i=V(n,Pe(s,-1),o),a=V(n,Pe(s,1),o),l=C(n.x,n.y),r=C(i.x,i.y),p=C(a.x,a.y),h=V(n,s,o),u=C(h.x,h.y),y=Math.atan2(u.y-l.y,u.x-l.x),v=Math.cos(y)*t,w=Math.sin(y)*t;return[{x:u.x+v,y:u.y+w},{x:r.x+v,y:r.y+w},{x:p.x+v,y:p.y+w}]}const Qt=(e,t,s,o,n,i,a)=>{const l=[];return e.map(r=>{let p;const h=Zt(r.position,t,s,o);n||h>13?p=me(r.position,r.spawnPoint,s,o,e)[1]||r.position:p=me(r.position,t,s,o,e)[1]||r.position;let u;return i||a?u=Jt(r.position,p,s,o,e):u=p,B(u,l)?u=r.position:l.push(u),{...r,previousPosition:r.position,position:u,moveTimestamp:Date.now()}})},Zt=(e,t,s,o)=>me(e,t,s,o,[]).length-1,Jt=(e,t,s,o,n)=>{const i=t.x-e.x,a=t.y-e.y,l={x:Math.max(0,Math.min(s-1,e.x-i)),y:Math.max(0,Math.min(s-1,e.y-a))};return!B(l,o.map(({position:r})=>r))&&!B(l,n.map(r=>r.position))?l:e},me=(e,t,s,o,n)=>{const i=[],a=[],l={position:e,g:0,h:0,f:0,parent:null};for(i.push(l);i.length>0;){let r=i[0],p=0;if(i.forEach((u,y)=>{u.f<r.f&&(r=u,p=y)}),i.splice(p,1),a.push(r),D(r.position,t))return xt(r);const h=zt(r.position,s);for(const u of h){if(B(u,o.map(({position:S})=>S))||B(u,n.map(S=>S.position))||a.some(S=>D(S.position,u)))continue;const y=r.g+1,v=te(u,t),w=y+v,T=i.find(S=>D(S.position,u));T?y<T.g&&(T.g=y,T.f=w,T.parent=r):i.push({position:u,g:y,h:v,f:w,parent:r})}}return[e]},xt=e=>{const t=[];let s=e;for(;s!==null;)t.unshift(s.position),s=s.parent;return t},zt=(e,t)=>[{x:e.x-1,y:e.y},{x:e.x+1,y:e.y},{x:e.x,y:e.y-1},{x:e.x,y:e.y+1}].filter(o=>o.x>=0&&o.x<t&&o.y>=0&&o.y<t),es=(e,t)=>t.some(s=>D(s.position,e)),ts=(e,t)=>{const s=[];return[e.filter(n=>{const i=t.find(a=>D(a,n.position));return i?(s.push({position:i,startTime:Date.now(),duration:1e3}),ss(t,i),!1):!0}),s]},ss=(e,t)=>{e.splice(e.indexOf(t),1)},os=(e,t)=>Math.abs(e.position.x-t.position.x)<=1&&Math.abs(e.position.y-t.position.y)<=1,de=(e,t)=>t.some(s=>Math.abs(e.x-s.position.x)<=1&&Math.abs(e.y-s.position.y)<=1);class ns{constructor(){m(this,"audioContext");m(this,"masterVolume",.025);this.audioContext=new(window.AudioContext||window.webkitAudioContext)}createOscillator(t,s,o){const n=this.audioContext.createOscillator();return n.type=s,n.frequency.setValueAtTime(t,this.audioContext.currentTime),n.start(),n.stop(this.audioContext.currentTime+o),n}createGain(t,s,o=1){const n=this.audioContext.createGain(),i=o*this.masterVolume;return n.gain.setValueAtTime(0,this.audioContext.currentTime),n.gain.linearRampToValueAtTime(i,this.audioContext.currentTime+t),n.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+t+s),n}playStep(){const t=this.createOscillator(200,"square",.1),s=this.createGain(.01,.09);t.connect(s).connect(this.audioContext.destination)}playElectricalDischarge(){const t=this.createOscillator(800,"sawtooth",.2),s=this.createGain(.01,.19);t.frequency.linearRampToValueAtTime(200,this.audioContext.currentTime+.2),t.connect(s).connect(this.audioContext.destination)}playBonusCollected(){const t=this.createOscillator(600,"sine",.15),s=this.createGain(.01,.14);t.frequency.linearRampToValueAtTime(800,this.audioContext.currentTime+.15),t.connect(s).connect(this.audioContext.destination)}playExplosion(){const t=this.audioContext.createBufferSource(),s=this.audioContext.sampleRate*.5,o=this.audioContext.createBuffer(1,s,this.audioContext.sampleRate),n=o.getChannelData(0);for(let a=0;a<s;a++)n[a]=Math.random()*2-1;t.buffer=o;const i=this.createGain(.01,.49,.5);t.connect(i).connect(this.audioContext.destination),t.start()}playStateTransition(){const t=this.createOscillator(300,"triangle",.3),s=this.createGain(.05,.25);t.frequency.linearRampToValueAtTime(600,this.audioContext.currentTime+.3),t.connect(s).connect(this.audioContext.destination)}playGameOver(){const t=this.createOscillator(440,"sine",1),s=this.createGain(.01,.99);t.frequency.linearRampToValueAtTime(220,this.audioContext.currentTime+1),t.connect(s).connect(this.audioContext.destination)}playLevelComplete(){const t=this.createOscillator(440,"sine",.5),s=this.createOscillator(550,"sine",.5),o=this.createGain(.01,.49),n=this.createGain(.01,.49);t.connect(o).connect(this.audioContext.destination),s.connect(n).connect(this.audioContext.destination),setTimeout(()=>{const i=this.createOscillator(660,"sine",.5),a=this.createGain(.01,.49);i.connect(a).connect(this.audioContext.destination)},250)}playMonsterSpawn(){const t=this.createOscillator(100,"sawtooth",.3),s=this.createGain(.01,.29);t.frequency.exponentialRampToValueAtTime(300,this.audioContext.currentTime+.3),t.connect(s).connect(this.audioContext.destination)}playTeleport(){const t=this.createOscillator(100,"sine",.5),s=this.createOscillator(200,"sine",.5),o=this.createGain(.01,.49),n=this.createGain(.01,.49);t.frequency.exponentialRampToValueAtTime(1e3,this.audioContext.currentTime+.25),s.frequency.exponentialRampToValueAtTime(2e3,this.audioContext.currentTime+.25),t.connect(o).connect(this.audioContext.destination),s.connect(n).connect(this.audioContext.destination),setTimeout(()=>{const i=this.createOscillator(2e3,"sine",.2),a=this.createGain(.01,.19);i.frequency.exponentialRampToValueAtTime(4e3,this.audioContext.currentTime+.2),i.connect(a).connect(this.audioContext.destination)},100)}playBlasterSound(){const s=this.audioContext.createOscillator();s.type="sawtooth",s.frequency.setValueAtTime(1e3,this.audioContext.currentTime),s.frequency.exponentialRampToValueAtTime(500,this.audioContext.currentTime+.15);const o=this.audioContext.createGain();o.gain.setValueAtTime(0,this.audioContext.currentTime),o.gain.linearRampToValueAtTime(this.masterVolume,this.audioContext.currentTime+.01),o.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.15);const n=this.audioContext.createBuffer(1,this.audioContext.sampleRate*.15,this.audioContext.sampleRate),i=n.getChannelData(0);for(let r=0;r<n.length;r++)i[r]=Math.random()*2-1;const a=this.audioContext.createBufferSource();a.buffer=n;const l=this.audioContext.createGain();l.gain.setValueAtTime(this.masterVolume*.2,this.audioContext.currentTime),l.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.15),s.connect(o).connect(this.audioContext.destination),a.connect(l).connect(this.audioContext.destination),s.start(),a.start(),s.stop(this.audioContext.currentTime+.15),a.stop(this.audioContext.currentTime+.15)}}const U=new ns,is=(e,t)=>{const s={type:t,duration:13};switch(e.activeBonuses.push(s),t){case c.CapOfInvisibility:break;case c.ConfusedMonsters:break;case c.LandMine:e.landMines.push({...e.player.position});break;case c.TimeBomb:e.timeBombs.push({position:e.player.position,timer:13,shakeIntensity:0});break;case c.Crusher:break;case c.Builder:break;case c.Climber:break;case c.Teleport:break;case c.Tsunami:e.tsunamiLevel=1;break;case c.Monster:break;case c.Slide:break;case c.Sokoban:break;case c.Blaster:break}},as=(e,t)=>{const s=Object.values(c).filter(i=>typeof i=="number");let o;if(e.monsters.length>5){const i=[c.CapOfInvisibility,c.Crusher,c.LandMine,c.TimeBomb,c.Blaster];o=i[Math.floor(Math.random()*i.length)]}else if(e.obstacles.length>20){const i=[c.Climber,c.Slide,c.Teleport];o=i[Math.floor(Math.random()*i.length)]}else o=s[Math.floor(Math.random()*s.length)];let n;do n={x:Math.floor(Math.random()*t.gridSize),y:Math.floor(Math.random()*t.gridSize)};while(B(n,e.obstacles.map(i=>i.position))||B(n,e.monsters.map(i=>i.position))||B(n,e.bonuses.map(i=>i.position))||D(n,e.player.position)||D(n,e.goal)||te(n,e.player.position)<3);e.bonuses.push({type:o,position:n})},rs=(e,t)=>{const s=e.bonuses.find(o=>o.type===c.Teleport&&!D(o.position,t));s&&(e.player.previousPosition=e.player.position,e.player.position=s.position,e.player.teleportTimestamp=Date.now(),U.playTeleport())},ls=e=>{e.tsunamiLevel++,e.tsunamiLevel>=13&&(B(e.player.position,e.obstacles.map(t=>t.position))||(e.gameEndingState="gameOver",he(e)),e.monsters=[],e.tsunamiLevel=0,e.tsunamiTeardownTimestamp=Date.now())},hs=e=>{const t=e.monsters.find(s=>D(e.player.position,s.position));t&&(e.monsters=e.monsters.filter(s=>s!==t),e.monsters.length===0&&(e.gameEndingState="gameOver",he(e)))},Ne=(e,t,s)=>{let o=e.player.position;for(;le(V(o,t),e,s);)o=V(o,t);return o},cs=(e,t,s,o)=>{const n=e.obstacles.find(i=>D(i.position,s));if(n){const i=V(n.position,Ge(t,s));if(Yt(i,e,{gridSize:o})){n.position=i;const a=e.monsters.find(l=>D(l.position,i));a&&(e.monsters=e.monsters.filter(l=>l!==a))}else s=t}},us=(e,t,s)=>{const o=e.player.position,n=Ne(e,t,s),i={startPosition:o,endPosition:n,direction:t,shotTimestamp:Date.now(),duration:je*(te(o,n)+1)};e.blasterShots.push(i),U.playBlasterSound(),e.monsters=e.monsters.filter(a=>!ps(a.position,o,n,t))},ps=(e,t,s,o)=>{switch(o){case f.Up:case f.Down:return e.x===t.x&&(o===f.Up&&e.y<=t.y&&e.y>=s.y||o===f.Down&&e.y>=t.y&&e.y<=s.y);case f.Left:case f.Right:return e.y===t.y&&(o===f.Left&&e.x<=t.x&&e.x>=s.x||o===f.Right&&e.x>=t.x&&e.x<=s.x)}},ds=(e,t,s)=>{if(ee(t))return t;const o=Ht(e.key);return o!==null?Ve(o,t,s):{...t}},Ve=(e,t,s)=>{if(ee(t))return t;const o={...t},n=o.player.position;let i=V(o.player.position,e);if(E(o,c.Slide)&&(i=Ne(o,e,s)),o.activeBonuses.some(a=>a.type===c.Sokoban)&&cs(o,n,i,s.gridSize),o.obstacles=t.obstacles.filter(a=>!a.isDestroying||Date.now()-a.creationTime<De),E(o,c.Crusher)&&t.obstacles.find(a=>D(i,a.position))&&(o.obstacles=t.obstacles.map(a=>D(i,a.position)?{...a,isDestroying:!0,creationTime:Date.now()}:a),U.playElectricalDischarge()),le(i,o,s)){if(U.playStep(),o.player.position=i,Date.now()-o.player.moveTimestamp>ke&&(o.player.previousPosition=n,o.player.moveTimestamp=Date.now()),o.steps++,o.monsterSpawnSteps++,o.tsunamiLevel>0&&ls(o),D(i,o.goal))return o.gameEndingState="levelComplete",ys(o),o.score+=ms(o),o;const a=o.bonuses.find(h=>D(h.position,i));if(a&&(U.playBonusCollected(),o.bonuses=o.bonuses.filter(h=>!D(h.position,i)),is(o,a.type)),(a==null?void 0:a.type)===c.Teleport&&rs(o,a.position),s.levelUpdater(o,s),o.monsters=Qt(o.monsters,o.player.position,s.gridSize,o.obstacles,E(o,c.CapOfInvisibility),E(o,c.ConfusedMonsters),E(o,c.Monster)),E(o,c.Monster))hs(o);else if(es(o.player.position,o.monsters))return o.gameEndingState="gameOver",he(o),o;E(o,c.Blaster)&&us(o,e,s),o.blasterShots=o.blasterShots.filter(h=>Date.now()-h.shotTimestamp<h.duration);const[l,r]=ts(o.monsters,o.landMines);o.monsters=l,o.explosions=r,o.timeBombs=o.timeBombs.map(h=>({...h,timer:h.timer-1}));const p=o.timeBombs.filter(h=>h.timer===0);if((p.length>0||r.length>0)&&U.playExplosion(),o.explosions=[...o.explosions,...p.map(h=>({position:h.position,startTime:Date.now(),duration:1e3}))],o.timeBombs=o.timeBombs.filter(h=>h.timer>0),o.monsters=o.monsters.filter(h=>!o.explosions.some(u=>os(h,u))),o.obstacles=o.obstacles.map(h=>de(h.position,o.explosions)?{...h,isDestroying:!0,creationTime:Date.now()}:h),o.bonuses=o.bonuses.filter(h=>!de(h.position,o.explosions)),de(o.player.position,o.explosions))return o.gameEndingState="gameOver",he(o),o;if(o.activeBonuses=o.activeBonuses.map(h=>({...h,duration:h.duration-1})).filter(h=>h.duration>0),E(o,c.Builder)){const h={position:n,creationTime:Date.now(),isRaising:!0,isDestroying:!1};B(h.position,o.obstacles.map(({position:u})=>u))||(o.obstacles.push(h),U.playElectricalDischarge())}}return o},ms=e=>100-e.steps+e.monsters.length*10,ee=e=>e.gameEndingState!=="none",he=e=>{e.player.isVanishing=!0,U.playGameOver()},ys=e=>{e.player.isVictorious=!0,U.playLevelComplete()};class fs{constructor(t,s,o){m(this,"level");m(this,"score");m(this,"steps");m(this,"container");m(this,"levelElement");m(this,"scoreElement");m(this,"stepsElement");this.level=t,this.score=s,this.steps=o,this.container=A("hud"),this.levelElement=P("div"),this.scoreElement=P("div"),this.stepsElement=P("div")}render(){return this.levelElement.textContent=`Level: ${this.level}`,this.scoreElement.textContent=`Score: ${this.score}`,this.stepsElement.textContent=`Steps: ${this.steps}`,this.container.appendChild(this.levelElement),this.container.appendChild(this.scoreElement),this.container.appendChild(this.stepsElement),this.container}update(t,s,o){this.level=t,this.score=s,this.steps=o,ie(this.levelElement,`Level: ${this.level}`),ie(this.scoreElement,`Score: ${this.score}`),ie(this.stepsElement,`Steps: ${this.steps}`)}}const bs=10,gs=10,vs=(e,{gridSize:t,monsterSpawnSectors:s})=>{let o=0;const n=50;for(;o<n;){const i=s.length>0?s[Math.round(s.length*Math.random())]:{x:Math.floor(Math.random()*t),y:Math.floor(Math.random()*t)};if(ws(i,e,t))return{position:i,previousPosition:i,moveTimestamp:Date.now(),path:[],seed:Math.random(),isConfused:!1,spawnPoint:i};o++}return null},ws=(e,t,s)=>{if(e.x<0||e.y<0||e.x>=s||e.y>=s||B(e,t.obstacles.map(n=>n.position))||B(e,t.monsters.map(n=>n.position))||B(e,t.bonuses.map(n=>n.position))||D(e,t.goal)||te(e,t.player.position)<bs)return!1;const o=[c.TimeBomb,c.LandMine,c.Crusher,c.Blaster];for(const n of t.bonuses)if(o.includes(n.type)&&te(e,n.position)<gs)return!1;return!0};function Cs(e,t){if(e.monsterSpawnSteps>=13){const s=vs(e,t);s&&(e.monsters.push(s),e.monsterSpawnSteps=0,U.playMonsterSpawn())}}const Ts=()=>{const e=R(),t=N(7,"The First Step","Avoid the lone monster and reach the goal in 13 steps!");return e.player=F(0,3),e.goal=k(6,3),e.monsters=[M(3,0)],e.obstacles=[d(5,2),d(5,3)],[e,t,t.levelStory]},Ms=()=>{const e=R(),t=N(8,"Now You See Me","Use the invisibility cap to sneak past the monsters!");return e.player=F(0,4),e.goal=k(7,4),e.monsters=[M(3,2),M(5,4)],e.bonuses=[I(2,4,c.CapOfInvisibility)],e.obstacles=[d(1,3),d(1,5),d(6,3),d(6,5)],[e,t,t.levelStory]},Ps=()=>{const e=R(),t=N(9,"Bridge the Gap","Build your way to victory!");return e.player=F(0,4),e.goal=k(8,4),e.monsters=[M(4,4)],e.bonuses=[I(2,4,c.Builder)],e.obstacles=[d(3,3),d(3,4),d(3,5),d(5,3),d(5,4),d(5,5)],[e,t,t.levelStory]},Ss=()=>{const e=R(),t=N(9,"Crush and Rush","Clear the path with your crushing power!");e.player=F(0,4),e.goal=k(8,4),e.monsters=[M(4,4)],e.bonuses=[I(2,4,c.Crusher)],e.obstacles=[d(8,2),d(7,2),d(7,3),d(7,4),d(7,5),d(8,5)];for(let s=2;s<7;s++)e.obstacles.push(d(s,3)),e.obstacles.push(d(s-1,5));return[e,t,t.levelStory]},Is=()=>{const e=R(),t=N(10,"Tick Tock Boom","Time your bomb perfectly to clear the way!");e.player=F(0,5),e.goal=k(9,5),e.monsters=[M(3,5)],e.bonuses=[I(8,3,c.TimeBomb)],e.obstacles=[d(9,4),d(8,4),d(8,5),d(8,6),d(9,6),d(2,1),d(3,1),d(4,1),d(5,1),d(6,1),d(7,1),d(8,1)];for(let s=2;s<8;s++)e.obstacles.push(d(s,4)),e.obstacles.push(d(s,6)),e.obstacles.push(d(s-2,8));return t.monsterSpawnSectors=[k(1,9)],[e,t,t.levelStory]},ks=()=>{const e=R(),t=N(10,"Minesweeper's Revenge","Plant a surprise for your pursuers!");e.player=F(0,5),e.goal=k(9,5),e.monsters=[M(6,5),M(4,8),M(8,8)],e.bonuses=[I(2,5,c.LandMine)];for(let s=4;s<9;s++)s!==6&&(e.obstacles.push(d(s,4)),e.obstacles.push(d(s,6)));return[e,t,t.levelStory]},Ls=()=>{const e=R(),t=N(11,"Monsters' Mayhem","Confuse them all and make your escape!");e.player=F(0,5),e.goal=k(10,5),e.monsters=[M(3,4),M(3,6),M(6,4),M(6,6)],e.bonuses=[I(2,5,c.ConfusedMonsters)];for(let s=4;s<8;s++)e.obstacles.push(d(s,3)),e.obstacles.push(d(s,7));return[e,t,t.levelStory]},Ds=()=>{const e=R(),t=N(12,"Tunnel Vision","Build a path and set a trap!");e.player=F(0,6),e.goal=k(11,6),e.monsters=[],e.bonuses=[I(2,6,c.Builder),I(5,6,c.LandMine),I(5,5,c.Sokoban)];for(let s=3;s<10;s++)s!==5&&s!==8&&(e.obstacles.push(d(s,5)),e.obstacles.push(d(s,7)));return e.obstacles.push(d(1,4)),e.obstacles.push(d(1,8)),e.obstacles.push(d(10,4)),e.obstacles.push(d(10,8)),e.obstacles.push(d(11,5)),e.obstacles.push(d(11,7)),t.monsterSpawnSectors=[k(0,0)],[e,t,"Use the Builder bonus to create a path and set up a trap with the Land Mine. Be strategic about where you place your obstacles and mine to catch the spawning monsters!"]},Es=()=>{const e=R(),t=N(12,"Ghost Bomber","Vanish, plant, and detonate!");e.player=F(0,6),e.goal=k(11,6),e.monsters=[M(3,1),M(7,11),M(10,3)],e.bonuses=[I(2,6,c.CapOfInvisibility),I(9,6,c.TimeBomb),I(7,4,c.CapOfInvisibility)];for(let s=2;s<11;s+=2)for(let o=1;o<12;o+=2)!(s===10&&o===5)&&!(s===10&&o===7)&&e.obstacles.push(d(s,o));return e.obstacles.push(d(11,5)),e.obstacles.push(d(10,6)),e.obstacles.push(d(11,7)),e.obstacles.push(d(10,8)),e.obstacles.push(d(1,3)),e.obstacles.push(d(1,9)),e.obstacles.push(d(5,6)),e.obstacles.push(d(8,4)),e.obstacles.push(d(8,8)),[e,t,"Use your invisibility wisely to sneak past the monsters and reach the time bomb. Then, strategically place and detonate the bomb to clear a path to the goal!"]},As=()=>{const e=R(),t=N(13,"Surf and Climb","Ride the wave and climb to safety!");e.player=F(0,6),e.goal=k(12,6),e.monsters=[M(4,6),M(8,6),M(11,6),M(6,2),M(6,10)],e.bonuses=[I(2,6,c.Tsunami),I(4,4,c.Climber)];for(let s=1;s<12;s++)s!==2&&s!==10&&(e.obstacles.push(d(s,5)),e.obstacles.push(d(s,7)));e.obstacles.push(d(3,6)),e.obstacles.push(d(6,6)),e.obstacles.push(d(9,6));for(let s=0;s<13;s+=3)e.obstacles.push(d(s,0)),e.obstacles.push(d(s,12));return e.obstacles.push(d(11,5)),e.obstacles.push(d(11,7)),[e,t,"Collect the Tsunami bonus first, then make your way to the Climber bonus. Use the Climber to get on top of an obstacle, then activate the Tsunami to wash away the monsters. Time it right to reach the goal!"]},Bs=()=>{const e=R(),t=N(14,"Slide and Blast","Slide through danger and blast your way to victory!");e.player=F(0,0),e.goal=k(13,13),e.monsters=[M(3,3),M(10,10),M(6,7),M(7,6),M(13,0)],e.bonuses=[I(0,2,c.Blaster),I(0,13,c.Slide)];for(let s=2;s<12;s+=3)for(let o=0;o<14;o++)o!==7&&e.obstacles.push(d(s,o));return e.obstacles.push(d(12,1)),e.obstacles.push(d(12,2)),e.obstacles.push(d(11,1)),e.obstacles.push(d(0,6)),e.obstacles.push(d(1,1)),e.obstacles.push(d(4,4)),e.obstacles.push(d(9,9)),e.obstacles.push(d(12,10)),[e,t,"Navigate to the Slide bonus to quickly traverse the level. Then, collect the Blaster to destroy the wall blocking your path to the goal. Watch out for monsters and use your bonuses strategically!"]},Os=()=>{const e=R(),t=N(15,"The Gauntlet","Master all your skills to conquer the final challenge!");e.player=F(0,7),e.goal=k(14,7),e.monsters=[M(5,2),M(5,12),M(10,4),M(10,10),M(14,0),M(14,14)],e.bonuses=[I(2,7,c.CapOfInvisibility),I(4,7,c.Crusher),I(7,3,c.TimeBomb),I(7,11,c.LandMine),I(10,7,c.Blaster),I(12,7,c.Climber)];for(let s=1;s<14;s++)s%3!==1&&(e.obstacles.push(d(s,6)),e.obstacles.push(d(s,8)));for(let s=0;s<15;s+=3)if(s!==6&&s!==9)for(let o=0;o<15;o++)o!==7&&e.obstacles.push(d(s,o));return e.obstacles.push(d(3,5)),e.obstacles.push(d(3,9)),e.obstacles.push(d(7,5)),e.obstacles.push(d(7,9)),e.obstacles.push(d(11,5)),e.obstacles.push(d(11,9)),e.obstacles.push(d(13,6)),e.obstacles.push(d(13,8)),e.obstacles.push(d(14,6)),e.obstacles.push(d(14,8)),[e,t,"This is your final test! Use all the skills you've learned to navigate through the gauntlet. Collect bonuses strategically, avoid or eliminate monsters, and make your way to the goal. Good luck!"]},W=16,$e=5;function be(){return{x:Math.floor(Math.random()*W),y:Math.floor(Math.random()*W)}}function We(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}function ge(e,t){return!t.obstacles.some(s=>s.position.x===e.x&&s.position.y===e.y)&&!t.monsters.some(s=>s.position.x===e.x&&s.position.y===e.y)&&!t.bonuses.some(s=>s.position.x===e.x&&s.position.y===e.y)&&e.x!==t.player.position.x&&e.y!==t.player.position.y&&e.x!==t.goal.x&&e.y!==t.goal.y}function Fs(e,t){for(let s=0;s<t;s++){let o;do o=be();while(!ge(o,e));e.obstacles.push(d(o.x,o.y))}}function Gs(e){const t=Object.values(c).filter(n=>typeof n=="number"),s=t[Math.floor(Math.random()*t.length)];let o;do o=be();while(!ge(o,e)||We(o,e.player.position)<$e);e.bonuses.push(I(o.x,o.y,s))}const Rs=()=>{const e=R(),t=N(W,"The Final Countdown","Survive and thrive in this ever-changing challenge!",Ns);e.player=F(0,0),e.goal=k(W-1,W-1),e.obstacles=[d(W-2,W-2),d(W-1,W-2),d(W-2,W-1)],Fs(e,50);for(let s=0;s<3;s++)Gs(e);return[e,t,"Welcome to the ultimate challenge! The level will dynamically evolve as you play. Use your skills wisely, collect bonuses, and make your way to the goal while avoiding the increasing dangers. Good luck!"]},Ns=(e,t)=>{if(e.steps%13===0){let s;do s=be();while(!ge(s,e)||We(s,e.player.position)<$e);e.monsters.push(M(s.x,s.y)),as(e,t)}},k=(e,t)=>({x:e,y:t}),I=(e,t,s)=>({position:k(e,t),type:s}),M=(e,t)=>({position:k(e,t),previousPosition:k(e,t),moveTimestamp:Date.now(),path:[],seed:Math.random(),isConfused:!1,spawnPoint:k(e,t)}),F=(e,t)=>({position:k(e,t),previousPosition:k(e,t),moveTimestamp:Date.now(),isVictorious:!1,isVanishing:!1}),d=(e,t)=>({position:k(e,t),creationTime:Date.now(),isRaising:!1,isDestroying:!1}),R=()=>({player:F(0,0),goal:k(0,0),obstacles:[],monsters:[],steps:0,monsterSpawnSteps:0,bonuses:[],activeBonuses:[],explosions:[],timeBombs:[],landMines:[],score:0,gameEndingState:"none",tsunamiLevel:0,blasterShots:[]}),Vs=40,N=(e,t,s,o=Cs)=>({gridSize:e,cellSize:Vs,initialMonsterCount:0,monsterSpawnSectors:[],obstacleCount:0,initialBonusCount:0,levelName:t,levelStory:s,levelUpdater:o}),$s={1:Ts,2:Ms,3:Ps,4:Ss,5:Is,6:ks,7:Ls,8:Ds,9:Es,10:As,11:Bs,12:Os,13:Rs},Ue=e=>{if(e<1||e>13)throw new Error(`Invalid level number: ${e}`);return $s[e]()},Ws=13,Us=2e3;class _s{constructor(t,s,o,n,i,a,l){m(this,"level");m(this,"onGameOver");m(this,"onLevelComplete");m(this,"onGameComplete");m(this,"updateScore");m(this,"updateSteps");m(this,"container");m(this,"canvas");m(this,"ctx");m(this,"gameState");m(this,"levelConfig");m(this,"hud");m(this,"animationFrameId",null);m(this,"handleKeyDown",t=>{if(!ee(this.gameState)){const s=ds(t,this.gameState,this.levelConfig);this.updateGameState(s)}});this.level=t,this.onGameOver=o,this.onLevelComplete=n,this.onGameComplete=i,this.updateScore=a,this.updateSteps=l,this.container=A("gameplay"),this.canvas=P("canvas"),this.ctx=this.canvas.getContext("2d"),[this.gameState,this.levelConfig]=Ue(t),this.hud=new fs(t,s,this.gameState.monsterSpawnSteps),ye("keydown",this.handleKeyDown)}render(){this.container.innerHTML="",this.container.appendChild(this.hud.render());const t=A("canvas-container");return t.appendChild(this.canvas),this.container.appendChild(t),this.initializeCanvas(),this.startGameLoop(),this.addEventListeners(),this.container}initializeCanvas(){const t=(this.levelConfig.gridSize+this.levelConfig.gridSize)*this.levelConfig.cellSize,s=(this.levelConfig.gridSize+this.levelConfig.gridSize)*this.levelConfig.cellSize/2;this.canvas.width=t,this.canvas.height=s+100}startGameLoop(){const t=()=>{this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),Oe(this.ctx,this.gameState,this.levelConfig),ee(this.gameState)||jt(this.ctx,Fe(this.gameState,this.levelConfig),this.levelConfig.gridSize,this.levelConfig.cellSize),this.animationFrameId=requestAnimationFrame(t)};t()}addEventListeners(){Se(this.canvas,"click",this.handleClick.bind(this))}handleClick(t){if(ee(this.gameState))return;const s=this.canvas.getBoundingClientRect(),o=Xt((t.clientX-s.left)*(this.canvas.width/s.width)-this.canvas.width/2,(t.clientY-s.top)*(this.canvas.height/s.height)-100,this.gameState,this.levelConfig);o&&this.updateGameState(Ve(o.direction,this.gameState,this.levelConfig))}updateGameState(t){this.gameState=t,this.updateScore(t.score),this.updateSteps(t.steps),this.hud.update(this.level,t.score,t.monsterSpawnSteps),t.gameEndingState!=="none"&&setTimeout(()=>{t.gameEndingState==="levelComplete"&&(this.level===Ws?this.onGameComplete():this.onLevelComplete()),t.gameEndingState==="gameOver"&&this.onGameOver()},Us)}destroy(){this.animationFrameId!==null&&cancelAnimationFrame(this.animationFrameId),Ie("keydown",this.handleKeyDown)}}class qs{constructor(t,s,o,n){m(this,"score");m(this,"steps");m(this,"onTryAgain");m(this,"onQuit");this.score=t,this.steps=s,this.onTryAgain=o,this.onQuit=n}render(){const t=A("game-over"),s=P("h1");s.textContent="Game Over";const o=P("p");o.textContent=`Your score: ${this.score}`;const n=P("p");n.textContent=`Steps taken: ${this.steps}`;const i=Y("Try Again",this.onTryAgain),a=Y("Quit",this.onQuit);return Q(t,[s,o,n,i,a]),t}}class Hs{constructor(t,s,o){m(this,"level");m(this,"onNextLevel");m(this,"onQuit");this.level=t,this.onNextLevel=s,this.onQuit=o}render(){const t=A("level-complete"),s=P("h1");s.textContent=`Level ${this.level} Complete!`;const o=P("p");o.textContent="Congratulations! You've completed the level.";const n=Y("Next Level",this.onNextLevel),i=Y("Quit",this.onQuit);return Q(t,[s,o,n,i]),t}}class Ys{constructor(t,s){m(this,"level");m(this,"onStoryComplete");m(this,"container");m(this,"levelStory");this.level=t,this.onStoryComplete=s,this.container=A("level-story"),[,,this.levelStory]=Ue(t),this.handleKeyPress=this.handleKeyPress.bind(this),setTimeout(()=>{ye("keydown",this.handleKeyPress)})}render(){const t=P("h2");t.textContent=`Level ${this.level}`;const s=P("p");s.textContent=this.levelStory;const o=P("p");return o.textContent="Press any key to start...",this.container.appendChild(t),this.container.appendChild(s),this.container.appendChild(o),this.container}handleKeyPress(t){t.preventDefault(),this.onStoryComplete(),this.destroy()}destroy(){Ie("keydown",this.handleKeyPress)}}class Xs{constructor(t){m(this,"container");m(this,"gameState");m(this,"level");m(this,"score");m(this,"steps");m(this,"currentScreen");this.container=t,this.gameState=0,this.level=parseInt(document.location.hash.split("level")[1]??"1"),this.score=0,this.steps=0,this.currentScreen=null}init(){this.addKeyboardListeners(),this.renderCurrentState()}addKeyboardListeners(){document.addEventListener("keydown",t=>{if(t.key==="ArrowRight")switch(this.gameState){case 0:this.startGame();break;case 5:this.nextLevel();break;case 4:this.restartLevel();break;case 6:this.restartGame();break}else t.key==="Escape"&&(this.gameState===1||this.gameState===4||this.gameState===6)&&this.quitGame()})}renderCurrentState(){Xe(this.container);let t;switch(this.gameState){case 0:this.currentScreen=new _t(this.startGame.bind(this),this.showInstructions.bind(this));break;case 1:this.currentScreen=new qt(this.quitGame.bind(this));break;case 2:this.currentScreen=new Ys(this.level,this.startGameplay.bind(this));break;case 3:this.currentScreen=new _s(this.level,this.score,this.gameOver.bind(this),this.levelComplete.bind(this),this.gameComplete.bind(this),this.updateScore.bind(this),this.updateSteps.bind(this));break;case 4:this.currentScreen=new qs(this.score,this.steps,this.restartLevel.bind(this),this.quitGame.bind(this));break;case 5:this.currentScreen=new Hs(this.level,this.nextLevel.bind(this),this.quitGame.bind(this));break;case 6:this.currentScreen=new Ks(this.score,this.steps,this.restartGame.bind(this),this.quitGame.bind(this));break}t=this.currentScreen.render(),this.container.appendChild(t)}startGame(){this.gameState=2,this.renderCurrentState()}startGameplay(){this.gameState=3,this.renderCurrentState()}showInstructions(){this.gameState=1,this.renderCurrentState()}restartGame(){this.level=1,this.score=0,this.steps=0,this.gameState=2,this.renderCurrentState()}restartLevel(){this.gameState=2,this.renderCurrentState()}quitGame(){this.gameState=0,this.renderCurrentState()}gameOver(){this.gameState=4,this.renderCurrentState()}levelComplete(){this.level++,this.gameState=5,this.renderCurrentState()}nextLevel(){this.gameState=2,this.renderCurrentState()}gameComplete(){U.playLevelComplete(),this.gameState=6,this.renderCurrentState()}updateScore(t){this.score=t}updateSteps(t){this.steps=t}}class Ks{constructor(t,s,o,n){m(this,"score");m(this,"steps");m(this,"onPlayAgain");m(this,"onQuit");this.score=t,this.steps=s,this.onPlayAgain=o,this.onQuit=n}render(){const t=A("game-complete intro"),s=document.createElement("h1");s.className="game-title",s.textContent="Monster Steps";const o=document.createElement("h2");o.className="game-complete-subtitle",o.textContent="Congratulations!";const n=A("game-complete-stats");n.innerHTML=`
      <p>Final Score: ${this.score}</p>
      <p>Total Steps: ${this.steps}</p>
    `;const i=A("intro-buttons"),a=document.createElement("button");a.textContent="Play Again",a.onclick=this.onPlayAgain;const l=document.createElement("button");l.textContent="Quit",l.onclick=this.onQuit,i.appendChild(a),i.appendChild(l);const r=document.createElement("p");return r.className="intro-tip",r.textContent="Press right arrow to play again",t.appendChild(s),t.appendChild(o),t.appendChild(n),t.appendChild(i),t.appendChild(r),t}}const ve=P("div");ve.id="game-container";document.body.appendChild(ve);const js=new Xs(ve);js.init();
