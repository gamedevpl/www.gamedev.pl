(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=e(a);fetch(a.href,r)}})();let g=0;const oe=g++,Wt=g++,Bt=g++,Ft=g++,he=g++,ce=g++,Vt=g++,Ht=g++,le=g++;g++;g++;const ue=g++,ct=g++,J=g++,lt=g++,C=g++,de=g++,Gt=g++,fe=g++,me=g++,ge=g++,pe=g++,ve=g++,ye=g++,Ee=g++,we=g++;g++;const ut=g++,dt=g++;function _e(i){window.addEventListener("keydown",function(t){t.keyCode==37&&i(fe),t.keyCode==38&&i(ge),t.keyCode==39&&i(me),t.keyCode==40&&i(pe),t.keyCode==27&&i(ue),i(de,t.keyCode)}),window.addEventListener("keyup",function(t){t.keyCode==37&&i(ve),t.keyCode==38&&i(Ee),t.keyCode==39&&i(ye),t.keyCode==40&&i(we),i(Gt,t)}),window.addEventListener("mousedown",function(t){i(ct,t)}),window.addEventListener("mouseup",function(t){i(J,t)}),window.addEventListener("mousemove",function(t){i(lt,t)}),window.addEventListener("click",function(t){i(C,t)})}const be=null,Ce=10,Ae=100,tt="layer-default",ft=800,H=100,_=32,L=32,Ut=1600,qt=800,De=Ut/_,Te=qt/L,Me=10,nt=_+Me,ot=600,Re=250,xt=300,Lt=500,ke=_*5,Nt=1e3,xe=_/3,q=_*4,It=1500,Le=1e3,St=()=>z(null,"RgYEBAMEAgIGBAQIBAICBgQEDQQCAgYEBBIEAwIGBAQXBAMCBgQEHAQCAgYEBCEEAgIGBAQmBAICBhABEgoBAgYQARcMAQI=");class D{constructor(t,e,s,a,r,n,o){this.field=t,this.el=document.createElement("div"),this.setFormation(a,r),this.el.className="field-unit",this.el.designerUnit=this,this.field.appendChild(this.el),this.setType(n),this.setPosition(e,s),this.setCommand(o)}getDefinition(){return{sizeCol:this.sizeCol,sizeRow:this.sizeRow,col:this.col,row:this.row,type:this.type,command:this.command}}setFormation(t,e){this.sizeCol=t,this.sizeRow=e,this.el.style.width=this.sizeCol*_+"px",this.el.style.height=this.sizeRow*L+"px"}setType(t){this.type=t,this.el.dataset.unitType=t}setCommand(t){this.command=t,this.el.dataset.command=t}updatePosition(){this.el.style.left=this.col*_+"px",this.el.style.top=this.row*L+"px"}setPosition(t,e){this.col=Math.max(0,Math.min(t,De-this.sizeCol)),this.row=Math.max(0,Math.min(e,Te-this.sizeRow)),this.updatePosition()}startDrag(){this.field.classList.add("drag"),this.el.classList.add("drag")}stopDrag(){this.field.classList.remove("drag"),this.el.classList.remove("drag")}select(){this.el.classList.add("select"),this.field.classList.add("select")}deselect(){this.el.classList.remove("select"),this.field.classList.remove("select")}}D.of=(i,t)=>new D(i,t.col,t.row,t.sizeCol,t.sizeRow,t.type,t.command);D.types={archer:1,warrior:2,tank:3,artillery:4,1:"archer",2:"warrior",3:"tank",4:"artillery"};D.commands={"wait-advance":1,advance:2,"advance-wait":3,"flank-left":4,"flank-right":5,1:"wait-advance",2:"advance",3:"advance-wait",4:"flank-left",5:"flank-right"};function zt(){return new Date().getTime()}function y(i,t){return Ne(i,t)[0]}function Ne(i,t){return(t||document.body).querySelectorAll(i)}function x(i,t){t=t||"battle-string";var e=o=>[o.sizeCol,o.sizeRow,o.col,o.row,D.types[o.type],D.commands[o.command]],s=(i.username||"").split("").map(o=>o.charCodeAt(0)),a=i.map(e).reduce((o,h)=>o.concat([h.length],h),[]);i=new Uint8Array([a.length].concat(a.concat(s)));var r=new TextDecoder("utf8"),n=btoa(r.decode(i));document.getElementById(t).value=n;try{localStorage[t]=n}catch{}y("#sharelink").value="http://gtanczyk.warsztat.io/masterplan/index.html#vs="+n}function z(i,t){for(var e=new TextEncoder("utf8"),s=e.encode(atob(t||document.getElementById(i||"battle-string").value)),a=[],r=s[0],n=1;n<=r;){var o=s[n],h=s.slice(n+1,n+o+1);a.push({sizeCol:h[0],sizeRow:h[1],col:h[2],row:h[3],type:D.types[h[4]],command:D.commands[h[5]]}),n+=o+1}var l=Array.from(s.slice(r+1));return a.username=(l.map(u=>String.fromCharCode(u)).join("").match(/(\w)+/g)||[]).join(""),a}const c={EPSILON:Math.pow(2,-16),length:function(i){return Math.sqrt(i[0]*i[0]+i[1]*i[1])},distanceSquared:function(i,t){return Math.pow(i[0]-t[0],2)+Math.pow(i[1]-t[1],2)},distance:function(i,t){return Math.sqrt(this.distanceSquared(i,t))},withinDistance:function(i,t,e){var s=i[0]-t[0],a=i[1]-t[1];if(Math.abs(s)>e||Math.abs(a)>e)return!1;var r=Math.pow(s,2)+Math.pow(a,2);return Math.sqrt(r)<e},normalize:function(i){return this.scale(i,1/this.length(i))},angle:function(i,t){return Math.atan2(this.perpDot(i,t),this.dot(i,t))},dot:function(i,t){return i[0]*t[0]+i[1]*t[1]},perpDot:function(i,t){return i[0]*t[1]-i[1]*t[0]},atan2:function(i,t){return Math.atan2(t[1]-i[1],t[0]-i[0])},sub:function(i,t){return[i[0]-t[0],i[1]-t[1]]},add:function(i,t){return[i[0]+t[0],i[1]+t[1]]},scale:function(i,t){return[i[0]*t,i[1]*t]},rotate:function(i,t){var e=this.length(i);return t=Math.atan2(i[1],i[0])+t,[Math.cos(t)*e,Math.sin(t)*e]},reflect:function(){return[0,0]},project:function(){return[0,0]},normal:function(i,t){var e=this.sub(t,i);return e=this.scale(e,1/this.length(e)),[[-e[1],e[0]],[e[1],-e[0]]]},intersectLineLine:function(i,t,e,s){var a=this.sub(t,i),r=this.sub(s,e),n=this.perpDot(r,a);if(n!=0){var o=this.perpDot(this.sub(i,e),r)/n,h=this.perpDot(this.sub(i,e),a)/n;if(!(o<0||h<0||o>1||h>1))return[o,h]}},intersectSphereSphere:function(i,t,e,s,a,r){var n=this.sub(t,i),o=this.sub(s,e),h=a+r,l=this.dot(n,n),u=h*h,f=this.dot(o,o);if(f!=0){var d=2*this.dot(o,n),T=l-u;if(l<=u)return[0,0];var m=d*d-4*f*T;if(!(m<0)){m=Math.sqrt(m);var N=(-d-m)/(2*f),b=(-d+m)/(2*f);return N<b?[N,b]:[b,N]}}},intersectSphereLine:function(i,t,e,s,a){var r=this.sub(a,s),n=e/Math.sqrt(this.dot(r,r)),o=this.scale([-r[1],r[0]],n),h=this.scale([r[1],-r[0]],n);o=this.add(i,o),h=this.add(i,h);var l=[this.intersectLineLine(o,this.add(o,t),s,a),this.intersectLineLine(h,this.add(h,t),s,a)];if(!l[0]||!l[1])return l[0]||l[1];if(!(!l[0]&&!l[1])&&(l[0][0]<l[1][0]?l=l[0]:l=l[1],!(l[0][0]<0||l[1]<0)&&l[0]<=1&&l[1]<=1))return l}};class pt{constructor(t,e,s,a,r){this.vec=[t,e],this.direction=r,this.objectWidth=s,this.objectHeight=a}getTargetVelocity(){}update(){}render(t){t.save().translate(-this.getWidth()/2,-this.getHeight()/2).fillRect(0,0,this.getWidth(),this.getHeight()).restore()}getX(){return this.vec[0]}setX(t){this.vec[0]=t}getY(){return this.vec[1]}setY(t){this.vec[1]=t}getDirection(){return this.direction}setDirection(t){this.direction=t}getWidth(){return this.objectWidth}getHeight(){return this.objectHeight}vec(){return this.vec}getClass(){return"Object"}}const Ot={arrow:[10,1],ball:[10,10]};class $t extends pt{constructor(t,e,s,a,r){super(t[0],t[1],Ot[r][0],Ot[r][1],c.atan2(t,e)),this.world=s,this.from=t,this.to=e,this.maxDist=c.distance(t,e),this.attackBase=a,this.type=r,this.v=c.normalize(c.sub(e,t))}update(t){var e=c.scale(this.v,t*20);this.vec[0]+=e[0],this.vec[1]+=e[1];var s=Math.sin(c.distance(this.from,this.vec)/this.maxDist*Math.PI);this.adir=this.direction-Math.PI/3*(1-s),this.ay=this.vec[1]-s*this.maxDist/10,c.distance(this.from,this.vec)>this.maxDist&&this.world.removeObject(this)}getY(){return this.ay}getDirection(){return this.adir}isHit(){return this.maxDist-c.distance(this.from,this.vec)<10}hit(t,e){t.hitByArrow(this,e)}getAttack(){return this.attackBase}getClass(){return"Arrow"}}class Ie extends pt{constructor(t,e,s){super(t[0],t[1],q*2,q*2,0),this.time=e,this.world=s}render(t){var e=this.world.getTime()-this.time;e<100&&t.save().arc(0,0,q*Math.min(e/100,1)).restore()}getClass(){return"Explosion"}}function Se(){this.setSettings=function(i){for(var t=0;t<24;t++)this[String.fromCharCode(97+t)]=i[t]||0;this.c<.01&&(this.c=.01);var e=this.b+this.c+this.e;if(e<.18){var s=.18/e;this.b*=s,this.c*=s,this.e*=s}}}function Oe(){this._params=new Se;var i,t,e,s,a,r,n,o,h,l,u,f;this.reset=function(){var d=this._params;s=100/(d.f*d.f+.001),a=100/(d.g*d.g+.001),r=1-d.h*d.h*d.h*.01,n=-d.i*d.i*d.i*1e-6,d.a||(u=.5-d.n/2,f=-d.o*5e-5),o=1+d.l*d.l*(d.l>0?-.9:10),h=0,l=d.m==1?0:(1-d.m)*(1-d.m)*2e4+32},this.totalReset=function(){this.reset();var d=this._params;return i=d.b*d.b*1e5,t=d.c*d.c*1e5,e=d.e*d.e*1e5+12,((i+t+e)/3|0)*3},this.synthWave=function(d,T){var m=this._params,N=m.s!=1||m.v,b=m.v*m.v*.1,wt=1+m.w*3e-4,M=m.s*m.s*m.s*.1,jt=1+m.t*1e-4,Qt=m.s!=1,Jt=m.x*m.x,Zt=m.g,_t=m.q||m.r,te=m.r*m.r*m.r*.2,bt=m.q*m.q*(m.q<0?-1020:1020),Ct=m.p?((1-m.p)*(1-m.p)*2e4|0)+32:0,ee=m.d,At=m.j/2,ie=m.k*m.k*.01,et=m.a,it=i,se=1/i,ae=1/t,re=1/e,O=5/(1+m.u*m.u*20)*(.01+M);O>.8&&(O=.8),O=1-O;var st=!1,Dt=0,P=0,W=0,at=0,K=0,Tt,B=0,w,R=0,k,rt=0,A,Mt=0,v,I,Rt=0,Y=new Array(1024),F=new Array(32);for(let V=Y.length;V--;)Y[V]=0;for(let V=F.length;V--;)F[V]=Math.random()*2-1;for(var X=0;X<T;X++){if(st)return X;if(Ct&&++Mt>=Ct&&(Mt=0,this.reset()),l&&++h>=l&&(l=0,s*=o),r+=n,s*=r,s>a&&(s=a,Zt>0&&(st=!0)),w=s,At>0&&(Rt+=ie,w*=1+Math.sin(Rt)*At),w|=0,w<8&&(w=8),et||(u+=f,u<0?u=0:u>.5&&(u=.5)),++P>it)switch(P=0,++Dt){case 1:it=t;break;case 2:it=e}switch(Dt){case 0:W=P*se;break;case 1:W=1+(1-P*ae)*2*ee;break;case 2:W=1-P*re;break;case 3:W=0,st=!0}_t&&(bt+=te,k=bt|0,k<0?k=-k:k>1023&&(k=1023)),N&&wt&&(b*=wt,b<1e-5?b=1e-5:b>.1&&(b=.1)),I=0;for(var ne=8;ne--;){if(R++,R>=w&&(R%=w,et==3))for(var kt=F.length;kt--;)F[kt]=Math.random()*2-1;switch(et){case 0:v=R/w<u?.5:-.5;break;case 1:v=1-R/w*2;break;case 2:A=R/w,A=(A>.5?A-1:A)*6.28318531,v=1.27323954*A+.405284735*A*A*(A<0?1:-1),v=.225*((v<0?-1:1)*v*v-v)+v;break;case 3:v=F[Math.abs(R*32/w|0)]}N&&(Tt=B,M*=jt,M<0?M=0:M>.1&&(M=.1),Qt?(K+=(v-B)*M,K*=O):(B=v,K=0),B+=K,at+=B-Tt,at*=1-b,v=at),_t&&(Y[rt%1024]=v,v+=Y[(rt-k+1024)%1024],rt++),I+=v}I*=.125*W*Jt,d[X]=I>=1?32767:I<=-1?-32768:I*32767|0}return T}}var ht=new Oe;const Pe=function(i){ht._params.setSettings(i);var t=ht.totalReset(),e=new Uint8Array(((t+1)/2|0)*4+44),s=ht.synthWave(new Uint16Array(e.buffer,44),t)*2,a=new Uint32Array(e.buffer,0,44);a[0]=1179011410,a[1]=s+36,a[2]=1163280727,a[3]=544501094,a[4]=16,a[5]=65537,a[6]=44100,a[7]=88200,a[8]=1048578,a[9]=1635017060,a[10]=s,s+=44;for(var r=0,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o="data:audio/wav;base64,";r<s;r+=3){var h=e[r]<<16|e[r+1]<<8|e[r+2];o+=n[h>>18]+n[h>>12&63]+n[h>>6&63]+n[h&63]}return o};function vt(){this.sounds={}}vt.prototype.add=function(i,t,e){this.sounds[i]=[],e.forEach(function(s,a){this.sounds[i].push({tick:0,count:t,pool:[]});for(var r=0;r<t;r++){var n=new Audio;n.src=Pe(s),this.sounds[i][a].pool.push(n)}},this)};vt.prototype.play=function(i){var t=this.sounds[i],e=t.length>1?t[Math.floor(Math.random()*t.length)]:t[0];e.pool[e.tick].play(),e.tick<e.count-1?e.tick++:e.tick=0};const S=new vt;S.add("arrow",10,[[0,.13,.12,.21,.28,.7097,.11,.4399,,,,.2845,.6608,,,,,,1,,,,,.32]]);S.add("hitarrow",10,[[2,,.0664,,.1176,.7984,,-.5791,,,,,,,,,,,1,,,.0922,,.47]]);S.add("damage",10,[[3,,.0421,,.1467,.7815,,-.4846,,,,,,.4464,,,,,1,,,.2247,,.47]]);let We=0;class Z extends pt{constructor(t,e,s,a,r,n,o){s+=(Math.random()-Math.random())/1e3,super(t,e,_,L,s),this.soldierId=We++,this.plan=a,this.world=r,this.type=o,this.velocity=0,this.targetVelocity=1,this.force=[0,0],this.targetDirection=s,this.image=y("#asset-soldier-"+this.type),this.imageDead=y("#asset-soldier-"+this.type+"-dead"),this.color=n,this.life=H,this.newLife=H,this.defenceCooldown=It,this.weight=1,this.baseSpeed=1,this.type==="warrior"?(this.seekRange=ot,this.attackRange=nt,this.rangeDefence=30,this.meleeDefence=50,this.meleeAttack=45,this.baseSpeed=3,this.canCharge=!0,this.isMelee=!0):this.type==="tank"?(this.seekRange=ot,this.attackRange=nt*1.1,this.rangeDefence=90,this.meleeDefence=90,this.meleeAttack=20,this.life=this.newLife=H*2,this.defenceCooldown=It/5,this.weight=3,this.canCharge=!1,this.isMelee=!0):this.type==="archer"?(this.seekRange=Lt,this.attackRange=xt,this.rangeAttack=45,this.rangeDefence=25,this.rangedCooldown=Nt,this.meleeDefence=10,this.meleeAttack=10,this.rangeType="arrow"):this.type==="artillery"&&(this.seekRange=Lt,this.attackRange=xt*5,this.weight=10,this.baseSpeed=.1,this.rangeAttack=100,this.rangeDefence=1,this.rangedCooldown=Nt*10,this.meleeDefence=1,this.meleeAttack=1,this.rangeType="ball"),this.cooldowns={}}render(t){t.save().translate(-this.getWidth()/2,-this.getHeight()/2).drawImage(this.life>0?this.image:this.imageDead,0,0),this.life>0&&(this.life<H&&t.drawText(10,0,this.life<<0),t.fillStyle(this.color).fillRect(0,10,10,5*this.life/H)),t.restore()}cooldown(t,e){if(!this.cooldowns[t]||this.world.getTime()>this.cooldowns[t])return this.cooldowns[t]=this.world.getTime()+e,!0}setTargetDirection(t){this.targetDirection=t}setTargetVelocity(t){this.targetVelocity=t*this.baseSpeed}updateVelocity(t){this.velocity=this.getTargetVelocity()*t+this.velocity*(1-t)}getTargetVelocity(){return this.targetVelocity}getVelocity(){return this.velocity}update(t){this.life>0?this.updatePlan(t):this.enemy&&this.setEnemy(null),this.updateVelocity(t),this.setX(this.vec[0]+this.force[0]*t),this.setY(this.vec[1]+this.force[1]*t);var e=Math.cos(this.getDirection())*(1-t),s=Math.sin(this.getDirection())*(1-t),a=Math.cos(this.targetDirection)*t,r=Math.sin(this.targetDirection)*t;this.setDirection(Math.atan2(s+r,e+a)),this.life>0&&this.addForce(c.scale([Math.cos(this.direction),Math.sin(this.direction)],this.velocity*(1-Math.random())*t/2)),this.force=c.sub(this.force,c.scale(this.force,t*.1)),c.length(this.force)<c.EPSILON&&(this.force=[0,0]),this.life=this.newLife}distance(t){return c.distance(this.vec,t.vec)}queryEnemy(t){var e=this.world.queryObjects("Soldier",a=>a.isEnemy(this)&&a.life>0&&c.withinDistance(a.vec,this.vec,t)&&this.plan.canClaim(a,this));if(e.length>0){var s;return this.type==="artillery"?s=(a,r)=>r.distance(this)>a.distance(this)?r:a:s=(a,r)=>r.distance(this)<a.distance(this)?r:a,e.reduce(s,e[0])}}seekEnemy(t){if(this.enemy&&(this.enemy.life<=0||this.enemy.distance(this)>t)&&this.setEnemy(null),!this.enemy&&this.cooldown("seek-"+t,Le)&&this.setEnemy(this.queryEnemy(t)),this.enemy){var e=this.enemy.vec,s=c.distance(this.vec,e),a=c.atan2(this.vec,e);this.setTargetDirection(a);var r=0;return this.canCharge&&s>50&&s<ot&&!this.cooldown("charge",10)&&(r+=1),this.setTargetVelocity(this.isMelee||s>this.attackRange?1+r:0),this.rangeAttack&&s<this.attackRange&&s>ke&&this.cooldown("arrow",this.rangedCooldown)&&(this.world.addObject(new $t(this.vec,this.enemy.vec,this.world,this.rangeAttack,this.rangeType)),S.play("arrow"),this.type==="artillery"&&this.hitBy(50)),s<nt&&this.cooldown("sword",Re)&&this.enemy.hit(this),!0}}updatePlan(){this.seekEnemy(this.seekRange)||this.plan.getCommand(this.world.getTime()).execute(this)}addForce(t){this.force=c.add(this.force,t)}getDefence(t,e){var s=Math.abs(c.angle(c.sub(t.vec,this.vec),[Math.cos(this.direction),Math.sin(this.direction)]))/Math.PI;return Math.min(s/e,.3)}getAttack(t){return(1-this.getDefence(t,this.meleeDefence))*this.meleeAttack}hit(t){var e=(this.cooldown("defence",this.defenceCooldown)?this.getDefence(t,this.meleeDefence):1)*t.getAttack(this);this.hitBy(e),E(ut,{soldier:this,damage:e}),this.setEnemy(t),S.play("damage")}hitByArrow(t,e){var s;t.type==="ball"?s=t.getAttack(t)/Math.pow(e,1/4):s=t.getAttack(t)*(this.cooldown("defence",this.defenceCooldown)?this.getDefence(t,this.rangeDefence):1),this.hitBy(s),E(dt,{soldier:this,damage:s}),S.play("hitarrow")}hitBy(t){this.newLife=Math.max(this.newLife-t,0)}isEnemy(t){return this.plan.masterPlan!==t.plan.masterPlan}getClass(){return"Soldier"}setEnemy(t){this.enemy&&(this.plan.unclaim(this.enemy,this),this.enemy=null),t&&this.plan.claim(t,this)&&(this.enemy=t)}}class Be{constructor(){this.objects=[],this.objectsByType={Soldier:[],Arrow:[],Explosion:[]},this.collisionHandlers=[],this.edgeRadius=ft*1.5,this.worldTime=0,this.onCollision(Z,Z,this.onSoldierCollision.bind(this)),this.onCollision(Z,$t,this.onArrowCollision.bind(this))}destroy(){}getTime(){return this.worldTime}getEdgeRadius(){return this.edgeRadius}addObject(...t){for(var e of t)this.objects.push(e),this.objectsByType[e.getClass()].push(e)}removeObject(t){this.objects.splice(this.objects.indexOf(t),1)}queryObjects(t,e){return this.objectsByType[t].filter(function(s){return!e||e(s)})}update(t){var e=Math.min(t,Ce);return this.objects.forEach(function(s){this.updateObject(s,e/Ae)},this),t-=e,this.worldTime+=e,this.collisions(),this.edgeRadius=Math.max(ft*1.5*(1-this.getTime()/6e4),400),t}collisions(){var t=this.queryObjects("Arrow",e=>e.isHit());this.queryObjects("Soldier").forEach(function(e){e.life<=0||(this.queryObjects("Soldier").forEach((s,a)=>{a<=this.objectsByType.Soldier.indexOf(e)||s.life<=0||e===s||c.withinDistance(e.vec,s.vec,e.getWidth())&&this.triggerCollisions(e,s)}),t.forEach(s=>{s&&c.withinDistance(e.vec,s.vec,s.type==="arrow"?xe:q)&&this.triggerCollisions(e,s)}),c.withinDistance(e.vec,[0,0],this.getEdgeRadius())||e.addForce(c.scale(c.normalize(e.vec),-1)))},this),t.forEach(e=>{this.objects.splice(this.objects.indexOf(e),1),this.objectsByType.Arrow.splice(this.objectsByType.Arrow.indexOf(e),1),e.type==="ball"&&this.addObject(new Ie(e.vec,this.getTime(),this))})}triggerCollisions(t,e){this.collisionHandlers.forEach(function(s){t instanceof s.left&&e instanceof s.right&&s.handler(t,e),e instanceof s.left&&t instanceof s.right&&s.handler(e,t)})}onCollision(t,e,s){this.collisionHandlers.push({left:t,right:e,handler:s})}onSoldierCollision(t,e){var s=c.distance(t.vec,e.vec);if(s===0){var a=c.scale([Math.random()-Math.random(),Math.random()-Math.random()],1/Number.MAX_SAFE_INTEGER);t.addForce(a),e.addForce(c.scale(a,-1))}else{var r=c.scale(c.normalize(c.sub(t.vec,e.vec)),t.getWidth()-s);t.addForce(c.scale(r,1/t.weight*e.weight)),e.addForce(c.scale(r,-1*t.weight/e.weight))}}onArrowCollision(t,e){var s=c.distance(e.vec,t.vec);if(e.type==="arrow")e.hit(t,s);else if(e.type==="ball"&&t.cooldown("ballhit",150)){e.hit(t,s);var a=c.scale(c.normalize(c.sub(t.vec,e.vec)),t.getWidth()-s);t.addForce(c.scale(a,-.5/t.weight*(1-s/q)))}}updateObject(t,e){t.update(e)}getAlive(){return this.queryObjects("Soldier",t=>t.life>0).reduce((t,e)=>(t[e.color]=(t[e.color]||0)+1,t),{"#ff0000":0,"#00ff00":0})}}class yt{start(t){this.startTime=t}execute(){}isDone(){return this.done}}class mt extends yt{constructor(t){super(),this.duration=t}isDone(t){return this.startTime>=0&&t-this.startTime>this.duration}execute(t){t.setTargetVelocity(0)}}class gt extends yt{constructor(){super()}getTarget(t){return t.plan.formation}execute(t){var e=this.getTarget(t),s=c.distance(t.vec,e),a=c.atan2(t.vec,e);s>50?(t.setTargetVelocity(1),t.setTargetDirection(a)):(t.setTargetVelocity(0),this.done=!0)}}class Kt extends gt{constructor(t){super(),this.angle=t}getTarget(t){return c.add(c.rotate([200,100*Math.sign(Math.cos(this.angle))],this.angle),t.plan.formation)}}class Fe extends Kt{getTarget(t){return c.add(c.rotate([200,-100*Math.sign(Math.cos(this.angle))],this.angle),t.plan.formation)}}class G extends yt{constructor(){super()}execute(t){t.seekEnemy(ft)||(this.done=!0)}}class Ve{constructor(t,e,s){this.masterPlan=t,this.formation=e,this.plan=s,this.currentCommand=null,this.claims=t.claims}getPosition(){return this.formation}getCommand(t){return(!this.currentCommand||this.currentCommand.isDone(t))&&this.plan.length>0&&(this.currentCommand=this.plan.splice(0,1)[0],this.currentCommand.start(t)),this.currentCommand||(this.currentCommand=new mt),this.currentCommand}canClaim(t,e){if(this.claims[t.soldierId]||(this.claims[t.soldierId]=[]),this.claims[t.soldierId].length<5)return!0;var s=e.distance(t),a=this.claims[t.soldierId].filter(r=>r.distance(t)>s);if(a.length===this.claims[t.soldierId].length)return!0}unclaim(t,e){var s=this.claims[t.soldierId].indexOf(e);s>=0&&this.claims[t.soldierId].splice(s,1)}claim(t,e){return this.canClaim(t,e)?(this.claims[t.soldierId].push(e),!0):!1}}class He{constructor(t,e){var s=c.atan2(t,[0,0]);this.type=[],this.formation=[],this.plan=[],this.claims={},e.forEach(r=>{for(var n=r.sizeCol*r.sizeRow,o=[r.col*_,r.row*L],h=0;h<n;h++){var l=[h%r.sizeCol*_,(h/r.sizeCol<<0)*L];switch(this.formation.push(c.add(l,o)),this.type.push(r.type),r.command){case"advance-wait":this.plan.push([new gt,new mt(1e4),new G]);break;case"advance":this.plan.push([new gt,new G]);break;case"wait-advance":this.plan.push([new mt(1e4),new G]);break;case"flank-left":this.plan.push([new Kt(s),new G]);break;case"flank-right":this.plan.push([new Fe(s),new G]);break}}});var a=[this.formation.reduce((r,n)=>Math.max(n[0],r),0)/2,0];this.formation=this.formation.map(r=>c.rotate(c.sub(r,a),s+Math.PI/2))}getSoldierCount(){return this.formation.length}getType(t){return this.type[t]}getSolderPlan(t){return new Ve(this,this.formation[t],this.plan[t])}}class Ge{constructor(t){this.world=t,this.HUD=y("#game-hud"),this.battleTime=y("#battle-time"),this.battleResult=y("#battle-result"),this.balanceLeft=y("#battle-balance-left"),this.balanceRight=y("#battle-balance-right"),this.HUD.style.display="block"}destroy(){this.HUD.style.display="none",this.battleResult.innerHTML=""}getBalance(t){var e=t.getAlive(),s=Object.keys(t.getAlive());return e[s[0]]/(e[s[0]]+e[s[1]])}setNames(t,e){this.balanceLeft.dataset.username=t||"",this.balanceRight.dataset.username=e||""}render(t){var e=60-t.getTime()/1e3<<0,s=1e3-t.getTime()%1e3<<0;this.battleTime.dataset.time=(e<10?"0":"")+e+":"+s;var a=this.getBalance(t);this.balanceLeft.style.width=a*100+"%",this.balanceLeft.dataset.winning=a>2/3,this.balanceRight.style.width=(1-a)*100+"%",this.balanceRight.dataset.winning=a<1/3}renderResults(t){var e=this.getBalance(t),s="</span>";if(e>1/3&&e<2/3)this.battleResult.innerHTML=`<div style="color: white">
                <span class="result">DRAW!${s}
                <span class="continue">Click to continue${s}
            </div>`;else{var a=e>.3333333333333333?"#ff0000":"#00ff00";return this.battleResult.innerHTML=`<div style="color: ${a}">
                <span class="result" style="background: ${a}">${e>2/3?"Victory":"Defeat"}!${s}
                <span class="winner">${e>2/3?this.balanceLeft.dataset.username:this.balanceRight.dataset.username} wins!${s}
                <span class="loser">${e>2/3?this.balanceRight.dataset.username:this.balanceLeft.dataset.username} defeated!${s}
                <span class="continue">Click to continue${s}
            </div>`,a}}showPause(){}}function Yt(i){i=i||tt;var t=p.layers[i];return t||(p.layers[i]=new p(i))}function Ue(i){i=i||tt;var t=p.layers[i];t&&(t.destroy(),delete p.layers[i])}function p(i){this.element=document.createElement("canvas"),this.element.id=i,this.ctx=this.element.getContext("2d"),window.addEventListener("resize",this.resize.bind(this)),this.resize(),document.body.appendChild(this.element)}p.layers={};p.prototype.destroy=function(){document.body.removeChild(this.element)};p.prototype.getWidth=function(){return this.element.width};p.prototype.getHeight=function(){return this.element.height};p.prototype.clear=function(){return this.ctx.clearRect(0,0,this.getWidth(),this.getHeight()),this};p.prototype.drawText=function(i,t,e){return this.ctx.fillStyle="white",this.ctx.font="11px serif",this.ctx.fillText(e,i-this.ctx.measureText(e).width/2,t),this};p.prototype.fillStyle=function(i){return this.ctx.fillStyle=i,this};p.prototype.strokeStyle=function(i){return this.ctx.strokeStyle=i,this};p.prototype.fillRect=function(i,t,e,s){return this.ctx.fillRect(i,t,e,s),this};p.prototype.arc=function(i,t,e){return this.ctx.beginPath(),this.ctx.arc(i,t,e,0,Math.PI*2),this.ctx.stroke(),this};p.prototype.line=function(i,t,e,s){return this.save(),this.ctx.beginPath(),this.ctx.moveTo(i,t),this.ctx.lineTo(e,s),this.ctx.stroke(),this.restore(),this};p.prototype.drawImage=function(i,t,e){return this.ctx.drawImage(i,t,e),this};p.prototype.scale=function(i){return this.ctx.scale(i,i),this};p.prototype.translate=function(i,t){return this.ctx.translate(i,t),this};p.prototype.rotate=function(i){return this.ctx.rotate(i),this};p.prototype.save=function(){return this.ctx.save(),this};p.prototype.restore=function(){return this.ctx.restore(),this};p.prototype.ctx=function(){return this.ctx};p.prototype.resize=function(){this.element.width=window.innerWidth,this.element.height=window.innerHeight,this.ctx=this.element.getContext("2d")};function Et(i){var t=Yt(tt);t.clear(),t.save().translate(t.getWidth()/2,t.getHeight()/2),t.arc(0,0,i.getEdgeRadius()),i.queryObjects("Soldier",e=>e.life===0).forEach(j),i.queryObjects("Soldier",e=>e.life>0).forEach(j),i.queryObjects("Arrow").forEach(j),i.queryObjects("Explosion").forEach(j),t.restore()}function j(i){var t=Yt();t.save().fillStyle("red").translate(i.getX(),i.getY()).rotate(i.getDirection()),i.render(t),t.restore()}function qe(i,t){var e=new Be,s=(r,n,o)=>{for(var h=r*Math.PI-Math.PI/2,l=[Math.cos(h)*300,Math.sin(h)*300],u=new He(l,o),f=0;f<u.getSoldierCount();f++){var d=u.getSolderPlan(f),T=c.add(d.getPosition(),l);e.addObject(new Z(T[0],T[1],h+Math.PI,d,e,n,u.getType(f)))}return u};s(1,"#ff0000",i),s(0,"#00ff00",t);var a=new Ge(e);return a.setNames(i.username,t.username||"Computer"),(function(n){if(Et(e),a.render(e),n==Wt)return new ze(e,a,i,t)}).WeakState(1e3)}function ze(i,t,e,s){var a=0,r={[ut]:{"#ff0000":0,"#00ff00":0},[dt]:{"#ff0000":0,"#00ff00":0}},n=JSON.parse(JSON.stringify(r));return function(h,l){if(h==Bt){for(var u=Math.min(l,1e3);u>0;)u=i.update(u);Et(i)}if(h===Vt&&t.render(i),h===Ht){var f=t.getBalance(i);if(i.getTime()>6e4||f===0||f===1)return new $e(i,t,e,s)}(h===ut||h===dt)&&(a+=l.damage,r[h][l.soldier.color]+=l.damage,n[h][l.soldier.color]++)}}function $e(i,t,e,s){var a=t.renderResults(i);return function(n){if(Et(i),n===C)if(Ue(tt),t.destroy(),a==="#ff0000"&&!s.username){var o=JSON.parse(JSON.stringify(e));return delete o.username,new $(e,o)}else return new $(e,s)}}function $(i,t){var e;try{e=localStorage["battle-string"]}catch{}!i&&e?(i=z(null,e),y("#username").value=i.username):i||(i=St(),y("#username").value=i.username="Bonaparte"+(1e3*Math.random()<<0));var s=document.getElementById("game-designer");s.classList.add("visible");var a=document.getElementById("designer-field");a.style.width=Ut+"px",a.style.height=qt+"px",a.innerHTML="";var r=i.map(l=>D.of(a,l)),n,o;function h(){var l=r.map(u=>u.getDefinition());return l.username=localStorage.username,l}return x(i),x(t||St(),"test-battle-string"),t&&t.username&&(y("#battle-versus").innerHTML=`Opened a link from <a href="https://twitter.com/${t.username+'">'+t.username}</a>, and you will battle their masterplan! <button id="vs-reset">Click to reset</button><br/><br/>
        <button id="button-test-battle">Play the battle</button>`),function(u,f){if(u===ct&&f.target.classList.contains("field-unit")&&(n=f.target.designerUnit),u===J&&n&&(n.stopDrag(),n=null),u===lt&&n&&f.target.designerUnit===n&&n.startDrag(),u===lt&&n&&f.target===a&&(n.setPosition(f.offsetX/_<<0,f.offsetY/L<<0),x(h())),u===ct&&f.target.id==="button-test-battle")return s.classList.remove("visible"),qe(h(),z("test-battle-string"));if(u===J&&o&&a.contains(f.target)&&(o.deselect(),o=null),u===J&&f.target.classList.contains("field-unit")&&(o=f.target.designerUnit,o.select()),u===C&&f.target.classList.contains("formation-button")&&o){var d=f.target.dataset.formation.split("x");o.setFormation(d[0],d[1]),x(h())}if(u===C&&f.target.dataset.unitType&&o&&(o.setType(f.target.dataset.unitType),x(h())),u===C&&f.target.dataset.command&&o&&(o.setCommand(f.target.dataset.command),x(h())),u===C&&f.target.id==="tweet"&&window.open("https://twitter.com/home?status="+encodeURIComponent(`#masterplan_js13k ${y("#sharelink").value}`)),u===C&&f.target.id==="email"&&(location.href=`mailto:${document.querySelector("[type=email").value}?subject=Check my MasterPlan&body=${y("#sharelink").value}`),u===C&&f.target.id==="battle-string-load")return new $(z());u===C&&f.target.id==="vs-reset"&&(location.hash="",location.reload()),u===Gt&&f.target.id==="username"&&(localStorage.username=f.target.value,x(h()))}}function Ke(){var i=y("#game-intro");i.classList.add("visible");var t=["Protect your archers.","Tanks in first line.","Send warriors later.","Don't spread too thin","Kill archers quickly.","Warriors are good for flanking.","Support warriors with archers.","Archers are effective against stationary opponents.","All units are most vulnerable when hit from behind.","Surround enemy tanks."];return y("#hint").innerHTML="<b>Hint:</b> "+t[Math.random()*t.length<<0],(function(s,a){if(s===C&&a.target.tagName==="BUTTON")return i.classList.remove("visible"),new $}).State()}Function.prototype.State=function(){return this};var Q;Function.prototype.WeakState=function(i){var t=this.State();return Q&&clearTimeout(Q),Q=setTimeout(function(){U===t&&(E(Wt),Q=be)},i),t};function Ye(){return(function(t,e){if(t==Ft&&e=="complete"){var s=document.createElement("style");document.head.appendChild(s);var a=s.sheet;if(["warrior","archer","tank","artillery"].forEach((r,n)=>{var o=document.getElementById("asset-soldier-"+r);a.insertRule(`.field-unit[data-unit-type=${r}] {
                    background: url(${o.src});
                }`,n)}),location.hash.indexOf("#vs=")===0)try{return new $(null,z(null,location.hash.substr(4)))}catch{alert("Blue print invalid!")}return Ke()}}).State()}let U=Ye();function E(i,t){var e=U(i,t);e&&e!==U&&(console.log("Transition from "+U.name+" to "+e.name),U=e)}setInterval(()=>E(Vt),100);setInterval(()=>E(Ht),1e3);let Pt=zt();function Xt(){let i=zt();E(Bt,i-Pt),Pt=i,requestAnimationFrame(Xt)}requestAnimationFrame(Xt);_e(E);document.onreadystatechange=function(){E(Ft,document.readyState)};document.addEventListener("visibilitychange",function(){document.hidden?E(he):E(ce)});window.addEventListener("hashchange",function(){E(oe,document.location.hash)});window.addEventListener("resize",function(){E(le)});
