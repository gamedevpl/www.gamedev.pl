import"./index-5-H6Gn2g.js";let m=0;const oe=m++,Pt=m++,Vt=m++,ct=m++,he=m++,ce=m++,Ft=m++,Gt=m++,le=m++;m++;m++;const ue=m++,lt=m++,J=m++,ut=m++,k=m++,de=m++,Ht=m++,fe=m++,ge=m++,me=m++,pe=m++,ve=m++,ye=m++,Ee=m++,we=m++;m++;const dt=m++,ft=m++;function _e(i){window.addEventListener("keydown",function(t){t.keyCode==37&&i(fe),t.keyCode==38&&i(me),t.keyCode==39&&i(ge),t.keyCode==40&&i(pe),t.keyCode==27&&i(ue),i(de,t.keyCode)}),window.addEventListener("keyup",function(t){t.keyCode==37&&i(ve),t.keyCode==38&&i(Ee),t.keyCode==39&&i(ye),t.keyCode==40&&i(we),i(Ht,t)}),window.addEventListener("mousedown",function(t){i(lt,t)}),window.addEventListener("mouseup",function(t){i(J,t)}),window.addEventListener("mousemove",function(t){i(ut,t)}),window.addEventListener("click",function(t){i(k,t)})}const Ce=null,De=10,Ae=100,tt="layer-default",gt=800,G=100,w=32,L=32,Ut=1600,qt=800,be=Ut/w,Te=qt/L,Me=10,rt=w+Me,ot=600,Re=250,Lt=300,Nt=500,xe=w*5,It=1e3,ke=w/3,q=w*4,St=1500,Le=1e3,Ot=()=>z(null,"RgYEBAMEAgIGBAQIBAICBgQEDQQCAgYEBBIEAwIGBAQXBAMCBgQEHAQCAgYEBCEEAgIGBAQmBAICBhABEgoBAgYQARcMAQI=");class A{constructor(t,e,s,a,n,r,o){this.field=t,this.el=document.createElement("div"),this.setFormation(a,n),this.el.className="field-unit",this.el.designerUnit=this,this.field.appendChild(this.el),this.setType(r),this.setPosition(e,s),this.setCommand(o)}getDefinition(){return{sizeCol:this.sizeCol,sizeRow:this.sizeRow,col:this.col,row:this.row,type:this.type,command:this.command}}setFormation(t,e){this.sizeCol=t,this.sizeRow=e,this.el.style.width=this.sizeCol*w+"px",this.el.style.height=this.sizeRow*L+"px"}setType(t){this.type=t,this.el.dataset.unitType=t}setCommand(t){this.command=t,this.el.dataset.command=t}updatePosition(){this.el.style.left=this.col*w+"px",this.el.style.top=this.row*L+"px"}setPosition(t,e){this.col=Math.max(0,Math.min(t,be-this.sizeCol)),this.row=Math.max(0,Math.min(e,Te-this.sizeRow)),this.updatePosition()}startDrag(){this.field.classList.add("drag"),this.el.classList.add("drag")}stopDrag(){this.field.classList.remove("drag"),this.el.classList.remove("drag")}select(){this.el.classList.add("select"),this.field.classList.add("select")}deselect(){this.el.classList.remove("select"),this.field.classList.remove("select")}}A.of=(i,t)=>new A(i,t.col,t.row,t.sizeCol,t.sizeRow,t.type,t.command);A.types={archer:1,warrior:2,tank:3,artillery:4,1:"archer",2:"warrior",3:"tank",4:"artillery"};A.commands={"wait-advance":1,advance:2,"advance-wait":3,"flank-left":4,"flank-right":5,1:"wait-advance",2:"advance",3:"advance-wait",4:"flank-left",5:"flank-right"};function zt(){return new Date().getTime()}function C(i,t){return Ne(i,t)[0]}function Ne(i,t){return(t||document.body).querySelectorAll(i)}function x(i,t){t=t||"battle-string";var e=o=>[o.sizeCol,o.sizeRow,o.col,o.row,A.types[o.type],A.commands[o.command]],s=(i.username||"").split("").map(o=>o.charCodeAt(0)),a=i.map(e).reduce((o,h)=>o.concat([h.length],h),[]);i=new Uint8Array([a.length].concat(a.concat(s)));var n=new TextDecoder("utf8"),r=btoa(n.decode(i));document.getElementById(t).value=r;try{localStorage[t]=r}catch{}C("#sharelink").value="https://www.gamedev.pl/games/masterplan/#vs="+r}function z(i,t){for(var e=new TextEncoder("utf8"),s=e.encode(atob(t||document.getElementById(i||"battle-string").value)),a=[],n=s[0],r=1;r<=n;){var o=s[r],h=s.slice(r+1,r+o+1);a.push({sizeCol:h[0],sizeRow:h[1],col:h[2],row:h[3],type:A.types[h[4]],command:A.commands[h[5]]}),r+=o+1}var l=Array.from(s.slice(n+1));return a.username=(l.map(d=>String.fromCharCode(d)).join("").match(/(\w)+/g)||[]).join(""),a}const c={EPSILON:Math.pow(2,-16),length:function(i){return Math.sqrt(i[0]*i[0]+i[1]*i[1])},distanceSquared:function(i,t){return Math.pow(i[0]-t[0],2)+Math.pow(i[1]-t[1],2)},distance:function(i,t){return Math.sqrt(this.distanceSquared(i,t))},withinDistance:function(i,t,e){var s=i[0]-t[0],a=i[1]-t[1];if(Math.abs(s)>e||Math.abs(a)>e)return!1;var n=Math.pow(s,2)+Math.pow(a,2);return Math.sqrt(n)<e},normalize:function(i){return this.scale(i,1/this.length(i))},angle:function(i,t){return Math.atan2(this.perpDot(i,t),this.dot(i,t))},dot:function(i,t){return i[0]*t[0]+i[1]*t[1]},perpDot:function(i,t){return i[0]*t[1]-i[1]*t[0]},atan2:function(i,t){return Math.atan2(t[1]-i[1],t[0]-i[0])},sub:function(i,t){return[i[0]-t[0],i[1]-t[1]]},add:function(i,t){return[i[0]+t[0],i[1]+t[1]]},scale:function(i,t){return[i[0]*t,i[1]*t]},rotate:function(i,t){var e=this.length(i);return t=Math.atan2(i[1],i[0])+t,[Math.cos(t)*e,Math.sin(t)*e]},reflect:function(){return[0,0]},project:function(){return[0,0]},normal:function(i,t){var e=this.sub(t,i);return e=this.scale(e,1/this.length(e)),[[-e[1],e[0]],[e[1],-e[0]]]},intersectLineLine:function(i,t,e,s){var a=this.sub(t,i),n=this.sub(s,e),r=this.perpDot(n,a);if(r!=0){var o=this.perpDot(this.sub(i,e),n)/r,h=this.perpDot(this.sub(i,e),a)/r;if(!(o<0||h<0||o>1||h>1))return[o,h]}},intersectSphereSphere:function(i,t,e,s,a,n){var r=this.sub(t,i),o=this.sub(s,e),h=a+n,l=this.dot(r,r),d=h*h,g=this.dot(o,o);if(g!=0){var u=2*this.dot(o,r),b=l-d;if(l<=d)return[0,0];var f=u*u-4*g*b;if(!(f<0)){f=Math.sqrt(f);var N=(-u-f)/(2*g),_=(-u+f)/(2*g);return N<_?[N,_]:[_,N]}}},intersectSphereLine:function(i,t,e,s,a){var n=this.sub(a,s),r=e/Math.sqrt(this.dot(n,n)),o=this.scale([-n[1],n[0]],r),h=this.scale([n[1],-n[0]],r);o=this.add(i,o),h=this.add(i,h);var l=[this.intersectLineLine(o,this.add(o,t),s,a),this.intersectLineLine(h,this.add(h,t),s,a)];if(!l[0]||!l[1])return l[0]||l[1];if(!(!l[0]&&!l[1])&&(l[0][0]<l[1][0]?l=l[0]:l=l[1],!(l[0][0]<0||l[1]<0)&&l[0]<=1&&l[1]<=1))return l}};class vt{constructor(t,e,s,a,n){this.vec=[t,e],this.direction=n,this.objectWidth=s,this.objectHeight=a}getTargetVelocity(){}update(){}render(t){t.save().translate(-this.getWidth()/2,-this.getHeight()/2).fillRect(0,0,this.getWidth(),this.getHeight()).restore()}getX(){return this.vec[0]}setX(t){this.vec[0]=t}getY(){return this.vec[1]}setY(t){this.vec[1]=t}getDirection(){return this.direction}setDirection(t){this.direction=t}getWidth(){return this.objectWidth}getHeight(){return this.objectHeight}vec(){return this.vec}getClass(){return"Object"}}const Wt={arrow:[10,1],ball:[10,10]};class $t extends vt{constructor(t,e,s,a,n){super(t[0],t[1],Wt[n][0],Wt[n][1],c.atan2(t,e)),this.world=s,this.from=t,this.to=e,this.maxDist=c.distance(t,e),this.attackBase=a,this.type=n,this.v=c.normalize(c.sub(e,t))}update(t){var e=c.scale(this.v,t*20);this.vec[0]+=e[0],this.vec[1]+=e[1];var s=Math.sin(c.distance(this.from,this.vec)/this.maxDist*Math.PI);this.adir=this.direction-Math.PI/3*(1-s),this.ay=this.vec[1]-s*this.maxDist/10,c.distance(this.from,this.vec)>this.maxDist&&this.world.removeObject(this)}getY(){return this.ay}getDirection(){return this.adir}isHit(){return this.maxDist-c.distance(this.from,this.vec)<10}hit(t,e){t.hitByArrow(this,e)}getAttack(){return this.attackBase}getClass(){return"Arrow"}}class Ie extends vt{constructor(t,e,s){super(t[0],t[1],q*2,q*2,0),this.time=e,this.world=s}render(t){var e=this.world.getTime()-this.time;e<100&&t.save().arc(0,0,q*Math.min(e/100,1)).restore()}getClass(){return"Explosion"}}function Se(){this.setSettings=function(i){for(var t=0;t<24;t++)this[String.fromCharCode(97+t)]=i[t]||0;this.c<.01&&(this.c=.01);var e=this.b+this.c+this.e;if(e<.18){var s=.18/e;this.b*=s,this.c*=s,this.e*=s}}}function Oe(){this._params=new Se;var i,t,e,s,a,n,r,o,h,l,d,g;this.reset=function(){var u=this._params;s=100/(u.f*u.f+.001),a=100/(u.g*u.g+.001),n=1-u.h*u.h*u.h*.01,r=-u.i*u.i*u.i*1e-6,u.a||(d=.5-u.n/2,g=-u.o*5e-5),o=1+u.l*u.l*(u.l>0?-.9:10),h=0,l=u.m==1?0:(1-u.m)*(1-u.m)*2e4+32},this.totalReset=function(){this.reset();var u=this._params;return i=u.b*u.b*1e5,t=u.c*u.c*1e5,e=u.e*u.e*1e5+12,((i+t+e)/3|0)*3},this.synthWave=function(u,b){var f=this._params,N=f.s!=1||f.v,_=f.v*f.v*.1,_t=1+f.w*3e-4,T=f.s*f.s*f.s*.1,jt=1+f.t*1e-4,Qt=f.s!=1,Jt=f.x*f.x,Zt=f.g,Ct=f.q||f.r,te=f.r*f.r*f.r*.2,Dt=f.q*f.q*(f.q<0?-1020:1020),At=f.p?((1-f.p)*(1-f.p)*2e4|0)+32:0,ee=f.d,bt=f.j/2,ie=f.k*f.k*.01,et=f.a,it=i,se=1/i,ae=1/t,ne=1/e,O=5/(1+f.u*f.u*20)*(.01+T);O>.8&&(O=.8),O=1-O;var st=!1,Tt=0,W=0,B=0,at=0,Y=0,Mt,P=0,E,M=0,R,nt=0,D,Rt=0,v,I,xt=0,K=new Array(1024),V=new Array(32);for(let F=K.length;F--;)K[F]=0;for(let F=V.length;F--;)V[F]=Math.random()*2-1;for(var X=0;X<b;X++){if(st)return X;if(At&&++Rt>=At&&(Rt=0,this.reset()),l&&++h>=l&&(l=0,s*=o),n+=r,s*=n,s>a&&(s=a,Zt>0&&(st=!0)),E=s,bt>0&&(xt+=ie,E*=1+Math.sin(xt)*bt),E|=0,E<8&&(E=8),et||(d+=g,d<0?d=0:d>.5&&(d=.5)),++W>it)switch(W=0,++Tt){case 1:it=t;break;case 2:it=e}switch(Tt){case 0:B=W*se;break;case 1:B=1+(1-W*ae)*2*ee;break;case 2:B=1-W*ne;break;case 3:B=0,st=!0}Ct&&(Dt+=te,R=Dt|0,R<0?R=-R:R>1023&&(R=1023)),N&&_t&&(_*=_t,_<1e-5?_=1e-5:_>.1&&(_=.1)),I=0;for(var re=8;re--;){if(M++,M>=E&&(M%=E,et==3))for(var kt=V.length;kt--;)V[kt]=Math.random()*2-1;switch(et){case 0:v=M/E<d?.5:-.5;break;case 1:v=1-M/E*2;break;case 2:D=M/E,D=(D>.5?D-1:D)*6.28318531,v=1.27323954*D+.405284735*D*D*(D<0?1:-1),v=.225*((v<0?-1:1)*v*v-v)+v;break;case 3:v=V[Math.abs(M*32/E|0)]}N&&(Mt=P,T*=jt,T<0?T=0:T>.1&&(T=.1),Qt?(Y+=(v-P)*T,Y*=O):(P=v,Y=0),P+=Y,at+=P-Mt,at*=1-_,v=at),Ct&&(K[nt%1024]=v,v+=K[(nt-R+1024)%1024],nt++),I+=v}I*=.125*B*Jt,u[X]=I>=1?32767:I<=-1?-32768:I*32767|0}return b}}var ht=new Oe;const We=function(i){ht._params.setSettings(i);var t=ht.totalReset(),e=new Uint8Array(((t+1)/2|0)*4+44),s=ht.synthWave(new Uint16Array(e.buffer,44),t)*2,a=new Uint32Array(e.buffer,0,44);a[0]=1179011410,a[1]=s+36,a[2]=1163280727,a[3]=544501094,a[4]=16,a[5]=65537,a[6]=44100,a[7]=88200,a[8]=1048578,a[9]=1635017060,a[10]=s,s+=44;for(var n=0,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o="data:audio/wav;base64,";n<s;n+=3){var h=e[n]<<16|e[n+1]<<8|e[n+2];o+=r[h>>18]+r[h>>12&63]+r[h>>6&63]+r[h&63]}return o};function yt(){this.sounds={}}yt.prototype.add=function(i,t,e){this.sounds[i]=[],e.forEach(function(s,a){this.sounds[i].push({tick:0,count:t,pool:[]});for(var n=0;n<t;n++){var r=new Audio;r.src=We(s),this.sounds[i][a].pool.push(r)}},this)};yt.prototype.play=function(i){var t=this.sounds[i],e=t.length>1?t[Math.floor(Math.random()*t.length)]:t[0];e.pool[e.tick].play(),e.tick<e.count-1?e.tick++:e.tick=0};const S=new yt;S.add("arrow",10,[[0,.13,.12,.21,.28,.7097,.11,.4399,,,,.2845,.6608,,,,,,1,,,,,.32]]);S.add("hitarrow",10,[[2,,.0664,,.1176,.7984,,-.5791,,,,,,,,,,,1,,,.0922,,.47]]);S.add("damage",10,[[3,,.0421,,.1467,.7815,,-.4846,,,,,,.4464,,,,,1,,,.2247,,.47]]);let Be=0;class Z extends vt{constructor(t,e,s,a,n,r,o){s+=(Math.random()-Math.random())/1e3,super(t,e,w,L,s),this.soldierId=Be++,this.plan=a,this.world=n,this.type=o,this.velocity=0,this.targetVelocity=1,this.force=[0,0],this.targetDirection=s,this.image=C("#asset-soldier-"+this.type),this.imageDead=C("#asset-soldier-"+this.type+"-dead"),this.color=r,this.life=G,this.newLife=G,this.defenceCooldown=St,this.weight=1,this.baseSpeed=1,this.type==="warrior"?(this.seekRange=ot,this.attackRange=rt,this.rangeDefence=30,this.meleeDefence=50,this.meleeAttack=45,this.baseSpeed=3,this.canCharge=!0,this.isMelee=!0):this.type==="tank"?(this.seekRange=ot,this.attackRange=rt*1.1,this.rangeDefence=90,this.meleeDefence=90,this.meleeAttack=20,this.life=this.newLife=G*2,this.defenceCooldown=St/5,this.weight=3,this.canCharge=!1,this.isMelee=!0):this.type==="archer"?(this.seekRange=Nt,this.attackRange=Lt,this.rangeAttack=45,this.rangeDefence=25,this.rangedCooldown=It,this.meleeDefence=10,this.meleeAttack=10,this.rangeType="arrow"):this.type==="artillery"&&(this.seekRange=Nt,this.attackRange=Lt*5,this.weight=10,this.baseSpeed=.1,this.rangeAttack=100,this.rangeDefence=1,this.rangedCooldown=It*10,this.meleeDefence=1,this.meleeAttack=1,this.rangeType="ball"),this.cooldowns={}}render(t){t.save().translate(-this.getWidth()/2,-this.getHeight()/2).drawImage(this.life>0?this.image:this.imageDead,0,0),this.life>0&&(this.life<G&&t.drawText(10,0,this.life<<0),t.fillStyle(this.color).fillRect(0,10,10,5*this.life/G)),t.restore()}cooldown(t,e){if(!this.cooldowns[t]||this.world.getTime()>this.cooldowns[t])return this.cooldowns[t]=this.world.getTime()+e,!0}setTargetDirection(t){this.targetDirection=t}setTargetVelocity(t){this.targetVelocity=t*this.baseSpeed}updateVelocity(t){this.velocity=this.getTargetVelocity()*t+this.velocity*(1-t)}getTargetVelocity(){return this.targetVelocity}getVelocity(){return this.velocity}update(t){this.life>0?this.updatePlan(t):this.enemy&&this.setEnemy(null),this.updateVelocity(t),this.setX(this.vec[0]+this.force[0]*t),this.setY(this.vec[1]+this.force[1]*t);var e=Math.cos(this.getDirection())*(1-t),s=Math.sin(this.getDirection())*(1-t),a=Math.cos(this.targetDirection)*t,n=Math.sin(this.targetDirection)*t;this.setDirection(Math.atan2(s+n,e+a)),this.life>0&&this.addForce(c.scale([Math.cos(this.direction),Math.sin(this.direction)],this.velocity*(1-Math.random())*t/2)),this.force=c.sub(this.force,c.scale(this.force,t*.1)),c.length(this.force)<c.EPSILON&&(this.force=[0,0]),this.life=this.newLife}distance(t){return c.distance(this.vec,t.vec)}queryEnemy(t){var e=this.world.queryObjects("Soldier",a=>a.isEnemy(this)&&a.life>0&&c.withinDistance(a.vec,this.vec,t)&&this.plan.canClaim(a,this));if(e.length>0){var s;return this.type==="artillery"?s=(a,n)=>n.distance(this)>a.distance(this)?n:a:s=(a,n)=>n.distance(this)<a.distance(this)?n:a,e.reduce(s,e[0])}}seekEnemy(t){if(this.enemy&&(this.enemy.life<=0||this.enemy.distance(this)>t)&&this.setEnemy(null),!this.enemy&&this.cooldown("seek-"+t,Le)&&this.setEnemy(this.queryEnemy(t)),this.enemy){var e=this.enemy.vec,s=c.distance(this.vec,e),a=c.atan2(this.vec,e);this.setTargetDirection(a);var n=0;return this.canCharge&&s>50&&s<ot&&!this.cooldown("charge",10)&&(n+=1),this.setTargetVelocity(this.isMelee||s>this.attackRange?1+n:0),this.rangeAttack&&s<this.attackRange&&s>xe&&this.cooldown("arrow",this.rangedCooldown)&&(this.world.addObject(new $t(this.vec,this.enemy.vec,this.world,this.rangeAttack,this.rangeType)),S.play("arrow"),this.type==="artillery"&&this.hitBy(50)),s<rt&&this.cooldown("sword",Re)&&this.enemy.hit(this),!0}}updatePlan(){this.seekEnemy(this.seekRange)||this.plan.getCommand(this.world.getTime()).execute(this)}addForce(t){this.force=c.add(this.force,t)}getDefence(t,e){var s=Math.abs(c.angle(c.sub(t.vec,this.vec),[Math.cos(this.direction),Math.sin(this.direction)]))/Math.PI;return Math.min(s/e,.3)}getAttack(t){return(1-this.getDefence(t,this.meleeDefence))*this.meleeAttack}hit(t){var e=(this.cooldown("defence",this.defenceCooldown)?this.getDefence(t,this.meleeDefence):1)*t.getAttack(this);this.hitBy(e),y(dt,{soldier:this,damage:e}),this.setEnemy(t),S.play("damage")}hitByArrow(t,e){var s;t.type==="ball"?s=t.getAttack(t)/Math.pow(e,1/4):s=t.getAttack(t)*(this.cooldown("defence",this.defenceCooldown)?this.getDefence(t,this.rangeDefence):1),this.hitBy(s),y(ft,{soldier:this,damage:s}),S.play("hitarrow")}hitBy(t){this.newLife=Math.max(this.newLife-t,0)}isEnemy(t){return this.plan.masterPlan!==t.plan.masterPlan}getClass(){return"Soldier"}setEnemy(t){this.enemy&&(this.plan.unclaim(this.enemy,this),this.enemy=null),t&&this.plan.claim(t,this)&&(this.enemy=t)}}class Pe{constructor(){this.objects=[],this.objectsByType={Soldier:[],Arrow:[],Explosion:[]},this.collisionHandlers=[],this.edgeRadius=gt*1.5,this.worldTime=0,this.onCollision(Z,Z,this.onSoldierCollision.bind(this)),this.onCollision(Z,$t,this.onArrowCollision.bind(this))}destroy(){}getTime(){return this.worldTime}getEdgeRadius(){return this.edgeRadius}addObject(...t){for(var e of t)this.objects.push(e),this.objectsByType[e.getClass()].push(e)}removeObject(t){this.objects.splice(this.objects.indexOf(t),1)}queryObjects(t,e){return this.objectsByType[t].filter(function(s){return!e||e(s)})}update(t){var e=Math.min(t,De);return this.objects.forEach(function(s){this.updateObject(s,e/Ae)},this),t-=e,this.worldTime+=e,this.collisions(),this.edgeRadius=Math.max(gt*1.5*(1-this.getTime()/6e4),400),t}collisions(){var t=this.queryObjects("Arrow",e=>e.isHit());this.queryObjects("Soldier").forEach(function(e){e.life<=0||(this.queryObjects("Soldier").forEach((s,a)=>{a<=this.objectsByType.Soldier.indexOf(e)||s.life<=0||e===s||c.withinDistance(e.vec,s.vec,e.getWidth())&&this.triggerCollisions(e,s)}),t.forEach(s=>{s&&c.withinDistance(e.vec,s.vec,s.type==="arrow"?ke:q)&&this.triggerCollisions(e,s)}),c.withinDistance(e.vec,[0,0],this.getEdgeRadius())||e.addForce(c.scale(c.normalize(e.vec),-1)))},this),t.forEach(e=>{this.objects.splice(this.objects.indexOf(e),1),this.objectsByType.Arrow.splice(this.objectsByType.Arrow.indexOf(e),1),e.type==="ball"&&this.addObject(new Ie(e.vec,this.getTime(),this))})}triggerCollisions(t,e){this.collisionHandlers.forEach(function(s){t instanceof s.left&&e instanceof s.right&&s.handler(t,e),e instanceof s.left&&t instanceof s.right&&s.handler(e,t)})}onCollision(t,e,s){this.collisionHandlers.push({left:t,right:e,handler:s})}onSoldierCollision(t,e){var s=c.distance(t.vec,e.vec);if(s===0){var a=c.scale([Math.random()-Math.random(),Math.random()-Math.random()],1/Number.MAX_SAFE_INTEGER);t.addForce(a),e.addForce(c.scale(a,-1))}else{var n=c.scale(c.normalize(c.sub(t.vec,e.vec)),t.getWidth()-s);t.addForce(c.scale(n,1/t.weight*e.weight)),e.addForce(c.scale(n,-1*t.weight/e.weight))}}onArrowCollision(t,e){var s=c.distance(e.vec,t.vec);if(e.type==="arrow")e.hit(t,s);else if(e.type==="ball"&&t.cooldown("ballhit",150)){e.hit(t,s);var a=c.scale(c.normalize(c.sub(t.vec,e.vec)),t.getWidth()-s);t.addForce(c.scale(a,-.5/t.weight*(1-s/q)))}}updateObject(t,e){t.update(e)}getAlive(){return this.queryObjects("Soldier",t=>t.life>0).reduce((t,e)=>(t[e.color]=(t[e.color]||0)+1,t),{"#ff0000":0,"#00ff00":0})}}class Et{start(t){this.startTime=t}execute(){}isDone(){return this.done}}class mt extends Et{constructor(t){super(),this.duration=t}isDone(t){return this.startTime>=0&&t-this.startTime>this.duration}execute(t){t.setTargetVelocity(0)}}class pt extends Et{constructor(){super()}getTarget(t){return t.plan.formation}execute(t){var e=this.getTarget(t),s=c.distance(t.vec,e),a=c.atan2(t.vec,e);s>50?(t.setTargetVelocity(1),t.setTargetDirection(a)):(t.setTargetVelocity(0),this.done=!0)}}class Yt extends pt{constructor(t){super(),this.angle=t}getTarget(t){return c.add(c.rotate([200,100*Math.sign(Math.cos(this.angle))],this.angle),t.plan.formation)}}class Ve extends Yt{getTarget(t){return c.add(c.rotate([200,-100*Math.sign(Math.cos(this.angle))],this.angle),t.plan.formation)}}class H extends Et{constructor(){super()}execute(t){t.seekEnemy(gt)||(this.done=!0)}}class Fe{constructor(t,e,s){this.masterPlan=t,this.formation=e,this.plan=s,this.currentCommand=null,this.claims=t.claims}getPosition(){return this.formation}getCommand(t){return(!this.currentCommand||this.currentCommand.isDone(t))&&this.plan.length>0&&(this.currentCommand=this.plan.splice(0,1)[0],this.currentCommand.start(t)),this.currentCommand||(this.currentCommand=new mt),this.currentCommand}canClaim(t,e){if(this.claims[t.soldierId]||(this.claims[t.soldierId]=[]),this.claims[t.soldierId].length<5)return!0;var s=e.distance(t),a=this.claims[t.soldierId].filter(n=>n.distance(t)>s);if(a.length===this.claims[t.soldierId].length)return!0}unclaim(t,e){var s=this.claims[t.soldierId].indexOf(e);s>=0&&this.claims[t.soldierId].splice(s,1)}claim(t,e){return this.canClaim(t,e)?(this.claims[t.soldierId].push(e),!0):!1}}class Ge{constructor(t,e){var s=c.atan2(t,[0,0]);this.type=[],this.formation=[],this.plan=[],this.claims={},e.forEach(n=>{for(var r=n.sizeCol*n.sizeRow,o=[n.col*w,n.row*L],h=0;h<r;h++){var l=[h%n.sizeCol*w,(h/n.sizeCol<<0)*L];switch(this.formation.push(c.add(l,o)),this.type.push(n.type),n.command){case"advance-wait":this.plan.push([new pt,new mt(1e4),new H]);break;case"advance":this.plan.push([new pt,new H]);break;case"wait-advance":this.plan.push([new mt(1e4),new H]);break;case"flank-left":this.plan.push([new Yt(s),new H]);break;case"flank-right":this.plan.push([new Ve(s),new H]);break}}});var a=[this.formation.reduce((n,r)=>Math.max(r[0],n),0)/2,0];this.formation=this.formation.map(n=>c.rotate(c.sub(n,a),s+Math.PI/2))}getSoldierCount(){return this.formation.length}getType(t){return this.type[t]}getSolderPlan(t){return new Fe(this,this.formation[t],this.plan[t])}}class He{constructor(t){this.world=t,this.HUD=C("#game-hud"),this.battleTime=C("#battle-time"),this.battleResult=C("#battle-result"),this.balanceLeft=C("#battle-balance-left"),this.balanceRight=C("#battle-balance-right"),this.HUD.style.display="block"}destroy(){this.HUD.style.display="none",this.battleResult.innerHTML=""}getBalance(t){var e=t.getAlive(),s=Object.keys(t.getAlive());return e[s[0]]/(e[s[0]]+e[s[1]])}setNames(t,e){this.balanceLeft.dataset.username=t||"",this.balanceRight.dataset.username=e||""}render(t){var e=60-t.getTime()/1e3<<0,s=1e3-t.getTime()%1e3<<0;this.battleTime.dataset.time=(e<10?"0":"")+e+":"+s;var a=this.getBalance(t);this.balanceLeft.style.width=a*100+"%",this.balanceLeft.dataset.winning=a>2/3,this.balanceRight.style.width=(1-a)*100+"%",this.balanceRight.dataset.winning=a<1/3}renderResults(t){var e=this.getBalance(t),s="</span>";if(e>1/3&&e<2/3)this.battleResult.innerHTML=`<div style="color: white">
                <span class="result">DRAW!${s}
                <span class="continue">Click to continue${s}
            </div>`;else{var a=e>.3333333333333333?"#ff0000":"#00ff00";return this.battleResult.innerHTML=`<div style="color: ${a}">
                <span class="result" style="background: ${a}">${e>2/3?"Victory":"Defeat"}!${s}
                <span class="winner">${e>2/3?this.balanceLeft.dataset.username:this.balanceRight.dataset.username} wins!${s}
                <span class="loser">${e>2/3?this.balanceRight.dataset.username:this.balanceLeft.dataset.username} defeated!${s}
                <span class="continue">Click to continue${s}
            </div>`,a}}showPause(){}}function Kt(i){i=i||tt;var t=p.layers[i];return t||(p.layers[i]=new p(i))}function Ue(i){i=i||tt;var t=p.layers[i];t&&(t.destroy(),delete p.layers[i])}function p(i){this.element=document.createElement("canvas"),this.element.id=i,this.ctx=this.element.getContext("2d"),window.addEventListener("resize",this.resize.bind(this)),this.resize(),document.body.appendChild(this.element)}p.layers={};p.prototype.destroy=function(){document.body.removeChild(this.element)};p.prototype.getWidth=function(){return this.element.width};p.prototype.getHeight=function(){return this.element.height};p.prototype.clear=function(){return this.ctx.clearRect(0,0,this.getWidth(),this.getHeight()),this};p.prototype.drawText=function(i,t,e){return this.ctx.fillStyle="white",this.ctx.font="11px serif",this.ctx.fillText(e,i-this.ctx.measureText(e).width/2,t),this};p.prototype.fillStyle=function(i){return this.ctx.fillStyle=i,this};p.prototype.strokeStyle=function(i){return this.ctx.strokeStyle=i,this};p.prototype.fillRect=function(i,t,e,s){return this.ctx.fillRect(i,t,e,s),this};p.prototype.arc=function(i,t,e){return this.ctx.beginPath(),this.ctx.arc(i,t,e,0,Math.PI*2),this.ctx.stroke(),this};p.prototype.line=function(i,t,e,s){return this.save(),this.ctx.beginPath(),this.ctx.moveTo(i,t),this.ctx.lineTo(e,s),this.ctx.stroke(),this.restore(),this};p.prototype.drawImage=function(i,t,e){return this.ctx.drawImage(i,t,e),this};p.prototype.scale=function(i){return this.ctx.scale(i,i),this};p.prototype.translate=function(i,t){return this.ctx.translate(i,t),this};p.prototype.rotate=function(i){return this.ctx.rotate(i),this};p.prototype.save=function(){return this.ctx.save(),this};p.prototype.restore=function(){return this.ctx.restore(),this};p.prototype.ctx=function(){return this.ctx};p.prototype.resize=function(){this.element.width=window.innerWidth,this.element.height=window.innerHeight,this.ctx=this.element.getContext("2d")};function wt(i){var t=Kt(tt);t.clear(),t.save().translate(t.getWidth()/2,t.getHeight()/2),t.arc(0,0,i.getEdgeRadius()),i.queryObjects("Soldier",e=>e.life===0).forEach(j),i.queryObjects("Soldier",e=>e.life>0).forEach(j),i.queryObjects("Arrow").forEach(j),i.queryObjects("Explosion").forEach(j),t.restore()}function j(i){var t=Kt();t.save().fillStyle("red").translate(i.getX(),i.getY()).rotate(i.getDirection()),i.render(t),t.restore()}function qe(i,t){var e=new Pe,s=(n,r,o)=>{for(var h=n*Math.PI-Math.PI/2,l=[Math.cos(h)*300,Math.sin(h)*300],d=new Ge(l,o),g=0;g<d.getSoldierCount();g++){var u=d.getSolderPlan(g),b=c.add(u.getPosition(),l);e.addObject(new Z(b[0],b[1],h+Math.PI,u,e,r,d.getType(g)))}return d};s(1,"#ff0000",i),s(0,"#00ff00",t);var a=new He(e);return a.setNames(i.username,t.username||"Computer"),(function(r){if(wt(e),a.render(e),r==Pt)return new ze(e,a,i,t)}).WeakState(1e3)}function ze(i,t,e,s){var a=0,n={[dt]:{"#ff0000":0,"#00ff00":0},[ft]:{"#ff0000":0,"#00ff00":0}},r=JSON.parse(JSON.stringify(n));return function(h,l){if(h==Vt){for(var d=Math.min(l,1e3);d>0;)d=i.update(d);wt(i)}if(h===Ft&&t.render(i),h===Gt){var g=t.getBalance(i);if(i.getTime()>6e4||g===0||g===1)return new $e(i,t,e,s)}(h===dt||h===ft)&&(a+=l.damage,n[h][l.soldier.color]+=l.damage,r[h][l.soldier.color]++)}}function $e(i,t,e,s){var a=t.renderResults(i);return function(r){if(wt(i),r===k)if(Ue(tt),t.destroy(),a==="#ff0000"&&!s.username){var o=JSON.parse(JSON.stringify(e));return delete o.username,new $(e,o)}else return new $(e,s)}}function $(i,t){var e;try{e=localStorage["battle-string"]}catch{}!i&&e?(i=z(null,e),C("#username").value=i.username):i||(i=Ot(),C("#username").value=i.username="Bonaparte"+(1e3*Math.random()<<0));var s=document.getElementById("game-designer");s.classList.add("visible");var a=document.getElementById("designer-field");a.style.width=Ut+"px",a.style.height=qt+"px",a.innerHTML="";var n=i.map(l=>A.of(a,l)),r,o;function h(){var l=n.map(d=>d.getDefinition());return l.username=localStorage.username,l}return x(i),x(t||Ot(),"test-battle-string"),function(d,g){if(d===lt&&g.target.classList.contains("field-unit")&&(r=g.target.designerUnit),d===J&&r&&(r.stopDrag(),r=null),d===ut&&r&&g.target.designerUnit===r&&r.startDrag(),d===ut&&r&&g.target===a&&(r.setPosition(g.offsetX/w<<0,g.offsetY/L<<0),x(h())),d===lt&&g.target.id==="button-test-battle")return s.classList.remove("visible"),qe(h(),z("test-battle-string"));if(d===J&&o&&a.contains(g.target)&&(o.deselect(),o=null),d===J&&g.target.classList.contains("field-unit")&&(o=g.target.designerUnit,o.select()),d===k&&g.target.classList.contains("formation-button")&&o){var u=g.target.dataset.formation.split("x");o.setFormation(u[0],u[1]),x(h())}if(d===k&&g.target.dataset.unitType&&o&&(o.setType(g.target.dataset.unitType),x(h())),d===k&&g.target.dataset.command&&o&&(o.setCommand(g.target.dataset.command),x(h())),d===k&&g.target.id==="battle-string-load")return new $(z());d===k&&g.target.id==="vs-reset"&&(location.hash="",location.reload()),d===Ht&&g.target.id==="username"&&(localStorage.username=g.target.value,x(h()))}}Function.prototype.State=function(){return this};var Q;Function.prototype.WeakState=function(i){var t=this.State();return Q&&clearTimeout(Q),Q=setTimeout(function(){U===t&&(y(Pt),Q=Ce)},i),t};function Ye(){return(function(t,e){if(t==ct&&e=="complete"){var s=document.createElement("style");document.head.appendChild(s);var a=s.sheet;if(["warrior","archer","tank","artillery"].forEach((n,r)=>{var o=document.getElementById("asset-soldier-"+n);a.insertRule(`.field-unit[data-unit-type=${n}] {
                    background: url(${o.src});
                }`,r)}),location.hash.indexOf("#vs=")===0)try{return new $(null,z(null,location.hash.substr(4)))}catch{alert("Blue print invalid!")}return new $}}).State()}let U=Ye();function y(i,t){var e=U(i,t);e&&e!==U&&(console.log("Transition from "+U.name+" to "+e.name),U=e)}setInterval(()=>y(Ft),100);setInterval(()=>y(Gt),1e3);let Bt=zt();function Xt(){let i=zt();y(Vt,i-Bt),Bt=i,requestAnimationFrame(Xt)}requestAnimationFrame(Xt);_e(y);document.readyState==="complete"?y(ct,document.readyState):document.onreadystatechange=function(){y(ct,document.readyState)};document.addEventListener("visibilitychange",function(){document.hidden?y(he):y(ce)});window.addEventListener("hashchange",function(){y(oe,document.location.hash)});window.addEventListener("resize",function(){y(le)});
