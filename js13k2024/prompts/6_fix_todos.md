There is a bunch of TODOs in the code, please go through them, analyze, and implement.