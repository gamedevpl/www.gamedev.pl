var Ie=Object.defineProperty;var De=(e,o,n)=>o in e?Ie(e,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[o]=n;var re=(e,o,n)=>De(e,typeof o!="symbol"?o+"":o,n);import{r as A,j as c}from"./index-Blwq7NWV.js";var d=(e=>(e[e.CapOfInvisibility=0]="CapOfInvisibility",e[e.ConfusedMonsters=1]="ConfusedMonsters",e[e.LandMine=2]="LandMine",e[e.TimeBomb=3]="TimeBomb",e[e.Crusher=4]="Crusher",e[e.Builder=5]="Builder",e[e.Climber=6]="Climber",e[e.Teleport=7]="Teleport",e[e.Tsunami=8]="Tsunami",e[e.Monster=9]="Monster",e[e.Slide=10]="Slide",e[e.Sokoban=11]="Sokoban",e[e.Blaster=12]="Blaster",e))(d||{}),T=(e=>(e[e.Up=0]="Up",e[e.Down=1]="Down",e[e.Left=2]="Left",e[e.Right=3]="Right",e))(T||{});function de(e){switch(e){case 0:return"Now you see me, now you don't!";case 1:return"Monsters are dizzy!";case 2:return"Boom goes the floor!";case 3:return"Tick tock, boom o'clock!";case 4:return"Hulk smash!";case 5:return"Bob the Builder mode: ON";case 6:return"Walk on walls like a pro!";case 7:return"Beam me up, Scotty!";case 8:return"Water, water everywhere!";case 9:return"Tables have turned!";case 10:return"Slip and slide!";case 11:return"Push it real good!";case 12:return"Pew pew pew!";default:return"Mystery power activated!"}}const g=60,m=30;function C(e,o){return{x:(e-o)*g/2,y:(e+o)*m/2}}function pe(e){switch(e){case"obstacle":return 1;case"bonus":case"landMine":case"timeBomb":return 2;case"goal":return 3;case"monster":return 4;case"player":return 5;case"explosion":return 6;default:return 0}}function Ee(e){return e.sort((o,n)=>{const s=o.position.x+o.position.y,t=n.position.x+n.position.y;if(s!==t)return s-t;const i=pe(o.type),r=pe(n.type);return i!==r?i-r:0})}const me=250,q=500,he=250,Se=()=>Math.cos(Date.now()/1e3*Math.PI),Ae=e=>.5+(e/2+1)/2,ie=(e,o,n,s=me)=>{const t=Math.min(Date.now()-n,s)/s;return{x:o.x+(e.x-o.x)*t,y:o.y+(e.y-o.y)*t}},Le=(e,o,n)=>Date.now()-n<q/2?o:e,Be=e=>{const o=Date.now()/1e3;return Math.sin(o*2+e)*3},ye=e=>{const o=Date.now()/50;return{x:Math.sin(o)*e,y:Math.cos(o*1.5)*e}},Oe=(e,o,n,s)=>{const t=[],i=s-n,r=1e3;if(i>r)return t;const a=o/13,l=i/r,u=Math.sqrt(a*(1-l)),h=Math.floor(u*10);for(let p=0;p<h;p++)t.push({position:{x:Math.random()*e,y:Math.random()*e},intensity:10*u,duration:10*u});return t},be=500,Fe=(e,o,n)=>{const s=Math.min((Date.now()-e)/be,1);return n?1-s:o?s:1},Re=()=>ye(2),Ge=e=>{const n=e%1e3/1e3;return Math.sin(n*Math.PI)*20},Ne=e=>Math.max(0,1-e/2e3),Ye=e=>e<q/2?Math.max(0,1-e/2/(q/2)*2):Math.min(1,(e/2/(q/2)-.5)*2),Ve=(e,o,n)=>{const{x:s,y:t}=C(o.x,o.y);e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.ellipse(s,t+m/2,g/2,m/4,0,0,Math.PI*2),e.fill(),e.fillStyle="#FFD700",e.beginPath(),e.moveTo(s,t),e.lineTo(s+g/2,t+m/2),e.lineTo(s,t+m),e.lineTo(s-g/2,t+m/2),e.closePath(),e.fill(),e.fillStyle="#000000",e.font=`${n/2}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText("★",s,t+m/2)},Xe=(e,o,n)=>{o.forEach(s=>{const{position:t,creationTime:i,isRaising:r,isDestroying:a}=s,{x:l,y:u}=C(t.x,t.y),h=Fe(i,r,a)*n*.8;if(h===0)return;const p=h/n*.2,{x:b,y:M}=C(t.x,t.y+1),{x:P,y}=C(t.x+1,t.y+1),{x:w,y:k}=C(t.x+1,t.y+1+p),{x:D,y:j}=C(t.x,t.y+1+p);e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.moveTo(b,M),e.lineTo(P,y),e.lineTo(w,k),e.lineTo(D,j),e.closePath(),e.fill();const E=a?h/(n*.8):1;e.fillStyle=`rgba(142, 36, 170, ${E})`,e.beginPath(),e.moveTo(l,u-h),e.lineTo(l+g/2,u+m/2-h),e.lineTo(l,u+m-h),e.lineTo(l-g/2,u+m/2-h),e.closePath(),e.fill(),e.fillStyle=`rgba(106, 27, 154, ${E})`,e.beginPath(),e.moveTo(l+g/2,u+m/2-h),e.lineTo(l+g/2,u+m/2),e.lineTo(l,u+m),e.lineTo(l,u+m-h),e.closePath(),e.fill(),e.fillStyle=`rgba(74, 20, 140, ${E})`,e.beginPath(),e.moveTo(l-g/2,u+m/2-h),e.lineTo(l-g/2,u+m/2),e.lineTo(l,u+m),e.lineTo(l,u+m-h),e.closePath(),e.fill()})},We=(e,o)=>{const n=C(0,0),s=C(o,0),t=C(0,o),i=C(o,o);e.fillStyle="#c2b280",e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(s.x,s.y),e.lineTo(i.x,i.y),e.lineTo(t.x,t.y),e.closePath(),e.fill(),e.fillStyle="#5d4037",e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(i.x,i.y+oe),e.lineTo(t.x,t.y+oe),e.lineTo(t.x,t.y),e.closePath(),e.fill(),e.fillStyle="#8d6e63",e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(i.x,i.y+oe),e.lineTo(s.x,s.y+oe),e.lineTo(s.x,s.y),e.closePath(),e.fill()},ge=(e,o,n)=>{e.strokeStyle="#4a4a4a",e.lineWidth=1;for(let s=0;s<=o;s++)for(let t=0;t<=o;t++){const{x:i,y:r}=C(t,s);t<o&&(e.beginPath(),e.moveTo(i,r),e.lineTo(i+g/2,r+m/2),e.stroke()),s<o&&(e.beginPath(),e.moveTo(i,r),e.lineTo(i-g/2,r+m/2),e.stroke()),n.tsunamiLevel>0&&$e(e,t,s,n.tsunamiLevel),n.isSliding&&qe(e,t,s)}},$e=(e,o,n,s)=>{const{x:t,y:i}=C(o,n),r=s/13*m*.5;e.fillStyle=`rgba(0, 100, 255, ${s/26})`,e.beginPath(),e.moveTo(t,i-r),e.lineTo(t+g/2,i+m/2-r),e.lineTo(t,i+m-r),e.lineTo(t-g/2,i+m/2-r),e.closePath(),e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=2,e.beginPath(),e.moveTo(t-g/2,i+m/2-r+Math.sin(Date.now()/200+o*.5)*3),e.lineTo(t+g/2,i+m/2-r+Math.sin(Date.now()/200+(o+1)*.5)*3),e.stroke()},qe=(e,o,n)=>{const{x:s,y:t}=C(o,n),i=e.createLinearGradient(s-g/2,t,s+g/2,t+m);i.addColorStop(0,"rgba(200, 200, 255, 0.2)"),i.addColorStop(.5,"rgba(220, 220, 255, 0.3)"),i.addColorStop(1,"rgba(200, 200, 255, 0.2)"),e.fillStyle=i,e.beginPath(),e.moveTo(s,t),e.lineTo(s+g/2,t+m/2),e.lineTo(s,t+m),e.lineTo(s-g/2,t+m/2),e.closePath(),e.fill();for(let r=0;r<3;r++){const a=s+(Math.random()-.5)*g,l=t+(Math.random()-.5)*m,u=Math.random()*2+1;e.fillStyle="rgba(255, 255, 255, 0.7)",e.beginPath(),e.arc(a,l,u,0,Math.PI*2),e.fill()}},ce=(e,o,n,s,t)=>{e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.ellipse(o+s/2,n+t/2+5,s/2,t/4,0,0,Math.PI*2),e.fill()},Ue=e=>{const{isoX:o,isoY:n,cellSize:s,baseHeight:t,widthFactor:i,heightAnimationFactor:r}=e,a=Se(),l=t*s+s*r*a,u=g*i,h=Ae(a),p=g*i*h,b=m*.4*h;return{entityHeight:l,entityWidth:u,shadowWidth:p,shadowHeight:b,animFactor:a,shadowX:o-p/2,shadowY:n+m/2}},He=(e,o,n,s,t,i,r)=>{e.fillStyle=i,e.beginPath(),e.moveTo(o,n-s-r),e.lineTo(o+t/2,n-s+m/4-r),e.lineTo(o,n+m/2-r),e.lineTo(o-t/2,n-s+m/4-r),e.closePath(),e.fill()},_e=(e,o,n,s,t,i,r)=>{e.fillStyle=i,e.beginPath(),e.arc(o,n-s-t/2-r,t,0,Math.PI*2),e.fill()},Ke=(e,o,n,s,t,i,r,a)=>{const l=t*.3;e.fillStyle=i,e.beginPath(),e.arc(o-t/3,n-s-t/2-a,l,0,Math.PI*2),e.arc(o+t/3,n-s-t/2-a,l,0,Math.PI*2),e.fill(),e.fillStyle=r,e.beginPath(),e.arc(o-t/3,n-s-t/2-a,l/2,0,Math.PI*2),e.arc(o+t/3,n-s-t/2-a,l/2,0,Math.PI*2),e.fill()},Qe=(e,o,n,s,t,i)=>{e.strokeStyle="black",e.lineWidth=2,e.beginPath(),e.arc(o,n-s+t/4-i,t/2,.1*Math.PI,.9*Math.PI),e.stroke()},Ze=(e,o,n,s,t,i,r,a,l,u,h,p,b,M)=>{e.strokeStyle=u,e.lineWidth=l;const P=Math.sin(p*1e3)*Math.PI;for(let y=0;y<r;y++){const w=y/r*Math.PI*2,k=o+Math.cos(w)*(t/3),D=n-s/2+Math.sin(w)*(s/4)-M,j=2+Math.sin(p*100+y)*2,E=.1+Math.cos(p*200+y)*.05,z=k+Math.cos(w)*(a/2),Y=D+Math.sin(w)*(a/2)+Math.sin(h*j+P+y)*i*E,H=k+Math.cos(w)*a,_=D+Math.sin(w)*a+Math.sin(h*j+Math.PI+P+y)*i*(E*1.5),x=k+Math.cos(w)*a,ee=D+Math.sin(w)*a+Math.sin(h*j+P+y)*i*(E*2);b&&(e.save(),e.strokeStyle="rgba(0, 0, 0, 0.3)",e.lineWidth=l*1.5,e.beginPath(),e.moveTo(k,D+m/2),e.bezierCurveTo(z,Y+m/2,H,_+m/2,x,ee+m/2),e.stroke(),e.restore()),e.beginPath(),e.moveTo(k,D),e.bezierCurveTo(z,Y,H,_,x,ee),e.stroke()}},ve=e=>{const{ctx:o,isoX:n,isoY:s,cellSize:t,baseHeight:i,widthFactor:r,heightAnimationFactor:a,bodyColor:l,headColor:u,eyeColor:h,pupilColor:p,hasTentacles:b=!1,tentacleColor:M="",tentacleCount:P=0,tentacleLength:y=0,tentacleWidth:w=0,isInvisible:k=!1,seed:D=0,castShadow:j=!0,isConfused:E=!1}=e,z=Ue({isoX:n,isoY:s,cellSize:t,baseHeight:i,widthFactor:r,heightAnimationFactor:a}),{entityHeight:Y,entityWidth:H,shadowWidth:_,shadowHeight:x,animFactor:ee,shadowX:ke,shadowY:je}=z,K=Be(D),ue=E?Re():{x:0,y:0};let X=n,W=s;X+=ue.x,W+=ue.y,j&&(o.fillStyle="rgba(0, 0, 0, 0.3)",o.beginPath(),o.ellipse(ke+_/2,je,_/2,x/2,0,0,Math.PI*2),o.fill()),o.save(),k&&(o.globalAlpha=.5),b&&M&&P>0&&Ze(o,X,W,Y,H,t,P,y,w,M,ee,D,j,K),He(o,X,W,Y,H,l,K);const ae=t*.25;_e(o,X,W,Y,ae,u,K),Ke(o,X,W,Y,ae,h,p,K),Qe(o,X,W,Y,ae,K),o.restore()},Je=(e,o,n,s=!1,t=[],i=!1,r=!1)=>{const{position:a,previousPosition:l,moveTimestamp:u,teleportTimestamp:h,isVanishing:p,isVictorious:b,isClimbing:M}=o,P=h&&Date.now()-h<q,y=P?Le(a,l,h):ie(a,l,u);let{x:w,y:k}=C(y.x,y.y);if(b){const j=Ge(Date.now()-u);k-=j}M&&t.some(E=>E.position.x===Math.round(y.x)&&E.position.y===Math.round(y.y))&&(k-=n*.5);const D={ctx:e,isoX:w,isoY:k,cellSize:n,baseHeight:.8,widthFactor:.6,heightAnimationFactor:.2,bodyColor:ze(M,i),headColor:xe(M,i),eyeColor:i?"red":"white",pupilColor:"black",isInvisible:s};p?e.globalAlpha=Ne(Date.now()-u):P&&(e.globalAlpha=Ye(Date.now()-h)),ve(D),e.globalAlpha=1,b&&eo(e,w,k,n),M&&oo(e,w,k,n),i&&so(e,w,k,n),r&&no(e,w,k,n),P&&to(e,w,k,n,Date.now()-h)},ze=(e,o)=>o?"#800080":e?"#FFA500":"#00FF00",xe=(e,o)=>o?"#9932CC":e?"#FFD700":"#32CD32",eo=(e,o,n,s)=>{e.save(),e.translate(o,n);for(let t=0;t<10;t++){const i=Math.PI*2*t/10,r=s*(.5+Math.sin(Date.now()/200+t)*.2),a=Math.cos(i)*r,l=Math.sin(i)*r;e.beginPath(),e.arc(a,l,s*.1,0,Math.PI*2),e.fillStyle=`hsl(${(Date.now()/20+t*36)%360}, 100%, 50%)`,e.fill()}e.restore()},oo=(e,o,n,s)=>{e.save(),e.translate(o,n-s*.6);const t=s*.3;e.strokeStyle="#FFD700",e.lineWidth=2,e.beginPath(),e.moveTo(-t/2,-t/2),e.lineTo(-t/2,t/2),e.moveTo(t/2,-t/2),e.lineTo(t/2,t/2);for(let r=0;r<3;r++){const a=-t/2+(r+1)*(t/3);e.moveTo(-t/2,a),e.lineTo(t/2,a)}e.stroke(),e.shadowColor="#FFD700",e.shadowBlur=5,e.stroke();const i=Math.sin(Date.now()/200)*s*.05;e.translate(0,i),e.stroke(),e.restore()},so=(e,o,n,s)=>{e.save(),e.translate(o,n);const t=20,i=s*.8;for(let l=0;l<t;l++){const u=Math.PI*2*l/t+Date.now()/1e3,h=i*(.5+Math.sin(Date.now()/500+l)*.2),p=Math.cos(u)*h,b=Math.sin(u)*h;e.beginPath(),e.arc(p,b,s*.05,0,Math.PI*2),e.fillStyle=`rgba(128, 0, 128, ${.5+Math.sin(Date.now()/200+l)*.3})`,e.fill()}const r=s*.1,a=s*.15;e.beginPath(),e.arc(-a,-a,r,0,Math.PI*2),e.arc(a,-a,r,0,Math.PI*2),e.fillStyle="rgba(255, 0, 0, 0.8)",e.fill(),e.shadowColor="red",e.shadowBlur=10+Math.sin(Date.now()/200)*5,e.fill(),e.restore()},no=(e,o,n,s)=>{e.save(),e.translate(o,n);const t=s*.4,i=s*.1;e.fillStyle="#808080",e.beginPath(),e.rect(-i/2,-t,i,t),e.fill(),e.fillStyle="#FFD700",e.beginPath(),e.arc(0,-t,i/2,0,Math.PI*2),e.fill(),e.shadowColor="#FFD700",e.shadowBlur=5,e.fill();const r=(Math.sin(Date.now()/200)+1)*i/4;e.beginPath(),e.arc(0,-t,r,0,Math.PI*2),e.fillStyle="rgba(255, 255, 0, 0.8)",e.fill(),e.restore()},to=(e,o,n,s,t)=>{e.save(),e.translate(o,n);const i=s*1.5,r=t/q;if(r<.5){const a=r*2,l=i*a;e.beginPath(),e.arc(0,0,l,0,Math.PI*2);const u=e.createRadialGradient(0,0,0,0,0,l);u.addColorStop(0,"rgba(0, 255, 255, 0)"),u.addColorStop(.7,"rgba(0, 255, 255, 0.7)"),u.addColorStop(1,"rgba(0, 255, 255, 0)"),e.fillStyle=u,e.fill();for(let h=0;h<20;h++){const p=Math.random()*Math.PI*2,b=Math.random()*l,M=Math.cos(p)*b,P=Math.sin(p)*b,y=s*.05*(1-a);e.beginPath(),e.arc(M,P,y,0,Math.PI*2),e.fillStyle="rgba(0, 255, 255, "+(1-a)+")",e.fill()}}else{const a=(r-.5)*2,l=i*(1-a);e.beginPath(),e.arc(0,0,l,0,Math.PI*2);const u=e.createRadialGradient(0,0,0,0,0,l);u.addColorStop(0,"rgba(0, 255, 255, 0.7)"),u.addColorStop(.7,"rgba(0, 255, 255, 0.3)"),u.addColorStop(1,"rgba(0, 255, 255, 0)"),e.fillStyle=u,e.fill();for(let h=0;h<20;h++){const p=Math.random()*Math.PI*2,b=Math.random()*i,M=Math.cos(p)*b,P=Math.sin(p)*b,y=s*.05*a;e.beginPath(),e.arc(M,P,y,0,Math.PI*2),e.fillStyle="rgba(0, 255, 255, "+a+")",e.fill()}}e.restore()},io=(e,o,n,s)=>{o.forEach(t=>{const i=ie(t.position,t.previousPosition,t.moveTimestamp),{x:r,y:a}=C(i.x,i.y),l={ctx:e,isoX:r,isoY:a,cellSize:n,baseHeight:.4,widthFactor:.6,heightAnimationFactor:.1,bodyColor:s?"#00FF00":"#800080",headColor:s?"#32CD32":"#9932CC",eyeColor:"white",pupilColor:s?"black":"red",hasTentacles:!s,tentacleColor:"#600060",tentacleCount:6,tentacleLength:n*.5,tentacleWidth:4,seed:t.seed,castShadow:!0};ve(l),s&&ao(e,r,a,n)})},ao=(e,o,n,s)=>{e.save(),e.translate(o,n);const t=s*.2;e.fillStyle="#FFD700",e.beginPath(),e.moveTo(-t/2,-s*.3),e.lineTo(0,-s*.5),e.lineTo(t/2,-s*.3),e.closePath(),e.fill();for(let i=0;i<5;i++){const r=Math.random()*Math.PI*2,a=Math.random()*s*.4+s*.2,l=Math.cos(r)*a,u=Math.sin(r)*a;e.fillStyle=`rgba(255, 255, 0, ${.5+Math.random()*.5})`,e.beginPath(),e.arc(l,u,s*.05,0,Math.PI*2),e.fill()}e.restore()},L=m*.4,ro=(e,o,n)=>{o.forEach(s=>{const{x:t,y:i}=C(s.position.x,s.position.y);ce(e,t-g/4,i-m/4,g/2,m),e.fillStyle=co(s.type),e.beginPath(),e.moveTo(t,i-L),e.lineTo(t+g/4,i-L/2),e.lineTo(t,i),e.lineTo(t-g/4,i-L/2),e.closePath(),e.fill(),e.beginPath(),e.arc(t,i-L,g/6,0,Math.PI*2),e.fill(),e.fillStyle="white",e.font=`bold ${n/3}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText(uo(s.type),t,i-L)})},lo=(e,o,n)=>{o.forEach(s=>{const{x:t,y:i}=C(s.x,s.y);ce(e,t-g/2,i,g,m),e.fillStyle="brown",e.beginPath(),e.moveTo(t,i-L/2),e.lineTo(t+g/4,i-L/4),e.lineTo(t,i),e.lineTo(t-g/4,i-L/4),e.closePath(),e.fill(),e.beginPath(),e.arc(t,i-L/2,g/5,0,Math.PI*2),e.fill(),e.fillStyle="white",e.font=`bold ${n/3}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText("M",t,i-L/2)})},ho=(e,o,n)=>{o.forEach(s=>{const{x:t,y:i}=C(s.position.x,s.position.y);ce(e,t-g/2,i,g,m),e.fillStyle="black",e.beginPath(),e.moveTo(t,i-L),e.lineTo(t+g/4,i-L/2),e.lineTo(t,i),e.lineTo(t-g/4,i-L/2),e.closePath(),e.fill(),e.strokeStyle="orange",e.lineWidth=2,e.beginPath(),e.moveTo(t,i-L),e.quadraticCurveTo(t+g/8,i-L*1.5,t+g/4,i-L*1.25),e.stroke(),e.fillStyle="white",e.font=`bold ${n/3}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText(s.timer.toString(),t,i-L/2)})},co=e=>{switch(e){case d.CapOfInvisibility:return"#8A2BE2";case d.ConfusedMonsters:return"#FFA500";case d.LandMine:return"#8B4513";case d.TimeBomb:return"#000000";case d.Crusher:return"#FF69B4";case d.Builder:return"#00FFFF";default:return"#FFFF00"}},uo=e=>{switch(e){case d.CapOfInvisibility:return"I";case d.ConfusedMonsters:return"C";case d.LandMine:return"L";case d.TimeBomb:return"T";case d.Crusher:return"X";case d.Builder:return"B";default:return"?"}},po=(e,o)=>{e.save(),e.globalAlpha=.7;for(const{position:n,startTime:s,duration:t}of o){if(Date.now()-s>t)continue;const i=C(n.x+.5,n.y+.5),r=C(n.x-1,n.y-1),a=C(n.x+1*2,n.y-1),l=C(n.x+1*2,n.y+1*2),u=C(n.x-1,n.y+1*2);e.fillStyle="#FF6600",e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(a.x,a.y),e.lineTo(l.x,l.y),e.lineTo(u.x,u.y),e.closePath(),e.fill();const h=32,p=g;for(let M=0;M<h;M++){const P=Math.PI*2/h*M,y=p*Math.random(),w=i.x+Math.cos(P)*y,k=i.y+Math.sin(P)*y/2;e.fillStyle=M%2===0?"#FF9933":"#FF3300",e.beginPath(),e.arc(w,k-Math.random()*m*Math.pow(M/h,.5),g/16,0,Math.PI*2),e.fill()}const b=e.createRadialGradient(i.x,i.y,0,i.x,i.y,g*2);b.addColorStop(0,"rgba(255, 255, 0, 0.8)"),b.addColorStop(1,"rgba(255, 165, 0, 0)"),e.fillStyle=b,e.beginPath(),e.ellipse(i.x,i.y,g,m,0,0,Math.PI*2),e.fill()}e.restore()},fo=(e,o,n,s)=>{e.save(),e.globalAlpha=n.duration===12?1:.5,e.font="bold 16px Arial";const{x:t,y:i}=C(o.x,o.y),r=e.measureText(de(n.type)).width+20,a=90,l=15,u=10,h=t-r/2,p=i-s-a-l;e.fillStyle="rgba(0, 0, 0, 0.9)",e.beginPath(),e.moveTo(h+u,p),e.lineTo(h+r-u,p),e.quadraticCurveTo(h+r,p,h+r,p+u),e.lineTo(h+r,p+a-u),e.quadraticCurveTo(h+r,p+a,h+r-u,p+a),e.lineTo(h+r/2+l,p+a),e.lineTo(h+r/2,p+a+l),e.lineTo(h+r/2-l,p+a),e.lineTo(h+u,p+a),e.quadraticCurveTo(h,p+a,h,p+a-u),e.lineTo(h,p+u),e.quadraticCurveTo(h,p,h+u,p),e.closePath(),e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=2,e.stroke(),e.fillStyle="white",e.textAlign="center",e.fillText(de(n.type),h+r/2,p+30),e.font="14px Arial",e.fillText(`${n.duration} steps left`,h+r/2,p+55),mo(e,n.type,h+r-30,p+25,20),e.restore()},mo=(e,o,n,s,t)=>{switch(e.save(),e.strokeStyle="#FFD700",e.lineWidth=2,o){case d.Climber:yo(e,n,s,t);break;case d.Tsunami:bo(e,n,s,t);break;case d.Monster:go(e,n,s,t);break;case d.Slide:vo(e,n,s,t);break;case d.Sokoban:wo(e,n,s,t);break;case d.Blaster:To(e,n,s,t);break;default:Mo(e,n,s,t)}e.restore()},yo=(e,o,n,s)=>{e.beginPath(),e.moveTo(o,n),e.lineTo(o,n+s),e.moveTo(o+s,n),e.lineTo(o+s,n+s);for(let t=0;t<3;t++){const i=n+(t+1)*(s/3);e.moveTo(o,i),e.lineTo(o+s,i)}e.stroke()},bo=(e,o,n,s)=>{e.beginPath(),e.moveTo(o,n+s),e.quadraticCurveTo(o+s/4,n,o+s/2,n+s/2),e.quadraticCurveTo(o+s*3/4,n+s,o+s,n),e.stroke(),e.fillStyle="rgba(0, 100, 255, 0.5)",e.fill()},go=(e,o,n,s)=>{e.fillStyle="#800080",e.beginPath(),e.arc(o+s/2,n+s/2,s/3,0,Math.PI*2),e.fill(),e.fillStyle="red",e.beginPath(),e.arc(o+s/3,n+s/3,s/10,0,Math.PI*2),e.arc(o+s*2/3,n+s/3,s/10,0,Math.PI*2),e.fill()},vo=(e,o,n,s)=>{e.beginPath(),e.moveTo(o,n+s),e.quadraticCurveTo(o+s/2,n,o+s,n+s),e.stroke();for(let t=0;t<5;t++)e.fillStyle="rgba(200, 200, 255, 0.8)",e.beginPath(),e.arc(o+Math.random()*s,n+Math.random()*s,s/10,0,Math.PI*2),e.fill()},wo=(e,o,n,s)=>{e.strokeRect(o+s/4,n+s/4,s/2,s/2),e.beginPath(),e.moveTo(o,n+s/2),e.lineTo(o+s,n+s/2),e.lineTo(o+s*3/4,n+s/4),e.moveTo(o+s,n+s/2),e.lineTo(o+s*3/4,n+s*3/4),e.stroke()},To=(e,o,n,s)=>{e.fillStyle="#808080",e.fillRect(o,n+s/3,s*2/3,s/3),e.beginPath(),e.arc(o+s*2/3,n+s/2,s/6,0,Math.PI*2),e.fill(),e.strokeStyle="red",e.setLineDash([s/10,s/20]),e.beginPath(),e.moveTo(o+s*2/3,n+s/2),e.lineTo(o+s,n+s/2),e.stroke(),e.setLineDash([])},Mo=(e,o,n,s)=>{e.beginPath(),e.arc(o+s/2,n+s/2,s/3,0,Math.PI*2),e.stroke(),e.fillText("?",o+s/2,n+s/2+5)},Co=(e,o,n,s,t)=>{const i=Oe(Math.max(o,o),n,s,Date.now());e.strokeStyle="rgba(255, 255, 255, 0.7)",e.lineWidth=2;for(const r of i){const a=C(r.position.x,r.position.y),l={x:a.x+(Math.random()-.5)*t,y:a.y+(Math.random()-.5)*t};e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(l.x,l.y),e.stroke()}},Po=(e,o,n,s)=>{const{tsunamiLevel:t}=o,i=s*.8;e.save(),e.globalAlpha=.6;for(let r=0;r<n;r++)for(let a=0;a<n;a++){const{x:l,y:u}=C(a,r),h=t/13*i;e.fillStyle=`rgba(0, 100, 255, ${t/13})`,e.beginPath(),e.moveTo(l,u),e.lineTo(l+s/2,u+s/4),e.lineTo(l,u+s/2),e.lineTo(l-s/2,u+s/4),e.closePath(),e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=2,e.beginPath(),e.moveTo(l-s/2,u+s/4-h+Math.sin(Date.now()/200+a*.5)*5),e.lineTo(l+s/2,u+s/4-h+Math.sin(Date.now()/200+(a+1)*.5)*5),e.stroke()}e.restore()},ko=(e,o,n)=>{const{x:s,y:t}=C(o.x,o.y),{x:i,y:r}=C(n.x,n.y);e.save(),e.strokeStyle="rgba(0, 255, 255, 0.5)",e.lineWidth=3,e.setLineDash([5,5]),e.beginPath(),e.moveTo(s,t),e.lineTo(i,r),e.stroke(),e.restore()},jo=(e,o,n)=>{const s=ie(o.endPosition,o.startPosition,o.shotTimestamp,he),{x:t,y:i}=C(s.x,s.y);e.save(),e.fillStyle="yellow",e.strokeStyle="orange",e.lineWidth=2;const r=n*.2;e.beginPath(),e.arc(t,i,r,0,Math.PI*2),e.fill(),e.stroke();const a=n*.3;switch(e.beginPath(),o.direction){case T.Up:e.moveTo(t,i-a),e.lineTo(t-a/2,i),e.lineTo(t+a/2,i);break;case T.Down:e.moveTo(t,i+a),e.lineTo(t-a/2,i),e.lineTo(t+a/2,i);break;case T.Left:e.moveTo(t-a,i),e.lineTo(t,i-a/2),e.lineTo(t,i+a/2);break;case T.Right:e.moveTo(t+a,i),e.lineTo(t,i-a/2),e.lineTo(t,i+a/2);break}e.closePath(),e.fill(),e.stroke(),e.restore()},oe=20,we=(e,o,{gridSize:n,cellSize:s})=>{if(e.save(),o.explosions.length>0){const a=Math.min(o.explosions.filter(u=>Date.now()-u.startTime<u.duration).length*2,10),l=ye(a);e.translate(l.x,l.y)}e.translate(e.canvas.width/2,100),e.clearRect(-e.canvas.width/2,-100,e.canvas.width,e.canvas.height),We(e,n),ge(e,n,o),o.tsunamiLevel>0&&Po(e,o,n,s),Co(e,n,o.monsterSpawnSteps,o.player.moveTimestamp,s),o.isSliding&&ko(e,o.player.previousPosition,o.player.position);const t=[...o.obstacles.map(a=>({position:a.position,type:"obstacle",obj:a})),...o.bonuses.map(a=>({position:a.position,type:"bonus",obj:a})),...o.landMines.map(a=>({position:a,type:"landMine"})),...o.timeBombs.map(a=>({position:a.position,type:"timeBomb",obj:a})),...o.monsters.map(a=>({position:a.position,type:"monster",obj:a})),{position:o.player.position,type:"player",obj:o.player},{position:o.goal,type:"goal"},...o.explosions.map(a=>({position:a.position,type:"explosion",obj:a})),...o.blasterShots.map(a=>({position:ie(a.endPosition,a.startPosition,a.shotTimestamp,he),type:"blasterShot",obj:a}))],i=Ee(t);for(const a of i){const{type:l,position:u}=a;switch(l){case"obstacle":Xe(e,[a.obj],s);break;case"bonus":ro(e,[a.obj],s);break;case"landMine":lo(e,[u],s);break;case"timeBomb":ho(e,[a.obj],s);break;case"monster":io(e,[a.obj],s,o.player.isMonster);break;case"player":Je(e,a.obj,s,o.activeBonuses.some(h=>h.type===d.CapOfInvisibility),o.obstacles,o.player.isMonster,o.player.hasBlaster);break;case"goal":Ve(e,u,s);break;case"explosion":po(e,[a.obj]);break;case"blasterShot":jo(e,a.obj,s);break}}const r=o.activeBonuses.find(a=>a.duration===13||[d.Builder,d.CapOfInvisibility,d.Crusher].includes(a.type));r&&fo(e,o.player.position,r,s),e.restore()},se=300,ne=200,$=5,Io=Math.min(se/$,ne/$)/2,Do=()=>({player:{position:{x:2,y:2},previousPosition:{x:2,y:2},moveTimestamp:Date.now(),isInvisible:!1,isVictorious:!1,isVanishing:!1,isClimbing:!1,isMonster:!1,hasBlaster:!1,blasterSteps:void 0},goal:{x:4,y:4},obstacles:[{position:{x:1,y:1},creationTime:Date.now(),isRaising:!1,isDestroying:!1},{position:{x:3,y:3},creationTime:Date.now(),isRaising:!1,isDestroying:!1}],monsters:[{position:{x:0,y:4},previousPosition:{x:0,y:4},moveTimestamp:Date.now(),path:[],seed:Math.random(),isConfused:!1},{position:{x:4,y:0},previousPosition:{x:4,y:0},moveTimestamp:Date.now(),path:[],seed:Math.random(),isConfused:!1}],steps:0,monsterSpawnSteps:0,bonuses:[{type:d.CapOfInvisibility,position:{x:1,y:3}},{type:d.ConfusedMonsters,position:{x:3,y:1}}],activeBonuses:[],explosions:[],timeBombs:[],landMines:[],crusherActive:!1,builderActive:!1,score:0,gameEndingState:"none",tsunamiLevel:0,isSliding:!1,blasterShots:[]}),Eo=()=>{const e=A.useRef(null),o=A.useRef(Do());return A.useEffect(()=>{const n=e.current;if(!n)return;const s=n.getContext("2d");if(!s)return;const t=()=>{s.clearRect(0,0,se,ne),s.save(),s.scale(.8,.8),s.translate(se*.1,ne*.1),ge(s,$,o.current),we(s,o.current,{gridSize:$,cellSize:Io,initialMonsterCount:0,obstacleCount:0,initialBonusCount:0,levelName:"Preview",levelStory:"Preview"}),s.restore(),o.current.monsters.forEach(i=>{const r=i.position.x+(Math.random()-.5)*.1,a=i.position.y+(Math.random()-.5)*.1;i.previousPosition={...i.position},i.position={x:Math.max(0,Math.min($-1,r)),y:Math.max(0,Math.min($-1,a))},i.moveTimestamp=Date.now()}),requestAnimationFrame(t)};t()},[]),c.jsx("canvas",{ref:e,width:se,height:ne})},So=({onStart:e,onInstructions:o})=>(A.useEffect(()=>{const n=s=>{s.key==="ArrowRight"&&e()};return window.addEventListener("keydown",n),()=>{window.removeEventListener("keydown",n)}},[e]),c.jsxs("div",{className:"intro",children:[c.jsx("h1",{className:"game-title",children:"Monster Steps"}),c.jsxs("div",{className:"game-intro-responsive",children:[c.jsx("div",{className:"game-preview-container",children:c.jsx(Eo,{})}),c.jsxs("div",{className:"game-intro-column",children:[c.jsxs("div",{className:"intro-buttons",children:[c.jsx("button",{onClick:e,children:"Start Game"}),c.jsx("button",{onClick:o,children:"Instructions"})]}),c.jsx("p",{className:"intro-tip",children:"Press right arrow to start"})]})]}),c.jsxs("p",{className:"author-name",children:["Created by ",c.jsx("a",{href:"https://x.com/gtanczyk",children:"Grzegorz Tańczyk"})," | ",c.jsx("a",{href:"https://github.com/gamedevpl/www.gamedev.pl/tree/master/js13k2024",children:"Source code (GitHub)"})]})]})),Ao=({onBack:e})=>(A.useEffect(()=>{const o=n=>{n.key==="Escape"&&e()};return window.addEventListener("keydown",o),()=>{window.removeEventListener("keydown",o)}},[e]),c.jsxs("div",{className:"instructions",children:[c.jsx("h1",{children:"How to Play Monster Steps"}),c.jsxs("ul",{children:[c.jsx("li",{children:"Use arrow keys, touch controls, or mouse clicks to move your character"}),c.jsx("li",{children:"Avoid obstacles and monsters"}),c.jsx("li",{children:"Reach the goal (green square) to complete the level"}),c.jsx("li",{children:"New monsters appear every 13 steps"}),c.jsxs("li",{children:["Collect bonuses for special abilities:",c.jsxs("ul",{children:[c.jsx("li",{children:"Cap of Invisibility: Temporary invisibility to monsters"}),c.jsx("li",{children:"Confused Monsters: Monsters move randomly"}),c.jsx("li",{children:"Land Mine: Place a trap for monsters"}),c.jsx("li",{children:"Time Bomb: Delayed explosion"}),c.jsx("li",{children:"Crusher: Destroy nearby obstacles"}),c.jsx("li",{children:"Builder: Create new platforms"}),c.jsx("li",{children:"Climber: Climb on walls and obstacles"}),c.jsx("li",{children:"Teleport: Instantly move to another location on the grid"}),c.jsx("li",{children:"Tsunami: Water floods the grid, slowing movement. Climb to survive!"}),c.jsx("li",{children:"Monster: Transform into a monster and hunt other monsters"}),c.jsx("li",{children:"Slide: Glide across the grid until hitting an obstacle"}),c.jsx("li",{children:"Sokoban: Push obstacles to crush monsters or create paths"}),c.jsx("li",{children:"Blaster: Shoot in the direction you're moving to eliminate monsters"})]})]}),c.jsx("li",{children:"Complete all 13 levels to win"})]}),c.jsx("h2",{children:"New Bonus Details"}),c.jsxs("ul",{children:[c.jsxs("li",{children:["Tsunami:",c.jsxs("ul",{children:[c.jsx("li",{children:"Water gradually floods the grid over 13 steps"}),c.jsx("li",{children:"Movement becomes slower for both you and monsters"}),c.jsx("li",{children:"At the 13th step, everything not on an obstacle is eliminated"}),c.jsx("li",{children:"Use the Climber bonus to survive on obstacles"})]})]}),c.jsxs("li",{children:["Monster:",c.jsxs("ul",{children:[c.jsx("li",{children:"You become a monster for 13 steps"}),c.jsx("li",{children:'Monsters become vulnerable "players" during this time'}),c.jsx("li",{children:"Eliminate all monster-players to win, but be careful not to let them reach the goal!"})]})]}),c.jsxs("li",{children:["Slide:",c.jsxs("ul",{children:[c.jsx("li",{children:"Your movement becomes a slide in the chosen direction"}),c.jsx("li",{children:"You'll keep moving until you hit an obstacle or the edge of the grid"}),c.jsx("li",{children:"Use this to quickly traverse the grid, but plan your moves carefully!"})]})]}),c.jsxs("li",{children:["Sokoban:",c.jsxs("ul",{children:[c.jsx("li",{children:"Gain the ability to push obstacles"}),c.jsx("li",{children:"Use this to create new paths or crush monsters"}),c.jsx("li",{children:"Strategic obstacle placement can help block monster paths"})]})]}),c.jsxs("li",{children:["Blaster:",c.jsxs("ul",{children:[c.jsx("li",{children:"Equip a blaster that shoots in the direction you're moving"}),c.jsx("li",{children:"Eliminate monsters in your path"}),c.jsx("li",{children:"Use carefully to clear your way to the goal"})]})]})]}),c.jsx("h2",{children:"Tips"}),c.jsxs("ul",{children:[c.jsx("li",{children:"Plan your route to avoid getting trapped"}),c.jsx("li",{children:"Use obstacles and new bonuses strategically to outmaneuver monsters"}),c.jsx("li",{children:"Combine bonuses for powerful effects (e.g., Climber during Tsunami)"}),c.jsx("li",{children:"Think ahead when using Slide or Sokoban to avoid putting yourself in danger"}),c.jsx("li",{children:"Keep track of your steps to anticipate new monster spawns"})]}),c.jsx("button",{onClick:e,children:"Back to Menu"}),c.jsx("p",{className:"instructions-tip",children:"Press Escape to return to the main menu"})]})),B=(e,o)=>e.x===o.x&&e.y===o.y,Z=(e,o)=>o.some(n=>B(n,e)),Lo=e=>{switch(e){case"ArrowUp":case"w":return T.Up;case"ArrowDown":case"s":return T.Down;case"ArrowLeft":case"a":return T.Left;case"ArrowRight":case"d":return T.Right;default:return null}},G=(e,o,n=1)=>{switch(o){case T.Up:return{...e,y:e.y-n};case T.Down:return{...e,y:e.y+n};case T.Left:return{...e,x:e.x-n};case T.Right:return{...e,x:e.x+n}}};function fe(e,o){switch(e){case T.Up:return o===-1?T.Left:T.Right;case T.Down:return o===-1?T.Left:T.Right;case T.Left:return o===-1?T.Down:T.Up;case T.Right:return o===-1?T.Up:T.Down}}const J=(e,o,{gridSize:n})=>{const s=e.x>=0&&e.x<n&&e.y>=0&&e.y<n;if(!s)return!1;if(Z(e,o.obstacles.filter(i=>!i.isDestroying).map(({position:i})=>i))&&!o.player.isClimbing&&!o.crusherActive){if(o.activeBonuses.some(i=>i.type===d.Sokoban)){const i=Fo(o.player.position,e),r=G(e,i);if(s&&!Z(r,o.obstacles.map(a=>a.position)))return!0}return!1}return!0},Te=(e,o)=>{const{player:n}=e,s=[T.Up,T.Down,T.Left,T.Right];return e.isSliding?s.map(t=>{let i=n.position;for(;J(G(i,t),e,o);)i=G(i,t);return{position:i,direction:t}}).filter(t=>!B(t.position,n.position)):s.map(t=>({position:G(n.position,t),direction:t})).filter(({position:t})=>J(t,e,o))};function Bo(e,o,n,s){return Te(n,s).find(t=>Oo(e,o,Me(s.gridSize,s.cellSize,t.direction)))}function Oo(e,o,n){let s=!1;for(let t=0,i=n.length-1;t<n.length;i=t++){const r=n[t].x,a=n[t].y,l=n[i].x,u=n[i].y;a>o!=u>o&&e<(l-r)*(o-a)/(u-a)+r&&(s=!s)}return s}function Fo(e,o){return o.x>e.x?T.Right:o.x<e.x?T.Left:o.y>e.y?T.Down:T.Up}const Ro=(e,o,n,s)=>{e.save(),e.translate(e.canvas.width/2,100),o.forEach(({direction:t})=>{const i=Me(n,s,t);e.beginPath(),e.moveTo(i[0].x,i[0].y),e.lineTo(i[1].x,i[1].y),e.lineTo(i[2].x,i[2].y),e.fillStyle="rgba(255, 255, 0, 0.5)",e.fill()}),e.restore()};function Me(e,o,n){const s=e/3,t=G({x:e/2,y:e/2},n,e/1.5),i=G(t,fe(n,-1),s),r=G(t,fe(n,1),s),a=C(t.x,t.y),l=C(i.x,i.y),u=C(r.x,r.y),h=G(t,n,s),p=C(h.x,h.y),b=Math.atan2(p.y-a.y,p.x-a.x),M=Math.cos(b)*o,P=Math.sin(b)*o;return[{x:p.x+M,y:p.y+P},{x:l.x+M,y:l.y+P},{x:u.x+M,y:u.y+P}]}const Go=(e,o,n,s,t,i)=>{const r=[];return e.map(a=>{let l;t?l=Yo(a.position,n,s,e):l=Vo(a.position,o,n,s,e);let u;return i?u=No(a.position,l[1]||a.position,n,s,e):u=l.length>1?l[1]:a.position,V(u,r)?u=a.position:r.push(u),{...a,previousPosition:a.position,position:u,moveTimestamp:Date.now(),path:l}})},No=(e,o,n,s,t)=>{const i=o.x-e.x,r=o.y-e.y,a={x:Math.max(0,Math.min(n-1,e.x-i)),y:Math.max(0,Math.min(n-1,e.y-r))};return!V(a,s.map(({position:l})=>l))&&!V(a,t.map(l=>l.position))?a:e},Yo=(e,o,n,s)=>{const t=[{x:e.x-1,y:e.y},{x:e.x+1,y:e.y},{x:e.x,y:e.y-1},{x:e.x,y:e.y+1}].filter(i=>i.x>=0&&i.x<o&&i.y>=0&&i.y<o&&!V(i,n.map(({position:r})=>r))&&!V(i,s.map(r=>r.position)));if(t.length>0){const i=Math.floor(Math.random()*t.length);return[e,t[i]]}return[e]},Vo=(e,o,n,s,t)=>{const i=[],r=[],a={position:e,g:0,h:0,f:0,parent:null};for(i.push(a);i.length>0;){let l=i[0],u=0;if(i.forEach((p,b)=>{p.f<l.f&&(l=p,u=b)}),i.splice(u,1),r.push(l),U(l.position,o))return Xo(l);const h=Wo(l.position,n);for(const p of h){if(V(p,s.map(({position:w})=>w))||V(p,t.map(w=>w.position))||r.some(w=>U(w.position,p)))continue;const b=l.g+1,M=$o(p,o),P=b+M,y=i.find(w=>U(w.position,p));y?b<y.g&&(y.g=b,y.f=P,y.parent=l):i.push({position:p,g:b,h:M,f:P,parent:l})}}return[e]},Xo=e=>{const o=[];let n=e;for(;n!==null;)o.unshift(n.position),n=n.parent;return o},Wo=(e,o)=>[{x:e.x-1,y:e.y},{x:e.x+1,y:e.y},{x:e.x,y:e.y-1},{x:e.x,y:e.y+1}].filter(s=>s.x>=0&&s.x<o&&s.y>=0&&s.y<o),$o=(e,o)=>Math.abs(e.x-o.x)+Math.abs(e.y-o.y),U=(e,o)=>e.x===o.x&&e.y===o.y,V=(e,o)=>o.some(n=>U(n,e)),qo=(e,o)=>o.some(n=>U(n.position,e)),Uo=(e,o)=>{const n=[];return[e.filter(t=>{const i=o.find(r=>U(r,t.position));return i?(n.push({position:i,startTime:Date.now(),duration:1e3}),Ho(o,i),!1):!0}),n]},Ho=(e,o)=>{e.splice(e.indexOf(o),1)},_o=(e,o)=>Math.abs(e.position.x-o.position.x)<=1&&Math.abs(e.position.y-o.position.y)<=1,le=(e,o)=>o.some(n=>Math.abs(e.x-n.position.x)<=1&&Math.abs(e.y-n.position.y)<=1),Ko=()=>{const e=F(),o=R(7,"The First Step","Avoid the lone monster and reach the goal in 13 steps!");return e.player=O(0,3),e.goal=S(6,3),e.monsters=[v(3,0)],e.obstacles=[f(5,2),f(5,3)],e.bonuses=[I(1,3,d.Blaster)],[e,o,o.levelStory]},Qo=()=>{const e=F(),o=R(8,"Now You See Me","Use the invisibility cap to sneak past the monsters!");return e.player=O(0,4),e.goal=S(7,4),e.monsters=[v(3,2),v(5,4)],e.bonuses=[I(2,4,d.CapOfInvisibility)],e.obstacles=[f(1,3),f(1,5),f(6,3),f(6,5)],[e,o,o.levelStory]},Zo=()=>{const e=F(),o=R(9,"Bridge the Gap","Build your way to victory!");return e.player=O(0,4),e.goal=S(8,4),e.monsters=[v(4,4)],e.bonuses=[I(2,4,d.Builder)],e.obstacles=[f(3,3),f(3,4),f(3,5),f(5,3),f(5,4),f(5,5)],[e,o,o.levelStory]},Jo=()=>{const e=F(),o=R(9,"Crush and Rush","Clear the path with your crushing power!");e.player=O(0,4),e.goal=S(8,4),e.monsters=[v(4,4)],e.bonuses=[I(2,4,d.Crusher)],e.obstacles=[f(8,2),f(7,2),f(7,3),f(7,4),f(7,5),f(8,5)];for(let n=2;n<7;n++)e.obstacles.push(f(n,3)),e.obstacles.push(f(n-1,5));return[e,o,o.levelStory]},zo=()=>{const e=F(),o=R(10,"Tick Tock Boom","Time your bomb perfectly to clear the way!");e.player=O(0,5),e.goal=S(9,5),e.monsters=[v(3,5)],e.bonuses=[I(9,3,d.TimeBomb)],e.obstacles=[f(9,4),f(8,4),f(8,5),f(8,6),f(9,6),f(4,1),f(5,1),f(6,1),f(7,1),f(8,1)];for(let n=2;n<8;n++)e.obstacles.push(f(n,4)),e.obstacles.push(f(n,6)),e.obstacles.push(f(n-2,8));return[e,o,o.levelStory]},xo=()=>{const e=F(),o=R(10,"Minesweeper's Revenge","Plant a surprise for your pursuers!");e.player=O(0,5),e.goal=S(9,5),e.monsters=[v(6,5),v(4,8),v(8,8)],e.bonuses=[I(2,5,d.LandMine)];for(let n=4;n<9;n++)n!==6&&(e.obstacles.push(f(n,4)),e.obstacles.push(f(n,6)));return[e,o,o.levelStory]},es=()=>{const e=F(),o=R(11,"Monsters' Mayhem","Confuse them all and make your escape!");e.player=O(0,5),e.goal=S(10,5),e.monsters=[v(3,4),v(3,6),v(6,4),v(6,6),v(9,5)],e.bonuses=[I(2,5,d.ConfusedMonsters)];for(let n=4;n<8;n++)e.obstacles.push(f(n,3)),e.obstacles.push(f(n,7));return[e,o,o.levelStory]},os=()=>{const e=F(),o=R(12,"Tunnel Vision","Build a path and set a trap!");e.player=O(0,6),e.goal=S(11,6),e.monsters=[v(3,10),v(8,8)],e.bonuses=[I(2,6,d.Builder),I(2,2,d.LandMine)];for(let n=3;n<10;n++)n!==6&&(e.obstacles.push(f(n,5)),e.obstacles.push(f(n,7)));return[e,o,o.levelStory]},ss=()=>{const e=F(),o=R(12,"Ghost Bomber","Vanish, plant, and detonate!");e.player=O(0,6),e.goal=S(11,6),e.monsters=[v(3,6),v(7,6),v(10,6)],e.bonuses=[I(2,6,d.CapOfInvisibility),I(5,6,d.TimeBomb)];for(let n=4;n<11;n++)n!==5&&n!==8&&(e.obstacles.push(f(n,5)),e.obstacles.push(f(n,7)));return[e,o,o.levelStory]},ns=()=>{const e=F(),o=R(13,"Crush, Confuse, Conquer","A symphony of chaos!");e.player=O(0,6),e.goal=S(12,6),e.monsters=[v(4,6),v(8,6),v(11,6)],e.bonuses=[I(2,6,d.Crusher),I(6,6,d.ConfusedMonsters)];for(let n=3;n<12;n++)n!==6&&n!==9&&(e.obstacles.push(f(n,5)),e.obstacles.push(f(n,7)));return[e,o,o.levelStory]},ts=()=>{const e=F(),o=R(14,"The Triple Threat","Build, Bomb, and Vanish!");e.player=O(0,7),e.goal=S(13,7),e.monsters=[v(3,7),v(6,7),v(9,7),v(12,7)],e.bonuses=[I(2,7,d.Builder),I(5,7,d.TimeBomb),I(8,7,d.CapOfInvisibility)];for(let n=4;n<13;n++)n!==5&&n!==8&&n!==11&&(e.obstacles.push(f(n,6)),e.obstacles.push(f(n,8)));return[e,o,o.levelStory]},is=()=>{const e=F(),o=R(15,"The Gauntlet","Use everything you've learned!");e.player=O(0,7),e.goal=S(14,7),e.monsters=[v(3,7),v(6,7),v(9,7),v(12,7),v(7,3),v(7,11)],e.bonuses=[I(2,7,d.LandMine),I(2,8,d.CapOfInvisibility),I(5,7,d.Crusher),I(8,7,d.ConfusedMonsters),I(1,6,d.Builder),I(2,6,d.TimeBomb)];for(let n=4;n<14;n++)n!==5&&n!==8&&n!==11&&(e.obstacles.push(f(n,6)),e.obstacles.push(f(n,8)));for(let n=4;n<11;n++)n!==7&&(e.obstacles.push(f(6,n)),e.obstacles.push(f(8,n)));return[e,o,o.levelStory]},as=()=>{const e=F(),o=R(16,"The Final Countdown","Can you outsmart them all?");e.player=O(0,8),e.goal=S(15,8),e.monsters=[v(5,8),v(6,8),v(9,8),v(12,8),v(8,3),v(8,13),v(15,3),v(15,13)],e.bonuses=[I(2,8,d.CapOfInvisibility),I(5,8,d.TimeBomb),I(8,8,d.LandMine),I(11,1,d.Crusher),I(14,14,d.ConfusedMonsters)];for(let n=4;n<15;n++)n!==5&&n!==8&&n!==11&&n!==14&&(e.obstacles.push(f(n,7)),e.obstacles.push(f(n,9)));for(let n=4;n<13;n++)n!==8&&(e.obstacles.push(f(7,n)),e.obstacles.push(f(9,n)));return e.obstacles.push(f(14,8)),[e,o,o.levelStory]},S=(e,o)=>({x:e,y:o}),I=(e,o,n)=>({position:S(e,o),type:n}),v=(e,o)=>({position:S(e,o),previousPosition:S(e,o),moveTimestamp:Date.now(),path:[],seed:Math.random(),isConfused:!1}),O=(e,o)=>({position:S(e,o),previousPosition:S(e,o),moveTimestamp:Date.now(),isInvisible:!1,isVictorious:!1,isVanishing:!1,isClimbing:!1,isMonster:!1,hasBlaster:!1,blasterSteps:void 0}),f=(e,o)=>({position:S(e,o),creationTime:Date.now(),isRaising:!1,isDestroying:!1}),F=()=>({player:O(0,0),goal:S(0,0),obstacles:[],monsters:[],steps:0,monsterSpawnSteps:0,bonuses:[],activeBonuses:[],explosions:[],timeBombs:[],landMines:[],crusherActive:!1,builderActive:!1,score:0,gameEndingState:"none",tsunamiLevel:0,isSliding:!1,blasterShots:[]}),rs=40,R=(e,o,n)=>({gridSize:e,cellSize:rs,initialMonsterCount:0,obstacleCount:0,initialBonusCount:0,levelName:o,levelStory:n}),ls={1:Ko,2:Qo,3:Zo,4:Jo,5:zo,6:xo,7:es,8:os,9:ss,10:ns,11:ts,12:is,13:as},hs=e=>{if(e<1||e>13)throw new Error(`Invalid level number: ${e}`);return ls[e]()};class cs{constructor(){re(this,"audioContext");re(this,"masterVolume",.025);this.audioContext=new(window.AudioContext||window.webkitAudioContext)}createOscillator(o,n,s){const t=this.audioContext.createOscillator();return t.type=n,t.frequency.setValueAtTime(o,this.audioContext.currentTime),t.start(),t.stop(this.audioContext.currentTime+s),t}createGain(o,n,s=1){const t=this.audioContext.createGain(),i=s*this.masterVolume;return t.gain.setValueAtTime(0,this.audioContext.currentTime),t.gain.linearRampToValueAtTime(i,this.audioContext.currentTime+o),t.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+o+n),t}playStep(){const o=this.createOscillator(200,"square",.1),n=this.createGain(.01,.09);o.connect(n).connect(this.audioContext.destination)}playElectricalDischarge(){const o=this.createOscillator(800,"sawtooth",.2),n=this.createGain(.01,.19);o.frequency.linearRampToValueAtTime(200,this.audioContext.currentTime+.2),o.connect(n).connect(this.audioContext.destination)}playBonusCollected(){const o=this.createOscillator(600,"sine",.15),n=this.createGain(.01,.14);o.frequency.linearRampToValueAtTime(800,this.audioContext.currentTime+.15),o.connect(n).connect(this.audioContext.destination)}playExplosion(){const o=this.audioContext.createBufferSource(),n=this.audioContext.sampleRate*.5,s=this.audioContext.createBuffer(1,n,this.audioContext.sampleRate),t=s.getChannelData(0);for(let r=0;r<n;r++)t[r]=Math.random()*2-1;o.buffer=s;const i=this.createGain(.01,.49,.5);o.connect(i).connect(this.audioContext.destination),o.start()}playStateTransition(){const o=this.createOscillator(300,"triangle",.3),n=this.createGain(.05,.25);o.frequency.linearRampToValueAtTime(600,this.audioContext.currentTime+.3),o.connect(n).connect(this.audioContext.destination)}playGameOver(){const o=this.createOscillator(440,"sine",1),n=this.createGain(.01,.99);o.frequency.linearRampToValueAtTime(220,this.audioContext.currentTime+1),o.connect(n).connect(this.audioContext.destination)}playLevelComplete(){const o=this.createOscillator(440,"sine",.5),n=this.createOscillator(550,"sine",.5),s=this.createGain(.01,.49),t=this.createGain(.01,.49);o.connect(s).connect(this.audioContext.destination),n.connect(t).connect(this.audioContext.destination),setTimeout(()=>{const i=this.createOscillator(660,"sine",.5),r=this.createGain(.01,.49);i.connect(r).connect(this.audioContext.destination)},250)}playMonsterSpawn(){const o=this.createOscillator(100,"sawtooth",.3),n=this.createGain(.01,.29);o.frequency.exponentialRampToValueAtTime(300,this.audioContext.currentTime+.3),o.connect(n).connect(this.audioContext.destination)}playTeleport(){const o=this.createOscillator(100,"sine",.5),n=this.createOscillator(200,"sine",.5),s=this.createGain(.01,.49),t=this.createGain(.01,.49);o.frequency.exponentialRampToValueAtTime(1e3,this.audioContext.currentTime+.25),n.frequency.exponentialRampToValueAtTime(2e3,this.audioContext.currentTime+.25),o.connect(s).connect(this.audioContext.destination),n.connect(t).connect(this.audioContext.destination),setTimeout(()=>{const i=this.createOscillator(2e3,"sine",.2),r=this.createGain(.01,.19);i.frequency.exponentialRampToValueAtTime(4e3,this.audioContext.currentTime+.2),i.connect(r).connect(this.audioContext.destination)},100)}}const N=new cs,us=(e,o,n)=>{if(Q(o))return o;const s=Lo(e.key);return s!==null?Ce(s,o,n):{...o}},Ce=(e,o,n)=>{if(Q(o))return o;const s={...o},t=s.player.position;let i=G(s.player.position,e);if(s.isSliding&&(i=Pe(s,e,n)),s.activeBonuses.some(r=>r.type===d.Sokoban)&&ws(s,t,i),s.obstacles=o.obstacles.filter(r=>!r.isDestroying||Date.now()-r.creationTime<be),o.crusherActive&&o.obstacles.find(r=>B(i,r.position))&&(s.obstacles=o.obstacles.map(r=>B(i,r.position)?{...r,isDestroying:!0,creationTime:Date.now()}:r),N.playElectricalDischarge()),J(i,s,n)){if(N.playStep(),s.player.position=i,Date.now()-s.player.moveTimestamp>me&&(s.player.previousPosition=t,s.player.moveTimestamp=Date.now()),s.steps++,s.monsterSpawnSteps++,s.tsunamiLevel>0&&gs(s),B(i,s.goal))return s.gameEndingState="levelComplete",ys(s),s.score+=ps(s),s;const r=s.bonuses.find(h=>B(h.position,i));if(r&&(N.playBonusCollected(),s.bonuses=s.bonuses.filter(h=>!B(h.position,i)),ds(s,r.type)),(r==null?void 0:r.type)===d.Teleport&&bs(s,r.position),s.monsterSpawnSteps>=13&&(fs(s,n),s.monsterSpawnSteps=0,N.playMonsterSpawn()),s.monsters=Go(s.monsters,s.player.position,n.gridSize,s.obstacles,s.activeBonuses.some(h=>h.type===d.CapOfInvisibility),s.activeBonuses.some(h=>h.type===d.ConfusedMonsters)),s.player.isMonster)vs(s);else if(qo(s.player.position,s.monsters))return s.gameEndingState="gameOver",te(s),s;s.player.hasBlaster&&Ts(s,e,n),s.blasterShots=s.blasterShots.filter(h=>Date.now()-h.shotTimestamp<he);const[a,l]=Uo(s.monsters,s.landMines);s.monsters=a,s.explosions=l,s.timeBombs=s.timeBombs.map(h=>({...h,timer:h.timer-1}));const u=s.timeBombs.filter(h=>h.timer===0);if((u.length>0||l.length>0)&&N.playExplosion(),s.explosions=[...s.explosions,...u.map(h=>({position:h.position,startTime:Date.now(),duration:1e3}))],s.timeBombs=s.timeBombs.filter(h=>h.timer>0),s.monsters=s.monsters.filter(h=>!s.explosions.some(p=>_o(h,p))),s.obstacles=s.obstacles.map(h=>le(h.position,s.explosions)?{...h,isDestroying:!0,creationTime:Date.now()}:h),s.bonuses=s.bonuses.filter(h=>!le(h.position,s.explosions)),le(s.player.position,s.explosions))return s.gameEndingState="gameOver",te(s),s;if(s.activeBonuses=s.activeBonuses.map(h=>({...h,duration:h.duration-1})).filter(h=>h.duration>0),s.builderActive=s.activeBonuses.some(h=>h.type===d.Builder),s.crusherActive=s.activeBonuses.some(h=>h.type===d.Crusher),s.player.isClimbing=s.activeBonuses.some(h=>h.type===d.Climber),s.isSliding=s.activeBonuses.some(h=>h.type===d.Slide),o.builderActive){const h={position:t,creationTime:Date.now(),isRaising:!0,isDestroying:!1};Z(h.position,s.obstacles.map(({position:p})=>p))||(s.obstacles.push(h),N.playElectricalDischarge())}}return s},ds=(e,o)=>{const n={type:o,duration:13};switch(e.activeBonuses.push(n),o){case d.CapOfInvisibility:break;case d.ConfusedMonsters:break;case d.LandMine:e.landMines.push({...e.player.position});break;case d.TimeBomb:e.timeBombs.push({position:e.player.position,timer:13,shakeIntensity:0});break;case d.Crusher:e.crusherActive=!0;break;case d.Builder:e.builderActive=!0;break;case d.Climber:e.player.isClimbing=!0;break;case d.Teleport:break;case d.Tsunami:e.tsunamiLevel=1;break;case d.Monster:e.player.isMonster=!0;break;case d.Slide:e.isSliding=!0;break;case d.Sokoban:break;case d.Blaster:e.player.hasBlaster=!0,e.player.blasterSteps=13;break}},ps=e=>100-e.steps+e.monsters.length*10,fs=(e,{gridSize:o})=>{let n;do n=ms(o,o);while(B(n,e.player.position)||B(n,e.goal)||Z(n,e.obstacles.filter(s=>!s.isDestroying).map(({position:s})=>s))||Z(n,e.monsters.map(s=>s.position)));e.monsters.push({position:n,previousPosition:n,moveTimestamp:Date.now(),path:[],seed:Math.random(),isConfused:!1})},ms=(e,o)=>({x:Math.floor(Math.random()*e),y:Math.floor(Math.random()*o)}),Q=e=>e.gameEndingState!=="none",te=e=>{e.player.isVanishing=!0,N.playGameOver()},ys=e=>{e.player.isVictorious=!0,N.playLevelComplete()},bs=(e,o)=>{const n=e.bonuses.find(s=>s.type===d.Teleport&&!B(s.position,o));n&&(e.player.previousPosition=e.player.position,e.player.position=n.position,e.player.teleportTimestamp=Date.now(),N.playTeleport())},gs=e=>{e.tsunamiLevel++,e.tsunamiLevel>=13&&(e.player.isClimbing||(e.gameEndingState="gameOver",te(e)),e.monsters=[])},vs=e=>{const o=e.monsters.find(n=>B(e.player.position,n.position));o&&(e.monsters=e.monsters.filter(n=>n!==o),e.monsters.length===0&&(e.gameEndingState="gameOver",te(e)))},Pe=(e,o,n)=>{let s=e.player.position;for(;J(G(s,o),e,n);)s=G(s,o);return s},ws=(e,o,n)=>{const s=e.obstacles.find(t=>B(t.position,n));if(s){const t=G(s.position,Ms(o,n));if(J(t,e,{gridSize:e.obstacles.length})){s.position=t;const i=e.monsters.find(r=>B(r.position,t));i&&(e.monsters=e.monsters.filter(r=>r!==i))}else n=o}},Ts=(e,o,n)=>{const s={startPosition:e.player.position,endPosition:Pe(e,o,n),direction:o,shotTimestamp:Date.now()};e.blasterShots.push(s);const t=e.monsters.find(i=>B(i.position,s.endPosition));t&&(e.monsters=e.monsters.filter(i=>i!==t)),e.player.hasBlaster&&e.player.blasterSteps--<=0&&(e.player.hasBlaster=!1)},Ms=(e,o)=>o.x>e.x?T.Right:o.x<e.x?T.Left:o.y>e.y?T.Down:T.Up,Cs=({level:e,score:o,steps:n})=>c.jsxs("div",{className:"hud",children:[c.jsxs("div",{children:["Level: ",e]}),c.jsxs("div",{children:["Score: ",o]}),c.jsxs("div",{children:["Steps: ",n]})]}),Ps=13,ks=2e3,js=({level:e,score:o,onGameOver:n,onLevelComplete:s,onGameComplete:t,updateScore:i,updateSteps:r})=>{const a=A.useRef(null),[[l,u,h],p]=A.useState(()=>hs(e)),[b,M]=A.useState(!0),P=y=>{p([y,u,h]),i(y.score),r(y.steps)};return A.useEffect(()=>{l.gameEndingState!=="none"&&setTimeout(()=>{l.gameEndingState==="levelComplete"&&(e===Ps?t():s()),l.gameEndingState==="gameOver"&&n()},ks)},[l.gameEndingState]),A.useEffect(()=>{if(!l||!u)return;const y=a.current;let w;if(y){const k=(u.gridSize+u.gridSize)*u.cellSize,D=(u.gridSize+u.gridSize)*u.cellSize/2;y.width=k,y.height=D+100;const j=y.getContext("2d");if(j){const E=()=>{we(j,l,u),Q(l)||Ro(j,Te(l,u),u.gridSize,u.cellSize),w=requestAnimationFrame(E)};E()}}return()=>{w!==null&&cancelAnimationFrame(w)}},[l,u,b]),A.useEffect(()=>{if(!l||!u)return;const y=k=>{if(b){M(!1);return}if(!Q(l)){const D=us(k,l,u);P(D)}},w=k=>{if(b){M(!1);return}if(Q(l))return;const D=a.current;if(!D)return;const j=D.getBoundingClientRect(),E=Bo((k.clientX-j.left)*(D.width/j.width)-D.width/2,(k.clientY-j.top)*(D.height/j.height)-100,l,u);E&&P(Ce(E.direction,l,u))};return window.addEventListener("click",w),window.addEventListener("keydown",y),()=>{window.removeEventListener("click",w),window.removeEventListener("keydown",y)}},[l,u,b,n,s,i,r]),b?c.jsxs("div",{className:"level-story",children:[c.jsxs("h2",{children:["Level ",e]}),c.jsx("p",{children:h}),c.jsx("p",{children:"Press any key to start..."})]}):c.jsxs("div",{className:"gameplay",children:[c.jsx(Cs,{level:e,score:o,steps:(l==null?void 0:l.monsterSpawnSteps)||0}),c.jsx("div",{className:"canvas-container",children:c.jsx("canvas",{ref:a})})]})},Is=({score:e,steps:o,onTryAgain:n,onQuit:s})=>c.jsxs("div",{className:"game-over",children:[c.jsx("h1",{children:"Game Over"}),c.jsxs("p",{children:["Your score: ",e]}),c.jsxs("p",{children:["Steps taken: ",o]}),c.jsx("button",{onClick:n,children:"Try Again"}),c.jsx("button",{onClick:s,children:"Quit"})]}),Ds=({level:e,onNextLevel:o,onQuit:n})=>c.jsxs("div",{className:"level-complete",children:[c.jsxs("h1",{children:["Level ",e," Complete!"]}),c.jsx("p",{children:"Congratulations! You've completed the level."}),c.jsx("button",{onClick:o,children:"Next Level"}),c.jsx("button",{onClick:n,children:"Quit"})]});function Ls(){const[e,o]=A.useState(0),[n,s]=A.useState(parseInt(document.location.hash.split("level")[1]??"1")),[t,i]=A.useState(0),[r,a]=A.useState(0),l=A.useCallback(()=>{o(2)},[]),u=()=>{o(1)},h=()=>{s(1),i(0),a(0),o(2)},p=()=>{o(2)},b=()=>{o(0)},M=()=>{o(3)},P=()=>{s(n+1),o(4)},y=A.useCallback(()=>{o(2)},[]),w=()=>{N.playLevelComplete(),o(5)},k=j=>i(j),D=j=>a(j);return A.useEffect(()=>{const j=E=>{E.key==="ArrowRight"?e===0?l():e===4?y():e===3?p():e===5&&h():E.key==="Escape"&&(e===1||e===3||e===5)&&b()};return window.addEventListener("keydown",j),()=>{window.removeEventListener("keydown",j)}},[e,l,y]),c.jsxs("div",{className:"game-container",children:[e===0&&c.jsx(So,{onStart:l,onInstructions:u}),e===1&&c.jsx(Ao,{onBack:b}),e===2&&c.jsx(js,{level:n,score:t,onGameOver:M,onLevelComplete:P,onGameComplete:w,updateScore:k,updateSteps:D}),e===3&&c.jsx(Is,{score:t,steps:r,onTryAgain:p,onQuit:b}),e===4&&c.jsx(Ds,{level:n,onNextLevel:y,onQuit:b}),e===5&&c.jsx(Es,{score:t,steps:r,onPlayAgain:h,onQuit:b})]})}function Es({score:e,steps:o,onPlayAgain:n,onQuit:s}){return c.jsxs("div",{className:"game-complete intro",children:[c.jsx("h1",{className:"game-title",children:"Monster Steps"}),c.jsx("h2",{className:"game-complete-subtitle",children:"Congratulations!"}),c.jsxs("div",{className:"game-complete-stats",children:[c.jsxs("p",{children:["Final Score: ",e]}),c.jsxs("p",{children:["Total Steps: ",o]})]}),c.jsxs("div",{className:"intro-buttons",children:[c.jsx("button",{onClick:n,children:"Play Again"}),c.jsx("button",{onClick:s,children:"Quit"})]}),c.jsx("p",{className:"intro-tip",children:"Press right arrow to play again"})]})}export{Ls as MonsterStepsApp};
